;; QDSP6 machine description.
;; Copyright (C) 1998, 1999, 2000, 2002 Free Software Foundation, Inc.

;; This file is part of GCC.

;; GCC is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 2, or (at your option)
;; any later version.

;; GCC is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GCC; see the file COPYING.  If not, write to
;; the Free Software Foundation, 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;;- See file "rtl.def" for documentation on define_insn, match_*, et. al.




;;-----------;;
;; Constants ;;
;;-----------;;

(define_constants
  [(SP_REGNUM         29) ; stack pointer
   (FP_REGNUM         30) ; frame pointer
   (LINK_REGNUM       31) ; link register
   (P0_REGNUM         32) ; p0
   (P1_REGNUM         33) ; p1
   (P2_REGNUM         34) ; p2
   (P3_REGNUM         35) ; p3
   (SA0_REGNUM        36) ; loop0 start address
   (LC0_REGNUM        37) ; loop0 count
   (SA1_REGNUM        38) ; loop1 start address
   (LC1_REGNUM        39) ; loop1 count
   (M0_REGNUM         40) ; modifier register 0
   (M1_REGNUM         41) ; modifier register 1
   (DUPLEX_PRED_REG         32)   ; Duplex predicate register
   (DUPLEX_REG_LOW_START     0)   ; First range of duplex registers
   (DUPLEX_REG_LOW_END       7)   ; First range of duplex registers
   (DUPLEX_REG_HIGH_START   16)   ; Second range of duplex registers
   (DUPLEX_REG_HIGH_END     23)   ; Second range of duplex registers
   (UNSPEC_SIBCALL         100)   ; call to sibling
   (UNSPEC_VEC_SHL         101)   ; whole-vector shift left
   (UNSPEC_VEC_SHR         102)   ; Whole-vector shift right
   (UNSPEC_REALIGN_LOAD    103)   ; Realignment of loaded vals
   (UNSPEC_REALIGN_SETUP   104)   ; Realignment of loaded vals
   (UNSPEC_REDUC_SMIN      105)   ; Signed min across
   (UNSPEC_REDUC_SMAX      106)   ; Signed max across
   (UNSPEC_REDUC_UMIN      107)   ; Unsigned min across
   (UNSPEC_REDUC_UMAX      108)   ; Unsigned max across
   (UNSPEC_REDUC_SPLUS     109)   ; Sum of elements.  Non-widening, so why S/U
   (UNSPEC_MULDI_1         110)   ; First part of a muldi
   (UNSPEC_MULDI_2         111)   ; second part of a muldi
   (UNSPEC_NOP             112)   ; nop for appeasing Combine
   (UNSPEC_SET_R_p         113)   ; general register = predicate register
   (UNSPEC_NEW_VALUE       114)   ; R.new
   (UNSPEC_MOVSI_CONST32   115)   ; const32 a + b
   (UNSPEC_QDSP6_vcmpb_eq  150)
   (UNSPEC_QDSP6_vcmpb_gtu 151)
   (UNSPEC_QDSP6_any       152)
   (UNSPEC_QDSP6_all       153)
   (UNSPEC_QDSP6_falign    154)
   (UNSPEC_DOLOOP_END      160)]
)




;;------------;;
;; Attributes ;;
;;------------;;

;; The architecture currently being compiled for

(define_attr "arch" "v1,v2,v3,v4" (const (symbol_ref "qdsp6_arch")))


;; Used to determine which slots an insn can use when scheduling insns

(define_attr "type"
             "A,X,Load,Store,Memop,NewValue,LoadStore,AStore,ALoadStore,M,S,J,JR,CR,loop,endloop0,endloop1,EA,EX,ELoad,EStore,EMemop,ENewValue,EM,ES,EJ,EJR,ECR,multiple,J_dotnew"
             (const_string "multiple"))


;; Used to identify an insn that is implemented by a call

(define_attr "emulation_call" "no,yes" (const_string "no"))


(define_attr "length" ""
             (if_then_else (eq_attr "type"
                                    "EA,EX,ELoad,EStore,EMemop,ENewValue,EM,ES,EJ,EJR,ECR")
                           (const_string "8")
                           (const_string "4")))


;; Predicable means that the insn can be conditionally executed based on
;; an automatically added predicate (additional patterns are generated by
;; gen...).

(define_attr "predicable" "no,yes" (const (const_string "no")))

;; Two duplex instructions can be paired to reduce code size
(define_attr "duplex"   "no,yes" (const_string "no"))


;;-----------------------------;;
;; VLIW Scheduling Description ;;
;;-----------------------------;;

;; Defines the resources of the machine and which insns use which resources
;; based on the insn attributes

(define_automaton "qdsp6")

(automata_option "ndfa")

(define_query_cpu_unit "Slot0,Slot1,Slot2,Slot3,
                  Store0,Store1,
                  PCadder,PCadder_dualjumps,
                  endloop0,endloop1,endloop0_dualjumps,endloop1_dualjumps"
                 "qdsp6")


(define_reservation "control" "(endloop0 + endloop1)")
(define_reservation "control_dualjumps" "(endloop0_dualjumps + endloop1_dualjumps)")

(define_reservation "ESlot0" "(Slot0 + (Slot1 | Slot2 | Slot3))")

(define_reservation "ESlot1" "(Slot1 + (Slot0 | Slot2 | Slot3))")

(define_reservation "ESlot2" "(Slot2 + (Slot0 | Slot1 | Slot3))")

(define_reservation "ESlot3" "(Slot3 + (Slot0 | Slot1 | Slot2))")


;;----;;
;; V1 ;;
;;----;;

(define_insn_reservation "v1_A"          1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "A"))
 "Slot0 | Slot1 | Slot2 | Slot3")

(define_insn_reservation "v1_X"          1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "X"))
                 "Slot2 | Slot3")

(define_insn_reservation "v1_Load"
                         1 (and (ne (symbol_ref "qdsp6_dual_memory_accesses")
                                    (const_int 0))
                                (and (eq_attr "arch" "v1")
                                     (eq_attr "type" "Load")))
 "Slot0 | Slot1")

(define_insn_reservation "v1_possibly_uncached_Load"
                         1 (and (eq (symbol_ref "qdsp6_dual_memory_accesses")
                                    (const_int 0))
                                (and (eq_attr "arch" "v1")
                                     (eq_attr "type" "Load")))
 "Slot0")

(define_insn_reservation "v1_Store"      1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "Store"))
 "Slot0")

(define_insn_reservation "v1_LoadStore"  1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "LoadStore"))
 "Slot0 + Slot1")

(define_insn_reservation "v1_AStore"     1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "AStore"))
 "Slot0 + (Slot1 | Slot2 | Slot3)")

(define_insn_reservation "v1_ALoadStore" 1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "ALoadStore"))
 "Slot0 + Slot1 + (Slot2 | Slot3)")

(define_insn_reservation "v1_M"          1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "M"))
                 "Slot2")

(define_insn_reservation "v1_S"          1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "S"))
                         "Slot3")

(define_insn_reservation "v1_CR"         1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "CR"))
                         "Slot3")

(define_insn_reservation "v1_loop"       1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "loop"))
                         "Slot3  + PCadder")

(define_insn_reservation "v1_J"          1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "J"))
                "(Slot2 | Slot3) + PCadder + control")

(define_insn_reservation "v1_JR"         1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "JR"))
                 "Slot2                    + control")

(define_insn_reservation "v1_endloop0"   1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "endloop0"))
                                            "endloop0")

(define_insn_reservation "v1_endloop1"   1 (and (eq_attr "arch" "v1")
                                                (eq_attr "type" "endloop1"))
                                            "endloop1")


;;----;;
;; V2 ;;
;;----;;

(define_insn_reservation "v2_A"          1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "A"))
 "Slot0 | Slot1 | Slot2 | Slot3")

(define_insn_reservation "v2_X"          1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "X"))
                 "Slot2 | Slot3")

(define_insn_reservation "v2_Load"
                         1 (and (ne (symbol_ref "qdsp6_dual_memory_accesses")
                                    (const_int 0))
                                (and (eq_attr "arch" "v2")
                                     (eq_attr "type" "Load")))
 "Slot0 | Slot1")

(define_insn_reservation "v2_possibly_uncached_Load"
                         1 (and (eq (symbol_ref "qdsp6_dual_memory_accesses")
                                    (const_int 0))
                                (and (eq_attr "arch" "v2")
                                     (eq_attr "type" "Load")))
 "Slot0")

(define_insn_reservation "v2_Store"      1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "Store"))
 "Slot0")

(define_insn_reservation "v2_LoadStore"  1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "LoadStore"))
 "Slot0 + Slot1")

(define_insn_reservation "v2_AStore"     1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "AStore"))
 "Slot0 + (Slot1 | Slot2 | Slot3)")

(define_insn_reservation "v2_ALoadStore" 1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "ALoadStore"))
 "Slot0 + Slot1 + (Slot2 | Slot3)")

(define_insn_reservation "v2_M"          1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "M"))
                 "Slot2 | Slot3")

(define_insn_reservation "v2_S"          1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "S"))
                 "Slot2 | Slot3")

(define_insn_reservation "v2_CR"         1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "CR"))
                         "Slot3")

(define_insn_reservation "v2_loop"       1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "loop"))
                         "Slot3  + PCadder")

(define_insn_reservation "v2_J"          1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "J"))
                "(Slot2 | Slot3) + PCadder + control")

(define_insn_reservation "v2_JR"         1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "JR"))
                 "Slot2                    + control")

(define_insn_reservation "v2_endloop0"   1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "endloop0"))
                                            "endloop0")

(define_insn_reservation "v2_endloop1"   1 (and (eq_attr "arch" "v2")
                                                (eq_attr "type" "endloop1"))
                                            "endloop1")


;;----;;
;; V3 ;;
;;----;;

(define_insn_reservation "v3_A"          1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "A"))
 "Slot0 | Slot1 | Slot2 | Slot3")

(define_insn_reservation "v3_X"          1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "X"))
                 "Slot2 | Slot3")

(define_insn_reservation "v3_Load"       1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "Load"))
 "Slot0 | Slot1")

(define_insn_reservation "v3_Store"      1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "Store"))
 "Slot0")

(define_insn_reservation "v3_LoadStore"  1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "LoadStore"))
 "Slot0 + Slot1")

(define_insn_reservation "v3_AStore"     1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "AStore"))
 "Slot0 + (Slot1 | Slot2 | Slot3)")

(define_insn_reservation "v3_ALoadStore" 1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "ALoadStore"))
 "Slot0 + Slot1 + (Slot2 | Slot3)")

(define_insn_reservation "v3_M"          1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "M"))
                 "Slot2 | Slot3")

(define_insn_reservation "v3_S"          1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "S"))
                 "Slot2 | Slot3")

(define_insn_reservation "v3_CR"         1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "CR"))
                         "Slot3")

(define_insn_reservation "v3_loop"       1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "loop"))
                         "Slot3  + PCadder + PCadder_dualjumps")

(define_insn_reservation "v3_J"          1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "J"))
                "(Slot2 | Slot3) + (PCadder | PCadder_dualjumps) + (control | control_dualjumps)")

(define_insn_reservation "v3_J_dotnew"   1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "J_dotnew"))
                "(Slot2 | Slot3) + PCadder + control")

(define_insn_reservation "v3_JR"         1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "JR"))
                 "Slot2 + control")

(define_insn_reservation "v3_endloop0"   1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "endloop0"))
                                            "endloop0 + endloop0_dualjumps")

(define_insn_reservation "v3_endloop1"   1 (and (eq_attr "arch" "v3")
                                                (eq_attr "type" "endloop1"))
                                            "endloop1 + endloop1_dualjumps")


;;----;;
;; V4 ;;
;;----;;

(define_insn_reservation "v4_A"          1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "A"))
 "Slot0 | Slot1 | Slot2 | Slot3")

(define_insn_reservation "v4_X"          1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "X"))
                 "Slot2 | Slot3")

(define_insn_reservation "v4_Load"       1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "Load"))
 "Slot0 | Slot1")

(define_insn_reservation "v4_Store"      1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "Store"))
 "(Slot0 | Slot1) + (Store0 | Store1)")

(define_insn_reservation "v4_LoadStore"  1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "LoadStore"))
 "Slot0 + Slot1")

(define_insn_reservation "v4_AStore"     1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "AStore"))
 "((Slot0 + (Slot1 | Slot2 | Slot3)) | (Slot1 + (Slot2 | Slot3))) + (Store0 | Store1)")

(define_insn_reservation "v4_ALoadStore" 1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "ALoadStore"))
 "Slot0 + Slot1 + (Slot2 | Slot3)")

(define_insn_reservation "v4_Memop"      1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "Memop"))
 "Slot0 + Store0 + Store1")

(define_insn_reservation "v4_NewValue"   1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "NewValue"))
 "Slot0 + Store0 + Store1")

(define_insn_reservation "v4_M"          1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "M"))
                 "Slot2 | Slot3")

(define_insn_reservation "v4_S"          1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "S"))
                 "Slot2 | Slot3")

(define_insn_reservation "v4_CR"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "CR"))
                         "Slot3")

(define_insn_reservation "v4_loop"       1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "loop"))
                         "Slot3  +  PCadder")

(define_insn_reservation "v4_J"          1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "J"))
                "(Slot2 | Slot3) + (PCadder | PCadder_dualjumps) + (control | control_dualjumps)")

(define_insn_reservation "v4_JR"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "JR"))
                 "Slot2                                          +  control + control_dualjumps")

(define_insn_reservation "v4_endloop0"   1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "endloop0"))
                                  "endloop0 + endloop0_dualjumps")

(define_insn_reservation "v4_endloop1"   1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "endloop1"))
                                  "endloop1 + endloop1_dualjumps")

(define_insn_reservation "v4_EA"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EA"))
 "ESlot0 | ESlot1 | ESlot2 | ESlot3")

(define_insn_reservation "v4_EX"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EX"))
                   "ESlot2 | ESlot3")

(define_insn_reservation "v4_ELoad"      1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "ELoad"))
 "ESlot0 | ESlot1")

(define_insn_reservation "v4_EStore"     1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EStore"))
 "(ESlot0 | ESlot1) + (Store0 | Store1)")

(define_insn_reservation "v4_EMemop"     1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EMemop"))
 "ESlot0 + Store0 + Store1")

(define_insn_reservation "v4_ENewValue"  1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "ENewValue"))
 "ESlot0 + Store0 + Store1")

(define_insn_reservation "v4_EM"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EM"))
                   "ESlot2 | ESlot3")

(define_insn_reservation "v4_ES"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "ES"))
                   "ESlot2 | ESlot3")

(define_insn_reservation "v4_ECR"        1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "ECR"))
                            "ESlot3")

(define_insn_reservation "v4_EJ"         1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EJ"))
                  "(ESlot2 | ESlot3) + (PCadder | PCadder_dualjumps) + (control | control_dualjumps)")

(define_insn_reservation "v4_EJR"        1 (and (eq_attr "arch" "v4")
                                                (eq_attr "type" "EJR"))
                   "ESlot2                                           +  control + control_dualjumps")


;;-------;;
;; Other ;;
;;-------;;

(define_insn_reservation "multiple" 1 (eq_attr "type" "multiple")
"Slot0 + Slot1 + Slot2 + Slot3 + endloop0 + endloop1")




;;----------------------------;;
;; Insn Predicate Definitions ;;
;;----------------------------;;

(include "predicates.md")



;;-----------------;;
;; Vector Patterns ;;
;;-----------------;;

;;(include "vector.md")



;;---------------;;
;; Insn Patterns ;;
;;---------------;;



;;----------------;;
;; Standard Names ;;
;;----------------;;


;;--------;;
;; mov{m} ;;
;;--------;;

;;-------;;
;; movbi ;;
;;-------;;

(define_expand "movbi"
  [(set (match_operand:BI 0 "nonimmediate_operand" "")
        (match_operand:BI 1 "general_operand" ""))]
  ""
  {
    if(GET_CODE (operands[0]) != REG){
      operands[1] = force_reg(BImode, operands[1]);
    }
  }
)

(define_insn "movbi_real"
  [(set (match_operand:BI 0 "nonimmediate_operand" "=Rp,  Rp,Rp,?*Rg,?Rp,*Rg, ?*Rg,?*Rg,?*Rg,?*Anoext,?*m,?*Rg")
        (match_operand:BI 1 "general_operand"      "Iu0,Iu01,Rp,  Rp,*Rg,*Rg,*Adm3,*Anoext,  *m,     *Rg,*Rg,Iu01"))]
  "!(memory_operand(operands[0], BImode)
     && immediate_operand(operands[1], BImode))"
  {
    switch(which_alternative){
      case 0:
        return "%0 = cmp.gt(r0,r0)";
      case 1:
        return "%0 = cmp.eq(r0,r0)";
      case 2:
        return "%0 = or(%1,%1) //pred=pred(BI)";
      case 3:
        if(TARGET_V2_FEATURES){
          return "%0 = mux(%1,#1,#0) //reg=pred(BI)";
        }
        else {
          return "#";
        }
      case 4:
        return "%0 = tstbit(%1,#0) //pred=reg(BI)";
      case 5:
        return "%0 = %1 //reg=reg(BI)";
      case 6:
        return "%0 = memub(%1) //load(BI)";
      case 7:
        return "%0 = memub(%1) //load(BI)";
      case 8:
        return "%0 = memub(%E1) //load(BI)";
      case 9:
        return "memb(%0) = %1 //store(BI)";
      case 10:
        return "memb(%E0) = %1 //store(BI)";
      case 11:
        return "%0 = #%1";
      default:
        gcc_unreachable();
    }
  }
  [(set_attr "type" "A,A,S,A,S,A,Load,Load,ELoad,Store,EStore,A")
   (set_attr "duplex" "no,no,no,no,no,no,yes,no,no,no,no,no")]
)

(define_insn "movbi_new_value"
  [(set (match_operand:BI 0 "memory_operand"             "=Anoext,m")
        (unspec:BI [(match_operand:BI 1 "gr_register_operand" "Rg,Rg")]
                   UNSPEC_NEW_VALUE))]
  "TARGET_V4_FEATURES"
  "@
   memb(%0) = %1.new //store(BI)
   memb(%E0) = %1.new //store(BI)"
  [(set_attr "type" "NewValue,ENewValue")]
)

(define_split
  [(set (match_operand:BI 0 "gr_register_operand" "")
        (match_operand:BI 1 "pr_register_operand" ""))]
  "!TARGET_V2_FEATURES && reload_completed"
  [(set (match_dup 0) (unspec:BI [(match_dup 1)] UNSPEC_SET_R_p))
   (set (match_dup 2) (ashift:SI (match_dup 2) (const_int 31)))
   (set (match_dup 2) (lshiftrt:SI (match_dup 2) (const_int 31)))]
  {
    operands[2] = gen_rtx_REG (SImode, REGNO (operands[0]));
  }
)

(define_insn "movbi_unspec_set_r_p"
  [(set (match_operand:BI 0 "gr_register_operand"            "=Rg")
        (unspec:BI [(match_operand:BI 1 "pr_register_operand" "Rp")]
                   UNSPEC_SET_R_p))]
  "!TARGET_V2_FEATURES"
  "%0 = %1 //reg=pred(BI)"
  [(set_attr "type" "S")]
)

;;-------;;
;; movqi ;;
;;-------;;

(define_expand "movqi"
  [(set (match_operand:QI 0 "nonimmediate_operand" "")
        (match_operand:QI 1 "general_operand" ""))]
  ""
  {
    rtx reg;
    if(TARGET_SECTION_SORTING_CODE_SUPPORT && TARGET_SECTION_SORTING
       && can_create_pseudo_p()){
      if(MEM_P (operands[0])
         && !GP_or_reg_operand(operands[0], QImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[0], 0));
        operands[0] = change_address(operands[0], QImode, reg);
      }
      else if(MEM_P (operands[1])
              && !GP_or_reg_operand(operands[1], QImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[1], 0));
        operands[1] = change_address(operands[1], QImode, reg);
      }
    }
    if(!(register_operand(operands[0], QImode)
         || (TARGET_V4_FEATURES && MEM_P (operands[0])
             && qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                           reload_in_progress
                                           || reload_completed, "si")
             && immediate_operand(operands[1], QImode)))){
      operands[1] = force_reg(QImode, operands[1]);
    }
  }
)

(define_insn "movqi_real_v4"
  [(set (match_operand:QI 0 "nonimmediate_operand_with_GP" "=Rg,  Rg,     Rg,Rg,Adm4,Asi,Asi,Adm4,Anoext, m, Rg,  Rg,?Rg,?*Rp")
        (match_operand:QI 1 "GP_or_reg_operand"             "Rg,Adm3, Anoext, m, Iu1,Is8,  i,  Rg,    Rg,Rg,Iu6,Is16,*Rp,  Rg"))]
  "TARGET_V4_FEATURES
   && (!memory_operand(operands[0], QImode)
       || gr_register_operand(operands[1], QImode)
       || (qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                      reload_in_progress || reload_completed,
                                      \"si\")
           && immediate_operand(operands[1], QImode)))"
  "@
   %0 = %1
   %0 = memb(%1)
   %0 = memb(%1)
   %0 = memb(%E1)
   memb(%0) = #%1
   memb(%0) = #%1
   memb(%0) = ##%1
   memb(%0) = %1
   memb(%0) = %1
   memb(%E0) = %1
   %0 = #%1
   %0 = #%1
   %0 = %1
   %0 = %1"
  [(set_attr "type" "A,Load,Load,ELoad,Store,Store,EStore,Store,Store,EStore,A,A,S,S")
   (set_attr "duplex" "yes,yes,no,no,yes,no,no,yes,no,no,yes,no,no,no")]
)

(define_insn "movqi_new_value"
  [(set (match_operand:QI 0 "memory_operand"             "=Anoext, m")
        (unspec:QI [(match_operand:QI 1 "gr_register_operand" "Rg,Rg")]
                   UNSPEC_NEW_VALUE))]
  "TARGET_V4_FEATURES"
  "@
   memb(%0) = %1.new
   memb(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

(define_insn "movqi_real"
  [(set (match_operand:QI 0 "nonimmediate_operand_with_GP" "=Rg,Rg, m,  Rg,?Rg,?*Rp")
        (match_operand:QI 1 "GP_or_reg_operand"             "Rg, m,Rg,Is16,*Rp,  Rg"))]
  "!TARGET_V4_FEATURES
   && (!memory_operand(operands[0], QImode)
       || gr_register_operand(operands[1], QImode))"
  "@
   %0 = %1
   %0 = memb(%1)
   memb(%0) = %1
   %0 = #%1
   %0 = %1
   %0 = %1"
  [(set_attr "type" "A,Load,Store,A,S,S")]
)

(define_insn "cond_movqi"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,  Rp,  Rp,   Rp,    Rp,  Rp")
        (const_int 0)])
     (set (match_operand:QI 0 "conditional_dest_operand" "=Rg,   Rg,    Rg,Acsi,Acsi,Acond,Aecond,  Rg")
          (match_operand:QI 1 "conditional_src_operand"   "Rg,Acond,Aecond, Is6,   i,   Rg,    Rg,Is12")))]
  "!memory_operand(operands[0], QImode)
   || gr_register_operand(operands[1], QImode)
   || (TARGET_V4_FEATURES
       && qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                     reload_in_progress || reload_completed,
                                     \"csi\")
       && immediate_operand(operands[1], QImode))"
  "@
   if (%C2) %0 = %1
   if (%C2) %0 = memb(%1)
   if (%C2) %0 = memb(%E1)
   if (%C2) memb(%0) = #%1
   if (%C2) memb(%0) = ##%1
   if (%C2) memb(%0) = %1
   if (%C2) memb(%E0) = %1
   if (%C2) %0 = #%1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Store,EStore,A")]
)

(define_insn "cond_movqi_new_value"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"               "Rp,    Rp")
        (const_int 0)])
     (set (match_operand:QI 0 "memory_operand"              "=Acond,Aecond")
          (unspec:QI [(match_operand:QI 1 "gr_register_operand" "Rg,    Rg")]
                     UNSPEC_NEW_VALUE)))]
  "TARGET_V4_FEATURES"
  "@
   if (%C2) memb(%0) = %1.new
   if (%C2) memb(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

;;-------;;
;; movhi ;;
;;-------;;

(define_expand "movhi"
  [(set (match_operand:HI 0 "nonimmediate_operand" "")
        (match_operand:HI 1 "general_operand" ""))]
  ""
  {
    rtx reg;
    if(TARGET_SECTION_SORTING_CODE_SUPPORT && TARGET_SECTION_SORTING
       && can_create_pseudo_p()){
      if(MEM_P (operands[0])
         && !GP_or_reg_operand(operands[0], HImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[0], 0));
        operands[0] = change_address(operands[0], HImode, reg);
      }
      else if(MEM_P (operands[1])
              && !GP_or_reg_operand(operands[1], HImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[1], 0));
        operands[1] = change_address(operands[1], HImode, reg);
      }
    }
    if(!(register_operand(operands[0], HImode)
         || (TARGET_V4_FEATURES && MEM_P (operands[0])
             && qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                           reload_in_progress
                                           || reload_completed, "si")
             && s8_const_int_operand(operands[1], HImode)))){
      operands[1] = force_reg(HImode, operands[1]);
    }
  }
)

(define_insn "movhi_real_v4"
  [(set (match_operand:HI 0 "nonimmediate_operand_with_GP" "=Rg,  Rg,    Rg,Rg,Asi,Asi,Adm3,Anoext, m, Rg,  Rg")
        (match_operand:HI 1 "GP_or_reg_operand"             "Rg,Adm3,Anoext, m,Is8,  i,  Rg,    Rg,Rg,Iu6,Is16"))]
  "TARGET_V4_FEATURES
   && (!memory_operand(operands[0], HImode)
       || gr_register_operand(operands[1], HImode)
       || (qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                      reload_in_progress || reload_completed,
                                      \"si\")
           && immediate_operand(operands[1], HImode)
           && (s8_const_int_operand(operands[1], HImode)
               || crtl->combine_in_progress || crtl->combine_completed)))"
  "@
   %0 = %1
   %0 = memh(%1)
   %0 = memh(%1)
   %0 = memh(%E1)
   memh(%0) = #%1
   memh(%0) = ##%1
   memh(%0) = %1
   memh(%0) = %1
   memh(%E0) = %1
   %0 = #%1
   %0 = #%1"
  [(set_attr "type" "A,Load,Load,ELoad,Store,EStore,Store,Store,EStore,A,A")
   (set_attr "duplex" "yes,yes,no,no,no,no,yes,no,no,yes,no")]
)

(define_insn "movhi_new_value"
  [(set (match_operand:HI 0 "memory_operand"             "=Anoext, m")
        (unspec:HI [(match_operand:HI 1 "gr_register_operand" "Rg,Rg")]
                   UNSPEC_NEW_VALUE))]
  "TARGET_V4_FEATURES"
  "@
   memh(%0) = %1.new
   memh(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

(define_insn "movhi_real"
  [(set (match_operand:HI 0 "nonimmediate_operand_with_GP" "=Rg,Rg, m,  Rg")
        (match_operand:HI 1 "GP_or_reg_operand"             "Rg, m,Rg,Is16"))]
  "!TARGET_V4_FEATURES
   && (!memory_operand(operands[0], HImode)
       || gr_register_operand(operands[1], HImode))"
  "@
   %0 = %1
   %0 = memh(%1)
   memh(%0) = %1
   %0 = #%1"
  [(set_attr "type" "A,Load,Store,A")]
)

(define_insn "cond_movhi"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,  Rp,  Rp,   Rp,    Rp,  Rp,Rp")
        (const_int 0)])
     (set (match_operand:HI 0 "conditional_dest_operand" "=Rg,   Rg,    Rg,Acsi,Acsi,Acond,Aecond,  Rg,Rg")
          (match_operand:HI 1 "conditional_src_operand"   "Rg,Acond,Aecond, Is6,   i,   Rg,    Rg,Is12, i")))]
  "!memory_operand(operands[0], HImode)
   || gr_register_operand(operands[1], HImode)
   || (TARGET_V4_FEATURES
       && qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                     reload_in_progress || reload_completed,
                                     \"csi\")
       && immediate_operand(operands[1], HImode)
       && (s8_const_int_operand(operands[1], HImode)
           || crtl->combine_in_progress || crtl->combine_completed))"
  "@
   if (%C2) %0 = %1
   if (%C2) %0 = memh(%1)
   if (%C2) %0 = memh(%E1)
   if (%C2) memh(%0) = #%1
   if (%C2) memh(%0) = ##%1
   if (%C2) memh(%0) = %1
   if (%C2) memh(%E0) = %1
   if (%C2) %0 = #%1
   if (%C2) %0 = ##%1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Store,EStore,A,EA")]
)

(define_insn "cond_movhi_new_value"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"               "Rp,    Rp")
        (const_int 0)])
     (set (match_operand:HI 0 "memory_operand"              "=Acond,Aecond")
          (unspec:HI [(match_operand:HI 1 "gr_register_operand" "Rg,    Rg")]
                     UNSPEC_NEW_VALUE)))]
  "TARGET_V4_FEATURES"
  "@
   if (%C2) memh(%0) = %1.new
   if (%C2) memh(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

;;-------;;
;; movsi ;;
;;-------;;

(define_expand "movsi"
  [(set (match_operand:SI 0 "nonimmediate_operand" "")
        (match_operand:SI 1 "general_operand" ""))]
  ""
  {
    rtx reg;
    if(TARGET_SECTION_SORTING_CODE_SUPPORT && TARGET_SECTION_SORTING
       && can_create_pseudo_p()){
      if(MEM_P (operands[0])
         && !GP_or_reg_operand(operands[0], SImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[0], 0));
        operands[0] = change_address(operands[0], SImode, reg);
      }
      else if(MEM_P (operands[1])
              && !GP_or_reg_operand(operands[1], SImode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[1], 0));
        operands[1] = change_address(operands[1], SImode, reg);
      }
    }
    if(!(register_operand(operands[0], SImode)
         || (TARGET_V4_FEATURES && MEM_P (operands[0])
             && qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                           reload_in_progress
                                           || reload_completed, "si")
             && s8_const_int_operand(operands[1], SImode)))){
      operands[1] = force_reg(SImode, operands[1]);
    }
  }
)

(define_insn "movsi_high"
  [(set (match_operand:SI 0 "gr_register_operand"      "=Rg")
        (high:SI (match_operand:SI 1 "immediate_operand" "i")))]
  ""
  "%0.h = #HI(%1)"
  [(set_attr "type" "A")]
)

(define_insn "movsi_low"
  [(set (match_operand:SI 0 "gr_register_operand"          "+Rg")
        (lo_sum:SI (match_operand:SI 1 "gr_register_operand" "0")
                   (match_operand:SI 2 "immediate_operand"   "i")))]
  ""
  "%0.l = #LO(%2)"
  [(set_attr "type" "A")]
)



(define_insn "movsi_real_v4"
  [(set (match_operand:SI 0 "nonimmediate_operand_with_GP" "=Rg,  Rg,    Rg,    Rg,Rg,Adm4,Asi,Asi, Admsp5,Anoext,  m,     Rg, Rg,  Rg,Rg,Rc")
        (match_operand:SI 1 "GP_or_reg_operand"             "Rg,Adm4,Admsp5,Anoext, m, Iu1,Is8,  i,     Rg,     Rg,Rg,K-1Iu6,Is16,   i,Rc,Rg"))]
  "TARGET_V4_FEATURES
   && (!memory_operand(operands[0], SImode)
       || gr_register_operand(operands[1], SImode)
       || (qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                      reload_in_progress || reload_completed,
                                      \"si\")
           && immediate_operand(operands[1], SImode)
           && (s8_const_int_operand(operands[1], SImode)
               || crtl->combine_in_progress || crtl->combine_completed)))"
  "@
   %0 = %1
   %0 = memw(%1)
   %0 = memw(%1)
   %0 = memw(%1)
   %0 = memw(%E1)
   memw(%0) = #%1
   memw(%0) = #%1
   memw(%0) = ##%1
   memw(%0) = %1
   memw(%0) = %1
   memw(%E0) = %1
   %0 = #%1
   %0 = #%1
   %0 = ##%1
   %0 = %1
   %0 = %1"
  [(set_attr "type" "A,Load,Load,Load,ELoad,Store,Store,EStore,Store,Store,EStore,A,A,EA,CR,CR")
   (set_attr "duplex" "yes,yes,yes,no,no,yes,no,no,yes,no,no,yes,no,no,no,no")]
)

(define_insn "movsi_new_value"
  [(set (match_operand:SI 0 "memory_operand"             "=Anoext, m")
        (unspec:SI [(match_operand:SI 1 "gr_register_operand" "Rg,Rg")]
                   UNSPEC_NEW_VALUE))]
  "TARGET_V4_FEATURES"
  "@
   memw(%0) = %1.new
   memw(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

(define_insn "movsi_const32"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (unspec:SI [(match_operand:SI 1 "GP_or_reg_operand" "i")
                    (match_operand:SI 2 "nonmemory_operand" "i")] UNSPEC_MOVSI_CONST32))]
  "TARGET_V2_FEATURES"
  "%0 = CONST32(%1 + %2)"
  [(set_attr "type" "Load")]
)

(define_insn "movsi_real"
  [(set (match_operand:SI 0 "nonimmediate_operand_with_GP" "=Rg,Rg, m,  Rg,?Rg,Rg,Rc")
        (match_operand:SI 1 "GP_or_reg_operand"             "Rg, m,Rg,Is16,  i,Rc,Rg"))]
  "!TARGET_V4_FEATURES
   && (!memory_operand(operands[0], SImode)
       || gr_register_operand(operands[1], SImode))"
  {
    switch(which_alternative){
      case 0:
        return "%0 = %1";
      case 1:
        return "%0 = memw(%1)";
      case 2:
        return "memw(%0) = %1";
      case 3:
        return "%0 = #%1";
      case 4:
        if(TARGET_CONST32
           && (TARGET_LITERAL_POOL_ADDRESSES
               || GET_CODE (operands[1]) != SYMBOL_REF)){
          return "%0 = CONST32(#%1)";
        }
        else {
          return "#";
        }
      case 5:
        return "%0 = %1";
      case 6:
        return "%0 = %1";
      default:
        gcc_unreachable();
    }
  }
  [(set_attr "type" "A,Load,Store,A,Load,CR,CR")]
)

;; Split load immediates that take two assembly instructions into two
;; RTL insns so they can be scheduled separately.
(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (match_operand:SI 1 "immediate_not_s16_operand" ""))]
  "!(TARGET_CONST32
     && (TARGET_LITERAL_POOL_ADDRESSES || GET_CODE (operands[1]) != SYMBOL_REF))
   && reload_completed
   && !TARGET_V4_FEATURES"
  [(set (match_dup 0) (high:SI (match_dup 1)))
   (set (match_dup 0) (lo_sum:SI (match_dup 0) (match_dup 1)))]
  ""
)

(define_insn "cond_movsi"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,  Rp,  Rp,   Rp,    Rp,  Rp,Rp, Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "conditional_dest_operand" "=Rg,   Rg,    Rg, Acsi, Acsi,Acond,Aecond,  Rg,   Rg,   Rg")
          (match_operand:SI 1 "conditional_src_operand"   "Rg,Acond,Aecond,  Is6,    i,   Rg,    Rg,  Iu00, Is12,    i")))]
  "!memory_operand(operands[0], SImode)
   || gr_register_operand(operands[1], SImode)
   || (TARGET_V4_FEATURES
       && qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                     reload_in_progress || reload_completed,
                                     \"csi\")
       && immediate_operand(operands[1], SImode)
       && (s8_const_int_operand(operands[1], SImode)
           || crtl->combine_in_progress || crtl->combine_completed))"
  "@
   if (%C2) %0 = %1
   if (%C2) %0 = memw(%1)
   if (%C2) %0 = memw(%E1)
   if (%C2) memw(%0) = #%1
   if (%C2) memw(%0) = ##%1
   if (%C2) memw(%0) = %1
   if (%C2) memw(%E0) = %1
   if (%C2) %0 = #%1
   if (%C2) %0 = #%1
   if (%C2) %0 = ##%1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Store,EStore,A,A,EA")
   (set_attr "duplex" "no,no,no,no,no,no,no,yes,no,no")]
)

(define_insn "cond_movsi_new_value"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"               "Rp,    Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "memory_operand"              "=Acond,Aecond")
          (unspec:SI [(match_operand:SI 1 "gr_register_operand" "Rg,    Rg")]
                     UNSPEC_NEW_VALUE)))]
  "TARGET_V4_FEATURES"
  "@
   if (%C2) memw(%0) = %1.new
   if (%C2) memw(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

;;-------;;
;; movdi ;;
;;-------;;

(define_expand "movdi"
  [(set (match_operand:DI 0 "nonimmediate_operand" "")
        (match_operand:DI 1 "general_operand" ""))]
  ""
  {
    if(GET_CODE (operands[0]) != REG){
      operands[1] = force_reg(DImode, operands[1]);
    }
  }
)

(define_insn "movdi_real"
  [(set (match_operand:DI 0 "nonimmediate_operand" "=Rg,    Rg,    Rg,Rg,Admsp6,Anoext, m, Rg,   Rg,Rg,Rg,Rc")
        (match_operand:DI 1 "general_operand"       "Rg,Admsp5,Anoext, m,    Rg,    Rg,Rg,Is8,Ks8s8, i,Rc,Rg"))]
  "!(memory_operand(operands[0], DImode)
     && immediate_operand(operands[1], DImode))"
  {
    switch(which_alternative){
      case 0:
        return "%P0 = %P1";
      case 1:
        return "%P0 = memd(%1)";
      case 2:
        return "%P0 = memd(%1)";
      case 3:
        return "%P0 = memd(%E1)";
      case 4:
        return "memd(%0) = %P1";
      case 5:
        return "memd(%0) = %P1";
      case 6:
        return "memd(%E0) = %P1";
      case 7:
        return "%P0 = #%1";
      case 8:
        operands[2] = gen_int_mode(INTVAL (operands[1]) >> 32ULL, SImode);
        operands[1] = gen_int_mode(INTVAL (operands[1]) & 0xFFFFFFFFULL,
                                   SImode);
        return "%P0 = combine(#%2,#%1)";
      case 9:
        if(TARGET_CONST64){
          return "%P0 = CONST64(#%1)";
        }
        else {
          return "#";
        }
      case 10:
        return "%P0 = %P1";
      case 11:
        return "%P0 = %P1";
      default:
        gcc_unreachable();
    }
  }
  [(set_attr "type"   "A,Load,Load,ELoad,Store,Store,EStore,A,A,Load,CR,CR")
   (set_attr "duplex" "no,yes,no,no,yes,no,no,no,no,no,no,no")]
)

;; Split moves of immediates to register pairs into separate moves to each
;; register.  Each of those moves might themselves be split.
(define_split
  [(set (match_operand:DI 0 "gr_register_operand" "")
        (match_operand:DI 1 "immediate_operand" ""))]
  "!(((TARGET_V2_FEATURES && GET_CODE (operands[1]) == CONST_INT
       && CONST_OK_FOR_CONSTRAINT_P (INTVAL (operands[1]), 'K', \"Ks8s8\"))
      || TARGET_CONST64)
     || operands[1] == const0_rtx)
   && reload_completed"
  [(set (match_dup 2) (match_dup 4))
   (set (match_dup 3) (match_dup 5))]
  {
    operands[2] = gen_highpart(SImode, operands[0]);
    operands[3] = gen_lowpart(SImode, operands[0]);
    operands[4] = gen_int_mode(INTVAL (operands[1]) >> 32ULL, SImode);
    operands[5] = gen_int_mode(INTVAL (operands[1]), SImode);
  }
)

(define_insn "cond_movdi"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,   Rp,    Rp")
        (const_int 0)])
     (set (match_operand:DI 0 "conditional_dest_operand" "=Rg,   Rg,    Rg,Acond,Aecond")
          (match_operand:DI 1 "conditional_src_operand"   "Rg,Acond,Aecond,   Rg,    Rg")))]
  "!memory_operand(operands[0], DImode)
   || gr_register_operand(operands[1], DImode)"
  "@
   if (%C2) %P0 = %P1
   if (%C2) %P0 = memd(%1)
   if (%C2) %P0 = memd(%E1)
   if (%C2) memd(%0) = %P1
   if (%C2) memd(%E0) = %P1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore")]
)

;;-------;;
;; movsf ;;
;;-------;;

(define_expand "movsf"
  [(set (match_operand:SF 0 "nonimmediate_operand" "")
        (match_operand:SF 1 "general_operand" ""))]
  ""
  {
    rtx reg;
    if(TARGET_SECTION_SORTING_CODE_SUPPORT && TARGET_SECTION_SORTING
       && can_create_pseudo_p()){
      if(MEM_P (operands[0])
         && !GP_or_reg_operand(operands[0], SFmode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[0], 0));
        operands[0] = change_address(operands[0], SFmode, reg);
      }
      else if(MEM_P (operands[1])
              && !GP_or_reg_operand(operands[1], SFmode)){
        reg = gen_reg_rtx(Pmode);
        emit_move_insn(reg, XEXP (operands[1], 0));
        operands[1] = change_address(operands[1], SFmode, reg);
      }
    }
    if(!(register_operand(operands[0], SFmode)
         || (TARGET_V4_FEATURES && MEM_P (operands[0])
             && qdsp6_legitimate_address_p(SFmode, XEXP (operands[0], 0),
                                           reload_in_progress
                                           || reload_completed, "si")
             && CONST_DOUBLE_OK_FOR_LETTER_P (operands[1], 'G')))){
      operands[1] = force_reg(SFmode, operands[1]);
    }
  }
)

(define_insn "movsf_real_v4"
  [(set (match_operand:SF 0 "nonimmediate_operand_with_GP" "=Rg,    Rg,Rg,Asi,Asi,Anoext, m,Rg,Rg")
        (match_operand:SF 1 "GP_or_reg_operand"             "Rg,Anoext, m,  G,  i,    Rg,Rg, G, i"))]
  "TARGET_V4_FEATURES
   && (!memory_operand(operands[0], SFmode)
       || gr_register_operand(operands[1], SFmode)
       || (qdsp6_legitimate_address_p(SFmode, XEXP (operands[0], 0),
                                      reload_in_progress || reload_completed,
                                      \"si\")
           && immediate_operand(operands[1], SFmode)
           && (CONST_DOUBLE_OK_FOR_LETTER_P (operands[1], 'G')
               || crtl->combine_in_progress || crtl->combine_completed)))"
  "@
   %0 = %1
   %0 = memw(%1)
   %0 = memw(%E1)
   memw(%0) = #%1
   memw(%0) = ##%1
   memw(%0) = %1
   memw(%E0) = %1
   %0 = #%1
   %0 = ##%1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Store,EStore,A,EA")]
)

(define_insn "movsf_new_value"
  [(set (match_operand:SF 0 "memory_operand"             "=Anoext, m")
        (unspec:SF [(match_operand:SF 1 "gr_register_operand" "Rg,Rg")]
                   UNSPEC_NEW_VALUE))]
  "TARGET_V4_FEATURES"
  "@
   memw(%0) = %1.new
   memw(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

(define_insn "movsf_real"
  [(set (match_operand:SF 0 "nonimmediate_operand_with_GP" "=Rg,Rg, m,Rg,?Rg")
        (match_operand:SF 1 "GP_or_reg_operand"             "Rg, m,Rg, G,  i"))]
  "!TARGET_V4_FEATURES
   && (!memory_operand(operands[0], SFmode)
       || gr_register_operand(operands[1], SFmode))"
  {
    switch(which_alternative){
      case 0:
        return "%0 = %1";
      case 1:
        return "%0 = memw(%1)";
      case 2:
        return "memw(%0) = %1";
      case 3:
        return "%0 = #%1";
      case 4:
        if(TARGET_CONST32){
          return "%0 = CONST32(#%1)";
        }
        else {
          return "#";
        }
      default:
        gcc_unreachable();
    }
  }
  [(set_attr "type" "A,Load,Store,A,Load")]
)

;; After reload, replace floating immediate moves with integer immediate moves.
(define_split
  [(set (match_operand:SF 0 "gr_register_operand" "")
        (match_operand:SF 1 "immediate_operand" ""))]
  "!(TARGET_CONST32 || CONST_DOUBLE_OK_FOR_LETTER_P (operands[1], 'G'))
   && reload_completed
   && !TARGET_V4_FEATURES"
  [(set (match_dup 2) (match_dup 3))]
  {
    REAL_VALUE_TYPE rv;
    long l;

    REAL_VALUE_FROM_CONST_DOUBLE (rv, operands[1]);
    REAL_VALUE_TO_TARGET_SINGLE (rv, l);

    operands[2] = gen_rtx_REG (SImode, REGNO (operands[0]));
    ORIGINAL_REGNO (operands[2]) = ORIGINAL_REGNO (operands[0]);
    operands[3] = gen_int_mode(l, SImode);
  }
)

(define_insn "cond_movsf"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,  Rp,  Rp,   Rp,    Rp,Rp,Rp")
        (const_int 0)])
     (set (match_operand:SF 0 "conditional_dest_operand" "=Rg,   Rg,    Rg,Acsi,Acsi,Acond,Aecond,Rg,Rg")
          (match_operand:SF 1 "conditional_src_operand"   "Rg,Acond,Aecond,   G,   i,   Rg,    Rg, G, i")))]
  "!memory_operand(operands[0], SFmode)
   || gr_register_operand(operands[1], SFmode)
   || (TARGET_V4_FEATURES
       && qdsp6_legitimate_address_p(SFmode, XEXP (operands[0], 0),
                                     reload_in_progress || reload_completed,
                                     \"csi\")
       && immediate_operand(operands[1], SFmode)
       && (CONST_DOUBLE_OK_FOR_LETTER_P (operands[1], 'G')
           || crtl->combine_in_progress || crtl->combine_completed))"
  "@
   if (%C2) %0 = %1
   if (%C2) %0 = memw(%1)
   if (%C2) %0 = memw(%E1)
   if (%C2) memw(%0) = #%1
   if (%C2) memw(%0) = ##%1
   if (%C2) memw(%0) = %1
   if (%C2) memw(%E0) = %1
   if (%C2) %0 = #%1
   if (%C2) %0 = ##%1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Store,EStore,A,EA")]
)

(define_insn "cond_movsf_new_value"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"               "Rp,    Rp")
        (const_int 0)])
     (set (match_operand:SF 0 "memory_operand"              "=Acond,Aecond")
          (unspec:SF [(match_operand:SF 1 "gr_register_operand" "Rg,    Rg")]
                     UNSPEC_NEW_VALUE)))]
  "TARGET_V4_FEATURES"
  "@
   if (%C2) memw(%0) = %1.new
   if (%C2) memw(%E0) = %1.new"
  [(set_attr "type" "NewValue,ENewValue")]
)

;;-------;;
;; movdf ;;
;;-------;;

(define_expand "movdf"
  [(set (match_operand:DF 0 "nonimmediate_operand" "")
        (match_operand:DF 1 "general_operand" ""))]
  ""
  {
    if(GET_CODE (operands[0]) != REG){
      operands[1] = force_reg(DFmode, operands[1]);
    }
  }
)

(define_insn "movdf_real"
  [(set (match_operand:DF 0 "nonimmediate_operand" "=Rg,    Rg,Rg,Anoext, m,Rg")
        (match_operand:DF 1 "general_operand"       "Rg,Anoext, m,    Rg,Rg, i"))]
  ""
  {
    switch(which_alternative){
      case 0:
        return "%P0 = %P1";
      case 1:
        return "%P0 = memd(%1)";
      case 2:
        return "%P0 = memd(%E1)";
      case 3:
        return "memd(%0) = %P1";
      case 4:
        return "memd(%E0) = %P1";
      case 5:
        if(TARGET_CONST64){
          return "%P0 = CONST64(#%1)";
        }
        else {
          return "#";
        }
      default:
        gcc_unreachable();
    }
  }
  [(set_attr "type" "A,Load,ELoad,Store,EStore,Load")]
)

;; After reload, replace floating immediate moves with integer immediate moves.
(define_split
  [(set (match_operand:DF 0 "gr_register_operand" "")
        (match_operand:DF 1 "immediate_operand" ""))]
  "!TARGET_CONST64 && reload_completed"
  [(set (match_dup 2) (match_dup 4))
   (set (match_dup 3) (match_dup 5))]
  {
    REAL_VALUE_TYPE rv;
    long l[2];

    REAL_VALUE_FROM_CONST_DOUBLE (rv, operands[1]);
    REAL_VALUE_TO_TARGET_DOUBLE (rv, l);

    operands[2] = gen_highpart (SImode, operands[0]);
    operands[3] = gen_lowpart (SImode, operands[0]);
    ORIGINAL_REGNO (operands[3]) = ORIGINAL_REGNO (operands[0]);
    operands[4] = gen_int_mode(WORDS_BIG_ENDIAN ? l[0] : l[1], SImode);
    operands[5] = gen_int_mode(WORDS_BIG_ENDIAN ? l[1] : l[0], SImode);
  }
)

(define_insn "cond_movdf"
  [(cond_exec
     (match_operator:BI 2 "predicate_operator"
       [(match_operand:BI 3 "pr_register_operand"         "Rp,   Rp,    Rp,   Rp,    Rp")
        (const_int 0)])
     (set (match_operand:DF 0 "conditional_dest_operand" "=Rg,   Rg,    Rg,Acond,Aecond")
          (match_operand:DF 1 "conditional_src_operand"   "Rg,Acond,Aecond,   Rg,    Rg")))]
  "!memory_operand(operands[0], DFmode)
   || gr_register_operand(operands[1], DFmode)"
  "@
   if (%C2) %P0 = %P1
   if (%C2) %P0 = memd(%1)
   if (%C2) %P0 = memd(%E1)
   if (%C2) memd(%0) = %P1
   if (%C2) memd(%E0) = %P1"
  [(set_attr "type" "A,Load,ELoad,Store,EStore")]
)


;;--------------;;
;; reload_in{m} ;;
;;--------------;;


;;---------------;;
;; reload_out{m} ;;
;;---------------;;


;;--------------;;
;; movstrict{m} ;;
;;--------------;;
;; ??? define this for upper word? ;;


;;----------------;;
;; movmisalign{m} ;;
;;----------------;;


;;---------------;;
;; load_multiple ;;
;;---------------;;


;;----------------;;
;; store_multiple ;;
;;----------------;;


;;------------;;
;; vec_set{m} ;;
;;------------;;

;;----------------;;
;; vec_extract{m} ;;
;;----------------;;

;;-------------;;
;; vec_init{m} ;;
;;-------------;;


;;----------;;
;; push{m}1 ;;
;;----------;;


;;---------;;
;; add{m}3 ;;
;;---------;;

(define_expand "addsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (plus:SI (match_operand:SI 1 "gr_register_operand" "")
                 (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
  {
    if(!reload_completed
       && !gr_register_operand(operands[2], SImode)
       && !s16_const_int_operand(operands[2], SImode)){
      operands[2] = force_reg(SImode, operands[2]);
    }
  }
)

(define_insn "increment_stack_pointer_duplex"
   [(set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "nonmemory_operand" "Ju6_2")))]
   "TARGET_V4_FEATURES
    && u8_const_int_operand(operands[0], SImode)"
   "r29 = add(r29,#%0)"
  [(set_attr "type" "A")
   (set_attr "duplex" "yes")]
)


(define_insn_and_split "addsi3_real_v4"
  [(set (match_operand:SI 0 "nonimmediate_operand"         "=Rg, Rg, Rg,  Rg,Rg,Rg,Rg,Amemop,Aememop,Amemop,Aememop,Amemop,Aememop")
        (plus:SI (match_operand:SI 1 "nonimmediate_operand""Rg,  Rg,  0,  Rg,Rg, 0,Rg,     0,      0,     0,      0,     0,      0")
                 (match_operand:SI 2 "nonmemory_operand"   "K01,K-1,Is7,Is16, i,Rg,Rg,   Iu5,    Iu5,   In5,    In5,    Rg,     Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s16_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && ((!memory_operand(operands[0], SImode)
        && !memory_operand(operands[1], SImode))
       || (TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])))"
  "@
   %0 = add(%1,#%2)
   %0 = add(%1,#%2)
   %0 = add(%1,#%2)
   %0 = add(%1,#%2)
   %0 = add(%1,##%2)
   %0 = add(%1,%2)
   %0 = add(%1,%2)
   memw(%0) += #%2
   memw(%E0) += #%2
   memw(%0) -= #%n2
   memw(%E0) -= #%n2
   memw(%0) += %2
   memw(%E0) += %2"
  "&& !reload_completed
   && memory_operand(operands[0], SImode)
   && !qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0) (plus:SI (match_dup 0) (match_dup 2)))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], SImode, address_reg);
  }
  [(set_attr "type" "A,A,A,A,EA,A,A,Memop,EMemop,Memop,EMemop,Memop,EMemop")
   (set_attr "duplex" "yes,yes,yes,no,no,yes,no,no,no,no,no,no,no")]
)

(define_insn "addsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg,Rg")
        (plus:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                 (match_operand:SI 2 "gr_or_s16_operand" "Is16,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = add(%1,#%2)
   %0 = add(%1,%2)"
  [(set_attr "type" "A,A")]
)

(define_insn "cond_addsi3"
  [(cond_exec
     (match_operator:BI 3 "predicate_operator"
       [(match_operand:BI 4 "pr_register_operand"                "Rp, Rp,Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "gr_register_operand"             "=Rg, Rg,Rg")
          (plus:SI (match_operand:SI 1 "gr_register_operand"     "Rg, Rg,Rg")
                   (match_operand:SI 2 "conditional_add_operand" "Rg,Is8, i"))))]
  "!immediate_operand(operands[2], SImode)
   || s8_const_int_operand(operands[2], SImode)
   || crtl->combine_in_progress || crtl->combine_completed"
  "@
   if (%C3) %0 = add(%1,%2)
   if (%C3) %0 = add(%1,#%2)
   if (%C3) %0 = add(%1,##%2)"
  [(set_attr "type" "A,A,EA")]
)

(define_insn "adddi3"
  [(set (match_operand:DI 0 "gr_register_operand"         "=Rg")
        (plus:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%P0 = add(%P1,%P2)"
  [(set_attr "type" "X")]
)

(define_insn "adddisi3"
  [(set (match_operand:DI 0 "gr_register_operand"                         "=Rg")
        (plus:DI (sign_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                 (match_operand:DI 2 "gr_register_operand"                 "Rg")))]
  "TARGET_V3_FEATURES"
  "%0 = add(%1,%P2)"
  [(set_attr "type" "X")]
)


;;-----------;;
;; ssadd{m}3 ;;
;;-----------;;

(define_insn "ssaddsi3"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg")
        (ss_plus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                    (match_operand:SI 2 "gr_register_operand" "Rg")))]
  "TARGET_V4_FEATURES"
  "%0 = add(%1,%2):sat"
  [(set_attr "type" "A")]
)


;;---------;;
;; sub{m}3 ;;
;;---------;;

(define_expand "subsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (minus:SI (match_operand:SI 1 "nonmemory_operand" "")
                  (match_operand:SI 2 "gr_register_operand" "")))]
  ""
  {
    if(!reload_completed
       && !gr_register_operand(operands[1], SImode)
       && !s10_const_int_operand(operands[1], SImode)){
      operands[1] = force_reg(SImode, operands[1]);
    }
  }
)

(define_insn_and_split "subsi3_real_v4"
  [(set (match_operand:SI 0 "nonimmediate_operand"         "=Rg,Rg,Rg,Amemop,Aememop")
        (minus:SI (match_operand:SI 1 "general_operand"   "Is10, i,Rg,     0,      0")
                  (match_operand:SI 2 "gr_register_operand" "Rg,Rg,Rg,    Rg,     Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[1], SImode)
       || s10_const_int_operand(operands[1], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && ((!memory_operand(operands[0], SImode)
        && !memory_operand(operands[1], SImode))
       || (TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])))"
  "@
   %0 = sub(#%1,%2)
   %0 = sub(##%1,%2)
   %0 = sub(%1,%2)
   memw(%0) -= %2
   memw(%E0) -= %2"
  "&& !reload_completed
   && memory_operand(operands[0], SImode)
   && !qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0) (minus:SI (match_dup 0) (match_dup 2)))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], SImode, address_reg);
  }
  [(set_attr "type" "A,EA,A,Memop,EMemop")]
)

(define_insn "subsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"          "=Rg,Rg")
        (minus:SI (match_operand:SI 1 "nonmemory_operand" "Is10,Rg")
                  (match_operand:SI 2 "gr_register_operand" "Rg,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = sub(#%1,%2)
   %0 = sub(%1,%2)"
  [(set_attr "type" "A,A")]
)

(define_insn "cond_subsi3"
  [(cond_exec
     (match_operator:BI 3 "predicate_operator"
       [(match_operand:BI 4 "pr_register_operand"             "Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "gr_register_operand"          "=Rg")
          (minus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                    (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  ""
  "if (%C3) %0 = sub(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "subdi3"
  [(set (match_operand:DI 0 "gr_register_operand"          "=Rg")
        (minus:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                  (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%P0 = sub(%P1,%P2)"
  [(set_attr "type" "X")]
)


;;-----------;;
;; sssub{m}3 ;;
;;-----------;;

(define_insn "sssubsi3"
  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg")
        (ss_minus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                     (match_operand:SI 2 "gr_register_operand" "Rg")))]
  "TARGET_V4_FEATURES"
  "%0 = sub(%1,%2):sat"
  [(set_attr "type" "A")]
)


;;---------;;
;; mul{m}3 ;;
;;---------;;

(define_insn "mulsi3_real_v4"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg,Rg,Rg")
        (mult:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
                 (match_operand:SI 2 "nonmemory_operand"  "Im9, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || m9_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = mpyi(%1,#%2)
   %0 = mpyi(%1,##%2)
   %0 = mpyi(%1,%2)"
  [(set_attr "type" "M,EM,M")]
)

(define_insn "mulsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg,Rg")
        (mult:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                 (match_operand:SI 2 "gr_or_m9_operand"   "Im9,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = mpyi(%1,#%2)
   %0 = mpyi(%1,%2)"
  [(set_attr "type" "M,M")]
)

(define_expand "mulsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (mult:SI (match_operand:SI 1 "gr_register_operand" "")
                 (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
  {
    if(!reload_completed
       && !register_operand(operands[2], SImode)
       && !m9_const_int_operand(operands[2], SImode)){
      operands[2] = force_reg(SImode, operands[2]);
    }
  }
)


;;
;; Yes, it's true, we don't have a DImode multiply
;; But if we don't define it here then we miss some optimizations
;; where the combiner could turn it into a sidi but we've already
;; converted the DImode multiply into 3 SImode multiplies... bad news.
;;

(define_insn_and_split "muldi3"
  [(set (match_operand:DI 0 "gr_register_operand"        "=&Rg")
        (mult:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [
(set (match_dup 0) (unspec:DI [(match_dup 1) (match_dup 2)] UNSPEC_MULDI_1) )
(set (match_dup 0) (unspec:DI [(match_dup 1) (match_dup 2) (match_dup 0)] UNSPEC_MULDI_2) )
(set (match_dup 0) (unspec:DI [(match_dup 2) (match_dup 1) (match_dup 0)] UNSPEC_MULDI_2) )
  ]
)

(define_insn "muldi3_helper_1"
  [(set (match_operand:DI 0 "gr_register_operand"            "=Rg")
        (unspec:DI [(match_operand:DI 1 "gr_register_operand" "Rg")
                    (match_operand:DI 2 "gr_register_operand" "Rg")] UNSPEC_MULDI_1))]
  "TARGET_V2_FEATURES"
  "%P0 = mpyu(%L1,%L2)"
  [(set_attr "type" "M")]
)

(define_insn "muldi3_helper_2"
  [(set (match_operand:DI 0 "gr_register_operand"            "=Rg")
        (unspec:DI [(match_operand:DI 1 "gr_register_operand" "Rg")
                    (match_operand:DI 2 "gr_register_operand" "Rg")
                    (match_operand:DI 3 "gr_register_operand"  "0")] UNSPEC_MULDI_2))]
  "TARGET_V2_FEATURES"
  "%H0 += mpyi(%L1,%H2)"
  [(set_attr "type" "M")]
)


;;---------;;
;; div{m}3 ;;
;;---------;;


;;----------;;
;; udiv{m}3 ;;
;;----------;;


;;---------;;
;; mod{m}3 ;;
;;---------;;


;;----------;;
;; umod{m}3 ;;
;;----------;;


;;----------;;
;; umin{m}3 ;;
;;----------;;

(define_insn "uminsi3"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg")
        (umin:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                 (match_operand:SI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = minu(%1,%2)"
  [(set_attr "type" "X")]
)


(define_insn "umindi3"
  [(set (match_operand:DI 0 "gr_register_operand"         "=Rg")
        (umin:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  "TARGET_V3_FEATURES"
  "%0 = minu(%1,%2)"
  [(set_attr "type" "X")]
)


;;----------;;
;; umax{m}3 ;;
;;----------;;

(define_insn "umaxsi3"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg")
        (umax:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                 (match_operand:SI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = maxu(%1,%2)"
  [(set_attr "type" "X")]
)


(define_insn "umaxdi3"
  [(set (match_operand:DI 0 "gr_register_operand"         "=Rg")
        (umax:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  "TARGET_V3_FEATURES"
  "%0 = maxu(%1,%2)"
  [(set_attr "type" "X")]
)

;;---------;;
;; and{m}3 ;;
;;---------;;

(define_insn "andbi3"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (and:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                (match_operand:BI 2 "pr_register_operand" "Rp")))]
  ""
  "%0 = and(%1,%2)"
  [(set_attr "type" "S")]
)

(define_expand "andsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (and:SI (match_operand:SI 1 "gr_register_operand" "")
                (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
  {
    if(!reload_completed
       && !gr_register_operand(operands[2], SImode)
       && !s10_const_int_operand(operands[2], SImode)){
      operands[2] = force_reg(SImode, operands[2]);
    }
  }
)

(define_insn_and_split "andsi3_real_v4"
  [(set (match_operand:SI 0 "nonimmediate_operand"        "=Rg,  Rg,       Rg,Rg,Rg,   Amemop,  Aememop,Amemop,Aememop")
        (and:SI (match_operand:SI 1 "nonimmediate_operand" "Rg,  Rg,       Rg,Rg,Rg,        0,        0,     0,      0")
                (match_operand:SI 2 "nonmemory_operand"    "K01,Is10,Konenot32, i,Rg,Konenot32,Konenot32,    Rg,     Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && ((!memory_operand(operands[0], SImode)
        && !memory_operand(operands[1], SImode))
       || (TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])))"
  "@
   %0 = and(%1,#%2)
   %0 = and(%1,#%2)
   %0 = clrbit(%1,#%K2)
   %0 = and(%1,##%2)
   %0 = and(%1,%2)
   memw(%0) = clrbit(#%K2)
   memw(%E0) = clrbit(#%K2)
   memw(%0) &= %2
   memw(%E0) &= %2"
  "&& !reload_completed
   && memory_operand(operands[0], SImode)
   && !qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0) (and:SI (match_dup 0) (match_dup 2)))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], SImode, address_reg);
  }
  [(set_attr "type" "A,A,S,EA,A,Memop,EMemop,Memop,EMemop")
   (set_attr "duplex" "yes,no,no,no,no,no,no,no,no")]
)

(define_insn "andsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg,       Rg,Rg")
        (and:SI (match_operand:SI 1 "gr_register_operand" "Rg,       Rg,Rg")
                (match_operand:SI 2 "nonmemory_operand" "Is10,Konenot32,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = and(%1,#%2)
   %0 = clrbit(%1,#%K2)
   %0 = and(%1,%2)"
  [(set_attr "type" "A,S,A")]
)

(define_insn "cond_andsi3"
  [(cond_exec
     (match_operator:BI 3 "predicate_operator"
       [(match_operand:BI 4 "pr_register_operand"           "Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "gr_register_operand"        "=Rg")
          (and:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                  (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  ""
  "if (%C3) %0 = and(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "anddi3"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (and:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%P0 = and(%P1,%P2)"
  [(set_attr "type" "X")]
)


;;---------;;
;; ior{m}3 ;;
;;---------;;

(define_insn "iorbi3"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (ior:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                (match_operand:BI 2 "pr_register_operand" "Rp")))]
  ""
  "%0 = or(%1,%2)"
  [(set_attr "type" "S")]
)

(define_expand "iorsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ior:SI (match_operand:SI 1 "gr_register_operand" "")
                (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
  {
    if(!reload_completed
       && !gr_register_operand(operands[2], SImode)
       && !s10_const_int_operand(operands[2], SImode)){
      operands[2] = force_reg(SImode, operands[2]);
    }
  }
)

(define_insn_and_split "iorsi3_real_v4"
  [(set (match_operand:SI 0 "nonimmediate_operand"        "=Rg,       Rg,Rg,Rg,   Amemop,  Aememop,Amemop,Aememop")
        (ior:SI (match_operand:SI 1 "nonimmediate_operand" "Rg,       Rg,Rg,Rg,        0,        0,     0,      0")
                (match_operand:SI 2 "nonmemory_operand"  "Is10,Konehot32, i,Rg,Konehot32,Konehot32,    Rg,     Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && ((!memory_operand(operands[0], SImode)
        && !memory_operand(operands[1], SImode))
       || (TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])))"
  "@
   %0 = or(%1,#%2)
   %0 = setbit(%1,#%J2)
   %0 = or(%1,##%2)
   %0 = or(%1,%2)
   memw(%0) = setbit(#%J2)
   memw(%E0) = setbit(#%J2)
   memw(%0) |= %2
   memw(%E0) |= %2"
  "&& !reload_completed
   && memory_operand(operands[0], SImode)
   && !qdsp6_legitimate_address_p(SImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0) (ior:SI (match_dup 0) (match_dup 2)))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], SImode, address_reg);
  }
  [(set_attr "type" "A,S,EA,A,Memop,EMemop,Memop,EMemop")]
)

(define_insn "iorsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg,       Rg,Rg")
        (ior:SI (match_operand:SI 1 "gr_register_operand" "Rg,       Rg,Rg")
                (match_operand:SI 2 "nonmemory_operand" "Is10,Konehot32,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = or(%1,#%2)
   %0 = setbit(%1,#%J2)
   %0 = or(%1,%2)"
  [(set_attr "type" "A,S,A")]
)

(define_insn "cond_iorsi3"
  [(cond_exec
     (match_operator:BI 3 "predicate_operator"
       [(match_operand:BI 4 "pr_register_operand"           "Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "gr_register_operand"        "=Rg")
          (ior:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                  (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  ""
  "if (%C3) %0 = or(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "iordi3"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (ior:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%P0 = or(%P1,%P2)"
  [(set_attr "type" "X")]
)


;;---------;;
;; xor{m}3 ;;
;;---------;;

(define_insn "xorbi3"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (xor:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                (match_operand:BI 2 "pr_register_operand" "Rp")))]
  ""
  "%0 = xor(%1,%2)"
  [(set_attr "type" "S")]
)

(define_insn "xorsi3"
  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg,Rg")
        (xor:SI (match_operand:SI 1 "gr_register_operand"      "Rg,Rg")
                (match_operand:SI 2 "nonmemory_operand" "Konehot32,Rg")))]
  ""
  "@
   %0 = togglebit(%1,#%J2)
   %0 = xor(%1,%2)"
  [(set (attr "type")
        (cond [(eq_attr "arch" "v1") (cond [(eq_attr "alternative" "0")
                                            (const_string "S")]
                                            (const_string "X"))]
                                     (cond [(eq_attr "alternative" "0")
                                            (const_string "S")]
                                            (const_string "A"))))]
)

(define_insn "cond_xorsi3"
  [(cond_exec
     (match_operator:BI 3 "predicate_operator"
       [(match_operand:BI 4 "pr_register_operand"           "Rp")
        (const_int 0)])
     (set (match_operand:SI 0 "gr_register_operand"        "=Rg")
          (xor:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                  (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  "TARGET_V2_FEATURES"
  "if (%C3) %0 = xor(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "xordi3"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (xor:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%P0 = xor(%P1,%P2)"
  [(set_attr "type" "X")]
)


;;----------;;
;; smin{m}3 ;;
;;----------;;

(define_insn "sminsi3"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg")
        (smin:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                 (match_operand:SI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = min(%1,%2)"
  [(set_attr "type" "X")]
)


(define_insn "smindi3"
  [(set (match_operand:DI 0 "gr_register_operand"         "=Rg")
        (smin:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  "TARGET_V3_FEATURES"
  "%0 = min(%1,%2)"
  [(set_attr "type" "X")]
)


;;----------;;
;; smax{m}3 ;;
;;----------;;

(define_insn "smaxsi3"
  [(set (match_operand:SI 0 "gr_register_operand"         "=Rg")
        (smax:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                 (match_operand:SI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = max(%1,%2)"
  [(set_attr "type" "X")]
)


(define_insn "smaxdi3"
  [(set (match_operand:DI 0 "gr_register_operand"         "=Rg")
        (smax:DI (match_operand:DI 1 "gr_register_operand" "Rg")
                 (match_operand:DI 2 "gr_register_operand" "Rg")))]
  "TARGET_V3_FEATURES"
  "%0 = max(%1,%2)"
  [(set_attr "type" "X")]
)


;;----------------;;
;; reduc_smin_{m} ;;
;;----------------;;


;;----------------;;
;; reduc_smax_{m} ;;
;;----------------;;


;;----------------;;
;; reduc_umin_{m} ;;
;;----------------;;


;;----------------;;
;; reduc_umax_{m} ;;
;;----------------;;


;;-----------------;;
;; reduc_splus_{m} ;;
;;-----------------;;


;;-----------------;;
;; reduc_uplus_{m} ;;
;;-----------------;;


;;-------------;;
;; vec_shl_{m} ;;
;;-------------;;


;;-------------;;
;; vec_shr_{m} ;;
;;-------------;;


;;----------;;
;; mulhisi3 ;;
;;----------;;

(define_insn "mulhisi3"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg")
        (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                 (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))]
  ""
  "%0 = mpy(%1.l,%2.l)"
  [(set_attr "type" "M")]
)


;;----------;;
;; mulqihi3 ;;
;;----------;;


;;----------;;
;; mulsidi3 ;;
;;----------;;

(define_insn "mulsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                         "=Rg")
        (mult:DI (sign_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                 (sign_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  ""
  "%P0 = mpy(%1,%2)"
  [(set_attr "type" "M")]
)


;;-----------;;
;; umulqihi3 ;;
;;-----------;;


;;-----------;;
;; umulhisi3 ;;
;;-----------;;

(define_insn "umulhisi3"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg")
        (mult:SI (zero_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                 (zero_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))]
  ""
  "%0 = mpyu(%1.l,%2.l)"
  [(set_attr "type" "M")]
)


;;-----------;;
;; umulsidi3 ;;
;;-----------;;

(define_insn "umulsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                         "=Rg")
        (mult:DI (zero_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                 (zero_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg"))))]
  ""
  "%P0 = mpyu(%1,%2)"
  [(set_attr "type" "M")]
)


;;-------------------;;
;; smul{m}3_highpart ;;
;;-------------------;;

(define_insn "smulsi3_highpart"
  [(set (match_operand:SI 0 "gr_register_operand"               "=Rg")
        (truncate:SI
          (lshiftrt:DI
            (mult:DI (sign_extend:DI
                       (match_operand:SI 1 "gr_register_operand" "Rg"))
                     (sign_extend:DI
                       (match_operand:SI 2 "gr_register_operand" "Rg")))
            (const_int 32))))]
  ""
  "%0 = mpy(%1,%2)"
  [(set_attr "type" "M")]
)


;;-------------------;;
;; umul{m}3_highpart ;;
;;-------------------;;

(define_insn "umulsi3_highpart"
  [(set (match_operand:SI 0 "gr_register_operand"               "=Rg")
        (truncate:SI
          (lshiftrt:DI
            (mult:DI (zero_extend:DI
                       (match_operand:SI 1 "gr_register_operand" "Rg"))
                     (zero_extend:DI
                       (match_operand:SI 2 "gr_register_operand" "Rg")))
            (const_int 32))))]
  ""
  "%0 = mpyu(%1,%2)"
  [(set_attr "type" "M")]
)

(define_expand "umuldi3_highpart"
  [(set (match_operand:DI 0 "gr_register_operand"              "=&Rg")
        (truncate:DI
          (lshiftrt:TI
            (mult:TI (zero_extend:TI
                       (match_operand:DI 1 "gr_register_operand" "Rg"))
                     (zero_extend:TI
                       (match_operand:DI 2 "gr_register_operand" "Rg")))
            (const_int 64))))]
  ""
  {
    rtx reg0, reg1, reg2;
    reg0 = gen_reg_rtx(DImode);
    reg1 = gen_reg_rtx(DImode);
    reg2 = gen_reg_rtx(DImode);
    emit_move_insn(gen_highpart(SImode, reg0), const0_rtx);
    emit_move_insn(gen_highpart(SImode, reg2), const0_rtx);
    emit_insn(gen_umulsi3_highpart(gen_lowpart(SImode, reg0),
                                   gen_lowpart(SImode, operands[1]),
                                   gen_lowpart(SImode, operands[2])));
    emit_insn(gen_umulsidi3(reg1, gen_lowpart(SImode, operands[1]),
                                  gen_highpart(SImode, operands[2])));
    emit_insn(gen_umacsidi3(reg0, gen_highpart(SImode, operands[1]),
                                  gen_lowpart(SImode, operands[2]),
                                  reg0));
    /* ??? The next two instructions could be combines. */
    emit_move_insn(gen_lowpart(SImode, reg2), gen_lowpart(SImode, reg1));
    emit_insn(gen_lshrdi3(operands[0], reg1, gen_int_mode(32, DImode)));
    emit_insn(gen_adddi3(reg0, reg0, reg2));
    emit_insn(gen_umacsidi3(operands[0], gen_highpart(SImode, operands[1]),
                                         gen_highpart(SImode, operands[2]),
                                         operands[0]));
    emit_insn(gen_lshrdi3_acc(operands[0], reg0,
                                           gen_int_mode(32, DImode),
                                           operands[0]));
    DONE;
  }
)


;;------------;;
;; divmod{m}4 ;;
;;------------;;


;;-------------;;
;; udivmod{m}4 ;;
;;-------------;;


;;----------;;
;; ashl{m}3 ;;
;;----------;;

(define_expand "ashlsi3"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ashift:SI (match_operand:SI 1 "nonmemory_operand" "")
                   (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
  {
    if(!TARGET_V4_FEATURES
       && !reload_completed
       && !gr_register_operand(operands[1], SImode)){
      operands[1] = force_reg(SImode, operands[1]);
    }
  }
)

(define_insn "ashlsi3_real_v4"
  [(set (match_operand:SI 0 "gr_register_operand"          "=Rg,  Rg,  Rg, Rg, Rg,Rg")
        (ashift:SI (match_operand:SI 1 "nonmemory_operand"  "Rg,  Rg,  Rg, Rg,Is6,Rg")
                   (match_operand:SI 2 "nonmemory_operand" "K16,Iu00,Iu01,Iu5, Rg,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = aslh(%1)
   %0 = %1
   %0 = add(%1,%1)
   %0 = asl(%1,#%2)
   %0 = lsl(#%1,%2)
   %0 = asl(%1,%2)"
  [(set_attr "type" "A,A,A,S,S,S")]
)

(define_insn "ashlsi3_real"
  [(set (match_operand:SI 0 "gr_register_operand"           "=Rg,  Rg,  Rg, Rg,Rg")
        (ashift:SI (match_operand:SI 1 "gr_register_operand" "Rg,  Rg,  Rg, Rg,Rg")
                   (match_operand:SI 2 "nonmemory_operand"  "K16,Iu00,Iu01,Iu5,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = aslh(%1)
   %0 = %1
   %0 = add(%1,%1)
   %0 = asl(%1,#%2)
   %0 = asl(%1,%2)"
  [(set_attr "type" "A,A,A,S,S")]
)

(define_insn "ashldi3"
  [(set (match_operand:DI 0 "gr_register_operand"           "=Rg, Rg")
        (ashift:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                   (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6")))]
  ""
  "@
   %P0 = asl(%P1,%2)
   %P0 = asl(%P1,#%2)"
  [(set_attr "type" "S,S")]
)


;;----------;;
;; ashr{m}3 ;;
;;----------;;

(define_insn "ashrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg, Rg, Rg")
        (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg, Rg")
                     (match_operand:SI 2 "nonmemory_operand"   "Rg,K16,Iu5")))]
  ""
  "@
   %0 = asr(%1,%2)
   %0 = asrh(%1)
   %0 = asr(%1,#%2)"
  [(set_attr "type" "S,A,S")]
)

(define_insn "ashrdi3"
  [(set (match_operand:DI 0 "gr_register_operand"             "=Rg, Rg, Rg")
        (ashiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg, Rg")
                     (match_operand:SI 2 "nonmemory_operand"   "Rg,K32,Iu6")))]
  ""
  "@
   %P0 = asr(%P1,%2)
   %P0 = sxtw(%H1)
   %P0 = asr(%P1,#%2)"
  [(set_attr "type" "S,X,S")]
)


;;----------;;
;; lshr{m}3 ;;
;;----------;;

(define_insn "lshrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg, Rg")
        (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                     (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu5")))]
  ""
  "@
   %0 = lsr(%1,%2)
   %0 = lsr(%1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrdi3"
  [(set (match_operand:DI 0 "gr_register_operand"             "=Rg, Rg")
        (lshiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                     (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6")))]
  ""
  "@
   %P0 = lsr(%P1,%2)
   %P0 = lsr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)


;;----------;;
;; rotl{m}3 ;;
;;----------;;


;;----------;;
;; rotr{m}3 ;;
;;----------;;


;;---------;;
;; neg{m}2 ;;
;;---------;;

(define_insn "negsi2"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg")
        (neg:SI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  ""
  "%0 = neg(%1)"
  [(set_attr "type" "A")]
)

(define_insn "negdi2"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (neg:DI (match_operand:DI 1 "gr_register_operand" "Rg")))]
  ""
  "%P0 = neg(%P1)"
  [(set_attr "type" "X")]
)


;;---------;;
;; abs{m}2 ;;
;;---------;;

(define_insn "abssi2"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg")
        (abs:SI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  ""
  "%0 = abs(%1)"
  [(set_attr "type" "X")]
)

(define_insn "absdi2"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (abs:DI (match_operand:DI 1 "gr_register_operand" "Rg")))]
  ""
  "%P0 = abs(%P1)"
  [(set_attr "type" "X")]
)


;;----------;;
;; sqrt{m}2 ;;
;;----------;;


;;---------;;
;; cos{m}2 ;;
;;---------;;


;;---------;;
;; sin{m}2 ;;
;;---------;;


;;---------;;
;; exp{m}2 ;;
;;---------;;


;;---------;;
;; log{m}2 ;;
;;---------;;


;;---------;;
;; pow{m}3 ;;
;;---------;;


;;-----------;;
;; atan2{m}3 ;;
;;-----------;;


;;-----------;;
;; floor{m}2 ;;
;;-----------;;


;;------------;;
;; btrunc{m}2 ;;
;;------------;;


;;-----------;;
;; round{m}2 ;;
;;-----------;;


;;----------;;
;; ceil{m}2 ;;
;;----------;;


;;---------------;;
;; nearbyint{m}2 ;;
;;---------------;;


;;----------;;
;; rint{m}2 ;;
;;----------;;


;;--------------;;
;; copysign{m}3 ;;
;;--------------;;


;;---------;;
;; ffs{m}2 ;;
;;---------;;


;;---------;;
;; clz{m}2 ;;
;;---------;;

(define_insn "clzsi2"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg")
        (clz:SI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  ""
  "%0 = cl0(%1)"
  [(set_attr "type" "S")]
)


;;---------;;
;; ctz{m}2 ;;
;;---------;;

(define_insn "ctzsi2"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg")
        (ctz:SI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  "TARGET_V2_FEATURES"
  "%0 = ct0(%1)"
  [(set_attr "type" "S")]
)


;;--------------;;
;; popcount{m}2 ;;
;;--------------;;


;;------------;;
;; parity{m}2 ;;
;;------------;;


;;--------------;;
;; one_cmpl{m}2 ;;
;;--------------;;

(define_insn "one_cmplbi2"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (not:BI (match_operand:BI 1 "pr_register_operand" "Rp")))]
  ""
  "%0 = not(%1)"
  [(set_attr "type" "S")]
)

(define_insn "one_cmplsi2"
  [(set (match_operand:SI 0 "gr_register_operand"        "=Rg")
        (not:SI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  ""
  "%0 = not(%1)"
  [(set (attr "type")
        (cond [(eq_attr "arch" "v1") (const_string "X")]
                                     (const_string "A")))]
)

(define_insn "one_cmpldi2"
  [(set (match_operand:DI 0 "gr_register_operand"        "=Rg")
        (not:DI (match_operand:DI 1 "gr_register_operand" "Rg")))]
  ""
  "%P0 = not(%P1)"
  [(set_attr "type" "X")]
)


;;--------;;
;; cmp{m} ;;
;;--------;;

(define_expand "cmpbi"
  [(match_operand:BI 0 "pr_register_operand" "")
   (match_operand:BI 1 "const_int_operand" "")]
  ""
  {
    cfun->machine->compare_op0 = operands[0];
    cfun->machine->compare_op1 = operands[1];
    DONE;
  }
)

;; Note, we store the operands in the comparison insns, and use them later
;; when generating the branch or movcc operation.

;; First the standard name generated by the machine independent part of the
;; compiler

(define_expand "cmpsi"
  [(match_operand:SI 0 "gr_register_operand" "")
   (match_operand:SI 1 "nonmemory_operand" "")]
  ""
  {
    cfun->machine->compare_op0 = operands[0];
    cfun->machine->compare_op1 = operands[1];
    DONE;
  }
)

;; Now, the actual comparisons, generated by the branch and/or movcc operations

(define_insn "cmpsi_eq_v4"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,  Rp,Rp,Rp")
        (eq:BI (match_operand:SI 1 "gr_register_operand" "Rg,  Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand" " Iu2,Is10, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = cmp.eq(%1,#%2)
   %0 = cmp.eq(%1,#%2)
   %0 = cmp.eq(%1,##%2)
   %0 = cmp.eq(%1,%2)"
  [(set_attr "type" "A,A,EA,A")
   (set_attr "duplex" "yes,no,no,no")]
)

(define_insn "cmpsi_gt_v4"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp,Rp")
        (gt:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand" "Is10, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = cmp.gt(%1,#%2)
   %0 = cmp.gt(%1,##%2)
   %0 = cmp.gt(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpsi_ge_v4"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (ge:BI (match_operand:SI 1 "gr_register_operand"   "Rg,Rg")
               (match_operand:SI 2 "immediate_operand" "Ks10p1, i")))]
  "TARGET_V4_FEATURES
   && (crtl->combine_in_progress || crtl->combine_completed)"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = cmp.gt(%1,#%2)";
    }
    else {
      return "%0 = cmp.gt(%1,##%2)";
    }
  }
  [(set_attr "type" "A,EA")]
)

(define_insn "cmpsi_gtu_v4"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp,Rp,Rp")
        (gtu:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
                (match_operand:SI 2 "nonmemory_operand"  "Iu9, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || u9_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = cmp.gtu(%1,#%2)
   %0 = cmp.gtu(%1,##%2)
   %0 = cmp.gtu(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpsi_geu_v4"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (geu:BI (match_operand:SI 1 "gr_register_operand"  "Rg,Rg")
                (match_operand:SI 2 "immediate_operand" "Ku9p1, i")))]
  "TARGET_V4_FEATURES
   && (crtl->combine_in_progress || crtl->combine_completed)"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = cmp.gtu(%1,#%2)";
    }
    else {
      return "%0 = cmp.gtu(%1,##%2)";
    }
  }
  [(set_attr "type" "A,EA")]
)

(define_insn "cmpsi_ne"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp,Rp")
        (ne:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand" "Is10, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = !cmp.eq(%1,#%2)
   %0 = !cmp.eq(%1,##%2)
   %0 = !cmp.eq(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpsi_le"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp,Rp")
        (le:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand" "Is10, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || s10_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = !cmp.gt(%1,#%2)
   %0 = !cmp.gt(%1,##%2)
   %0 = !cmp.gt(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpsi_lt_v4"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (lt:BI (match_operand:SI 1 "gr_register_operand"   "Rg,Rg")
               (match_operand:SI 2 "immediate_operand" "Ks10p1, i")))]
  "TARGET_V4_FEATURES
   && (crtl->combine_in_progress || crtl->combine_completed)"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = !cmp.gt(%1,#%2)";
    }
    else {
      return "%0 = !cmp.gt(%1,##%2)";
    }
  }
  [(set_attr "type" "A,EA")]
)

(define_insn "cmpsi_leu"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp,Rp,Rp")
        (leu:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
                (match_operand:SI 2 "nonmemory_operand"  "Iu9, i,Rg")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[2], SImode)
       || u9_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = !cmp.gtu(%1,#%2)
   %0 = !cmp.gtu(%1,##%2)
   %0 = !cmp.gtu(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpsi_ltu_v4"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (ltu:BI (match_operand:SI 1 "gr_register_operand"  "Rg,Rg")
                (match_operand:SI 2 "immediate_operand" "Ku9p1, i")))]
  "TARGET_V4_FEATURES
   && (crtl->combine_in_progress || crtl->combine_completed)"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = !cmp.gtu(%1,#%2)";
    }
    else {
      return "%0 = !cmp.gtu(%1,##%2)";
    }
  }
  [(set_attr "type" "A,EA")]
)

(define_insn "cmpsi_eq_imm"
  [(set (match_operand:BI 0 "pr_register_operand"           "=Rp,Rp")
        (eq:BI (match_operand:SI 1 "gr_register_operand"     "Rg,Rg")
               (match_operand:SI 2 "s10_const_int_operand" "Is10,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = cmp.eq(%1,#%2)
   %0 = cmp.eq(%1,%2)"
  [(set_attr "type" "A,A")]
)

(define_insn "cmpsi_gt_imm"
  [(set (match_operand:BI 0 "pr_register_operand"           "=Rp,Rp")
        (gt:BI (match_operand:SI 1 "gr_register_operand"     "Rg,Rg")
               (match_operand:SI 2 "s10_const_int_operand" "Is10,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = cmp.gt(%1,#%2)
   %0 = cmp.gt(%1,%2)"
  [(set_attr "type" "A,A")]
)

(define_insn "cmpsi_gtu_imm"
  [(set (match_operand:BI 0 "pr_register_operand"          "=Rp,Rp")
        (gtu:BI (match_operand:SI 1 "gr_register_operand"   "Rg,Rg")
                (match_operand:SI 2 "u9_const_int_operand" "Iu9,Rg")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = cmp.gtu(%1,#%2)
   %0 = cmp.gtu(%1,%2)"
  [(set_attr "type" "A,A")]
)

(define_insn "cmpsi_eq"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (eq:BI (match_operand:SI 1 "gr_register_operand" "Rg")
               (match_operand:SI 2 "gr_register_operand" "Rg")))]
  "!TARGET_V4_FEATURES"
  "%0 = cmp.eq(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "cmpsi_gt"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (gt:BI (match_operand:SI 1 "gr_register_operand" "Rg")
               (match_operand:SI 2 "gr_register_operand" "Rg")))]
  "!TARGET_V4_FEATURES"
  "%0 = cmp.gt(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "cmpsi_gtu"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (gtu:BI (match_operand:SI 1 "gr_register_operand" "Rg")
                (match_operand:SI 2 "gr_register_operand" "Rg")))]
  "!TARGET_V4_FEATURES"
  "%0 = cmp.gtu(%1,%2)"
  [(set_attr "type" "A")]
)

(define_insn "cmpsi_ne_zero"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (ne:BI (match_operand:SI 1 "gr_register_operand" "Rg")
               (const_int 0)))]
  "!TARGET_V4_FEATURES"
  "%0 = cmp.gtu(%1,#0)  // %1 != 0"
  [(set_attr "type" "A")]
)

(define_expand "cmpdi"
  [(match_operand:DI 0 "gr_register_operand" "")
   (match_operand:DI 1 "gr_register_operand" "")]
  ""
  {
    cfun->machine->compare_op0 = operands[0];
    cfun->machine->compare_op1 = operands[1];
    DONE;
  }
)

(define_insn "cmpdi_eq"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (eq:BI (match_operand:DI 1 "gr_register_operand" "Rg")
               (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = cmp.eq(%P1,%P2)"
  [(set_attr "type" "X")]
)

(define_insn "cmpdi_gt"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (gt:BI (match_operand:DI 1 "gr_register_operand" "Rg")
               (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = cmp.gt(%P1,%P2)"
  [(set_attr "type" "X")]
)

(define_insn "cmpdi_gtu"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp")
        (gtu:BI (match_operand:DI 1 "gr_register_operand" "Rg")
                (match_operand:DI 2 "gr_register_operand" "Rg")))]
  ""
  "%0 = cmp.gtu(%P1,%P2)"
  [(set_attr "type" "X")]
)


;;--------;;
;; tst{m} ;;
;;--------;;


;;-----------;;
;; movmem{m} ;;
;;-----------;;

(define_expand "movmemsi"
  [(use (match_operand:BLK 0 "memory_operand" ""))
   (use (match_operand:BLK 1 "memory_operand" ""))
   (use (match_operand:SI 2 "nonmemory_operand" ""))
   (use (match_operand:SI 3 "const_int_operand" ""))
   (use (match_operand:SI 4 "const_int_operand" ""))
   (use (match_operand:SI 5 "const_int_operand" ""))
   (use (match_operand:SI 6 "const_int_operand" ""))]
  ""
  {
    if(qdsp6_expand_movmem(operands)){
      DONE;
    }
    else {
      FAIL;
    }
  }
)


;;--------;;
;; movstr ;;
;;--------;;


;;-----------;;
;; setmem{m} ;;
;;-----------;;

(define_expand "setmemsi"
  [(use (match_operand:BLK 0 "memory_operand" ""))
   (use (match_operand:SI 1 "const_int_operand" ""))
   (use (match_operand:SI 2 "const_int_operand" ""))
   (use (match_operand:SI 3 "const_int_operand" ""))
   (use (match_operand:SI 4 "const_int_operand" ""))
   (use (match_operand:SI 5 "const_int_operand" ""))]
  "optimize && !optimize_size"
  {
    if(qdsp6_expand_setmem(operands)){
      DONE;
    }
    else {
      FAIL;
    }
  }
)


;;------------;;
;; cmpstrn{m} ;;
;;------------;;


;;-----------;;
;; cmpstr{m} ;;
;;-----------;;

;;(define_expand "cmpstrsi"
;;  [(use (match_operand:SI 0 "gr_register_operand" ""))
;;   (use (match_operand:BLK 1 "memory_operand" ""))
;;   (use (match_operand:BLK 2 "memory_operand" ""))
;;   (use (match_operand 3 "general_operand" ""))
;;   (use (match_operand:SI 4 "const_int_operand" ""))]
;;  "optimize && !optimize_size"
;;  {
;;    fprintf(stderr, "\ncmpSTRsi\n");
;;    if(qdsp6_expand_cmpstr(operands)){
;;      DONE;
;;    }
;;    else {
;;      FAIL;
;;    }
;;  }
;;)


;;-----------;;
;; cmpmem{m} ;;
;;-----------;;

;;(define_expand "cmpmemsi"
;;  [(use (match_operand:SI 0 "gr_register_operand" ""))
;;   (use (match_operand:BLK 1 "memory_operand" ""))
;;   (use (match_operand:BLK 2 "memory_operand" ""))
;;   (use (match_operand 3 "general_operand" ""))
;;   (use (match_operand:SI 4 "const_int_operand" ""))]
;;  "optimize && !optimize_size"
;;  {
;;    fprintf(stderr, "\ncmpMEMsi\n");
;;    if(qdsp6_expand_cmpstr(operands)){
;;      DONE;
;;    }
;;    else {
;;      FAIL;
;;    }
;;  }
;;)


;;-----------;;
;; strlen{m} ;;
;;-----------;;

;;(define_expand "strlensi"
;;  [(use (match_operand:SI 0 "gr_register_operand" ""))
;;   (use (match_operand:BLK 1 "memory_operand" ""))
;;   (use (match_operand:QI 2 "const_int_operand" ""))
;;   (use (match_operand:SI 3 "const_int_operand" ""))]
;;  "optimize && !optimize_size"
;;  {
;;    if(qdsp6_expand_strlen(operands)){
;;      DONE;
;;    }
;;    else {
;;      FAIL;
;;    }
;;  }
;;)


;;--------------;;
;; float{m}{n}2 ;;
;;--------------;;


;;-----------------;;
;; floatuns{m}{n}2 ;;
;;-----------------;;


;;------------;;
;; fix{m}{n}2 ;;
;;------------;;


;;---------------;;
;; fixuns{m}{n}2 ;;
;;---------------;;


;;------------;;
;; ftrunc{m}2 ;;
;;------------;;


;;------------------;;
;; fix_trunc{m}{n}2 ;;
;;------------------;;


;;---------------------;;
;; fixuns_trunc{m}{n}2 ;;
;;---------------------;;


;;--------------;;
;; trunc{m}{n}2 ;;
;;--------------;;

;;(define_insn "truncdisi2"
;;  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg")
;;        (truncate:SI (match_operand:DI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %L1"
;;  [(set_attr "type" "A")]
;;)
;;
;;(define_insn "truncdihi2"
;;  [(set (match_operand:HI 0 "gr_register_operand"             "=Rg")
;;        (truncate:HI (match_operand:DI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %L1"
;;  [(set_attr "type" "A")]
;;)
;;
;;(define_insn "truncdiqi2"
;;  [(set (match_operand:QI 0 "gr_register_operand"             "=Rg")
;;        (truncate:QI (match_operand:DI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %L1"
;;  [(set_attr "type" "A")]
;;)
;;
;;(define_insn "truncsihi2"
;;  [(set (match_operand:HI 0 "gr_register_operand"             "=Rg")
;;        (truncate:HI (match_operand:SI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %1"
;;  [(set_attr "type" "A")]
;;)
;;
;;(define_insn "truncsiqi2"
;;  [(set (match_operand:QI 0 "gr_register_operand"             "=Rg")
;;        (truncate:QI (match_operand:SI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %1"
;;  [(set_attr "type" "A")]
;;)

;;(define_insn "truncsibi2"
;;  [(set (match_operand:BI 0 "register_operand"                "=Rp,Rg")
;;        (truncate:BI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")))]
;;  ""
;;  "@
;;   %0 = %1
;;   %0 = extractu(%1,#1,#0)"
;;  [(set_attr "type" "S,S")]
;;)

;;(define_insn "trunchiqi2"
;;  [(set (match_operand:QI 0 "gr_register_operand"             "=Rg")
;;        (truncate:QI (match_operand:HI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = %1"
;;  [(set_attr "type" "A")]
;;)


;;---------------;;
;; extend{m}{n}2 ;;
;;---------------;;

;; char -> int
(define_insn "extendqisi2"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,  Rg,    Rg,Rg")
        (sign_extend:SI (match_operand:QI 1 "nonimmediate_operand_with_GP" "Rg,Adm3,Anoext, m")))]
  ""
  "@
   %0 = sxtb(%1)
   %0 = memb(%1)
   %0 = memb(%1)
   %0 = memb(%E1)"
  [(set_attr "type" "A,Load,Load,ELoad")
   (set_attr "duplex" "yes,yes,no,no")]
)

(define_insn_and_split "extendqidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                 "=Rg,Rg")
        (sign_extend:DI (match_operand:QI 1 "nonimmediate_operand" "Rg, m")))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 2) (sign_extend:SI (match_dup 1)))
   (set (match_dup 0) (sign_extend:DI (match_dup 2)))]
  {
    operands[2] = gen_lowpart(SImode, operands[0]);
  }
  [(set_attr "type" "multiple,multiple")]
)

;; short -> int
(define_insn "extendhisi2"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,  Rg,    Rg,Rg")
        (sign_extend:SI (match_operand:HI 1 "nonimmediate_operand_with_GP" "Rg,Adm3,Anoext, m")))]
  ""
  "@
   %0 = sxth(%1)
   %0 = memh(%1)
   %0 = memh(%1)
   %0 = memh(%E1)"
  [(set_attr "type"   "A,Load,Load,ELoad")
   (set_attr "duplex" "yes,yes,no,no")]
)

;; short -> long long
(define_insn_and_split "extendhidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                 "=Rg,Rg")
        (sign_extend:DI (match_operand:HI 1 "nonimmediate_operand" "Rg, m")))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 2) (sign_extend:SI (match_dup 1)))
   (set (match_dup 0) (sign_extend:DI (match_dup 2)))]
  {
    operands[2] = gen_lowpart(SImode, operands[0]);
  }
  [(set_attr "type" "multiple,multiple")]
)

(define_insn "extendsidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                "=Rg")
        (sign_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg")))]
  ""
  "%P0 = sxtw(%1)"
  [(set_attr "type" "X")]
)


;;--------------------;;
;; zero_extend{m}{n}2 ;;
;;--------------------;;

;;(define_insn "zero_extendbisi2"
;;  [(set (match_operand:SI 0 "gr_register_operand"                "=Rg")
;;        (zero_extend:SI (match_operand:BI 1 "gr_register_operand" "Rg")))]
;;  ""
;;  "%0 = extractu(%1,#1,#0)"
;;  [(set_attr "type" "S")]
;;)

;; char -> int
(define_insn "zero_extendqisi2"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,  Rg,    Rg,Rg,?Rg")
        (zero_extend:SI (match_operand:QI 1 "nonimmediate_operand_with_GP" "Rg,Adm4,Anoext, m,*Rp")))]
  ""
  "@
   %0 = zxtb(%1)
   %0 = memub(%1)
   %0 = memub(%1)
   %0 = memub(%E1)
   %0 = %1"
  [(set_attr "type" "A,Load,Load,ELoad,S")
   (set_attr "duplex" "yes,yes,no,no,no")]
)

;; char -> long long
(define_insn_and_split "zero_extendqidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                 "=Rg,Rg")
        (zero_extend:DI (match_operand:QI 1 "nonimmediate_operand" "Rg, m")))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 2) (zero_extend:SI (match_dup 1)))
   (set (match_dup 3) (const_int 0))]
  {
    operands[2] = gen_lowpart(SImode, operands[0]);
    operands[3] = gen_highpart(SImode, operands[0]);
  }
  [(set_attr "type" "multiple,multiple")]
)
;; short -> int
(define_insn "zero_extendhisi2"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,  Rg,     Rg,Rg")
        (zero_extend:SI (match_operand:HI 1 "nonimmediate_operand_with_GP" "Rg,Adm3,Anoext, m")))]
  ""
  "@
   %0 = zxth(%1)
   %0 = memuh(%1)
   %0 = memuh(%1)
   %0 = memuh(%E1)"
  [(set_attr "type" "A,Load,Load,ELoad")
   (set_attr "duplex" "yes,yes,no,no")]
)

;; short -> long long
(define_insn_and_split "zero_extendhidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                 "=Rg,Rg")
        (zero_extend:DI (match_operand:HI 1 "nonimmediate_operand" "Rg, m")))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 2) (zero_extend:SI (match_dup 1)))
   (set (match_dup 3) (const_int 0))]
  {
    operands[2] = gen_lowpart(SImode, operands[0]);
    operands[3] = gen_highpart(SImode, operands[0]);
  }
  [(set_attr "type" "multiple,multiple")]
)

;; int/long -> long long
(define_insn_and_split "zero_extendsidi2"
  [(set (match_operand:DI 0 "gr_register_operand"                 "=Rg,Rg")
        (zero_extend:DI (match_operand:SI 1 "nonimmediate_operand" "Rg, m")))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 2) (match_dup 1))
   (set (match_dup 3) (const_int 0))]
  {
    operands[2] = gen_lowpart(SImode, operands[0]);
    operands[3] = gen_highpart(SImode, operands[0]);
  }
  [(set_attr "type" "multiple,multiple")]
)


;;------;;
;; extv ;;
;;------;;


;;-------;;
;; extzv ;;
;;-------;;

(define_insn "extzv"
  [(set (match_operand:SI 0 "gr_register_operand"                   "=Rg")
        (zero_extract:SI (match_operand:SI 1 "gr_register_operand"   "Rg")
                         (match_operand:SI 2 "u5_const_int_operand" "Iu5")
                         (match_operand:SI 3 "u5_const_int_operand" "Iu5")))]
  ""
  "%0 = extractu(%1,#%2,#%3)"
  [(set_attr "type" "S")]
)


;;------;;
;; insv ;;
;;------;;

(define_insn "insv"
  [(set (zero_extract:SI (match_operand:SI 0 "gr_register_operand"  "+Rg")
                         (match_operand:SI 1 "u5_const_int_operand" "Iu5")
                         (match_operand:SI 2 "u5_const_int_operand" "Iu5"))
        (match_operand:SI 3 "gr_register_operand"                    "Rg"))]
  ""
  "%0 = insert(%3,#%1,#%2)"
  [(set_attr "type" "S")]
)


;;-------------;;
;; mov{mode}cc ;;
;;-------------;;


(define_expand "movsicc"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_operand 1 "comparison_operator" "")
                         (match_operand:SI 2 "nonmemory_operand" "")
                         (match_operand:SI 3 "nonmemory_operand" "")))]
  ""
  {
    rtx reg;
    operands[1] = qdsp6_expand_compare(GET_CODE (operands[1]));
    if(!TARGET_V2_FEATURES && !reload_completed){
      reg = gen_reg_rtx(SImode);
      emit_move_insn(reg, operands[2]);
      operands[2] = reg;
      reg = gen_reg_rtx(SImode);
      emit_move_insn(reg, operands[3]);
      operands[3] = reg;
    }
  }
)

(define_insn "muxtsi_v4"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg, Rg,Rg, Rg,Rg, Rg")
        (if_then_else:SI
          (ne:BI
            (match_operand:BI 1 "pr_register_operand" "Rp, Rp,Rp, Rp,Rp, Rp")
            (const_int 0))
          (match_operand:SI 2 "nonmemory_operand"     "Rg, Rg,Rg,Is8, i,Is8")
          (match_operand:SI 3 "nonmemory_operand"     "Rg,Is8, i, Rg,Rg,Is8")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[1], SImode)
       || s8_const_int_operand(operands[1], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && (!immediate_operand(operands[2], SImode)
       || s8_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = mux(%1,%2,%3)
   %0 = mux(%1,%2,#%3)
   %0 = mux(%1,%2,##%3)
   %0 = mux(%1,#%2,%3)
   %0 = mux(%1,##%2,%3)
   %0 = mux(%1,#%2,#%3)"
  [(set_attr "type" "A,A,EA,A,EA,A")]
)

(define_insn "muxfsi_v4"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg, Rg,Rg, Rg,Rg, Rg")
        (if_then_else:SI
          (eq:BI
            (match_operand:BI 1 "pr_register_operand" "Rp, Rp,Rp, Rp,Rp, Rp")
            (const_int 0))
          (match_operand:SI 2 "nonmemory_operand"     "Rg,Is8, i, Rg,Rg,Is8")
          (match_operand:SI 3 "nonmemory_operand"     "Rg, Rg,Rg,Is8, i,Is8")))]
  "TARGET_V4_FEATURES
   && (!immediate_operand(operands[1], SImode)
       || s8_const_int_operand(operands[1], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)
   && (!immediate_operand(operands[2], SImode)
       || s8_const_int_operand(operands[2], SImode)
       || crtl->combine_in_progress || crtl->combine_completed)"
  "@
   %0 = mux(%1,%3,%2)
   %0 = mux(%1,%3,#%2)
   %0 = mux(%1,%3,##%2)
   %0 = mux(%1,#%3,%2)
   %0 = mux(%1,##%3,%2)
   %0 = mux(%1,#%3,#%2)"
  [(set_attr "type" "A,A,EA,A,EA,A")]
)

(define_insn "muxtsi"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg, Rg, Rg, Rg")
        (if_then_else:SI
          (ne:BI
            (match_operand:BI 1 "pr_register_operand" "Rp, Rp, Rp, Rp")
            (const_int 0))
          (match_operand:SI 2 "nonmemory_operand"     "Rg, Rg,Is8,Is8")
          (match_operand:SI 3 "nonmemory_operand"     "Rg,Is8, Rg,Is8")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = mux(%1,%2,%3)
   %0 = mux(%1,%2,#%3)
   %0 = mux(%1,#%2,%3)
   %0 = mux(%1,#%2,#%3)"
  [(set_attr "type" "A,A,A,A")]
)

(define_insn "muxfsi"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg, Rg, Rg, Rg")
        (if_then_else:SI
          (eq:BI
            (match_operand:BI 1 "pr_register_operand" "Rp, Rp, Rp, Rp")
            (const_int 0))
          (match_operand:SI 2 "nonmemory_operand"     "Rg,Is8, Rg,Is8")
          (match_operand:SI 3 "nonmemory_operand"     "Rg, Rg,Is8,Is8")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 = mux(%1,%3,%2)
   %0 = mux(%1,%3,#%2)
   %0 = mux(%1,#%3,%2)
   %0 = mux(%1,#%3,#%2)"
  [(set_attr "type" "A,A,A,A")]
)


;;-------------;;
;; add{mode}cc ;;
;;-------------;;


;;---------;;
;; s{cond} ;;
;;---------;;

(define_expand "seq"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(EQ);
  }
)

(define_expand "sne"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(NE);
  }
)

(define_expand "slt"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LT);
  }
)

(define_expand "sle"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LE);
  }
)

(define_expand "sgt"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GT);
  }
)

(define_expand "sge"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GE);
  }
)

;; Unsigned versions

(define_expand "sltu"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LTU);
  }
)

(define_expand "sleu"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LEU);
  }
)

(define_expand "sgtu"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GTU);
  }
)

(define_expand "sgeu"
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (if_then_else:SI (match_dup 1) (const_int 1) (const_int 0)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GEU);
  }
)


;;---------;;
;; b{cond} ;;
;;---------;;

;; define_expands called by the machine independent part of the compiler
;; to allocate a new comparison register

(define_expand "beq"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(EQ);
  }
)

(define_expand "bne"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(NE);
  }
)

(define_expand "blt"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LT);
  }
)

(define_expand "ble"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LE);
  }
)

(define_expand "bgt"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GT);
  }
)

(define_expand "bge"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GE);
  }
)

;; Unsigned versions

(define_expand "bltu"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LTU);
  }
)

(define_expand "bleu"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(LEU);
  }
)

(define_expand "bgtu"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GTU);
  }
)

(define_expand "bgeu"
  [(set (pc)
        (if_then_else (match_dup 1)
                      (label_ref (match_operand 0 "" ""))
                      (pc)))]
  ""
  {
    operands[1] = qdsp6_expand_compare(GEU);
  }
)


;; Now, the actual branch instruction


;; GPR conditional jump introduced in v3

(define_insn "gpr_cond_jump"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "gpr_cond_jump_operator"
                        [(match_operand:SI 1 "gr_register_operand" "*Rg")
                         (const_int 0)])
                      (label_ref (match_operand 2 "" ""))
                      (pc)))]
  "TARGET_V3_FEATURES && !TARGET_V4_FEATURES"
  {
    rtx prediction;
    int predict_taken = 0;
    prediction = find_reg_note(insn, REG_BR_PROB, 0);
    predict_taken = (prediction && INTVAL (XEXP (prediction, 0)) > REG_BR_PROB_BASE / 2);

#define QDSP6_FIXUP_GPR_JUMP(string) ((get_attr_length(insn) == 4) \
                                      ? string \
                                      : "jump %l4\n%l2:\;jump %l3\n%l4:\;" string)

    if(get_attr_length(insn) != 4){
      /* Create a new label and swap that with the real target. */
      operands[3] = operands[2];
      operands[2] = gen_label_rtx();
      operands[4] = gen_label_rtx();
    }

    if(GET_CODE(operands[0]) == EQ){
      if(predict_taken){
        return QDSP6_FIXUP_GPR_JUMP("if (%1==#0) jump:t %l2");
      }
      else {
        return QDSP6_FIXUP_GPR_JUMP("if (%1==#0) jump:nt %l2");
      }
    }
    else if(GET_CODE(operands[0]) == NE){
      if(predict_taken){
        return QDSP6_FIXUP_GPR_JUMP("if (%1!=#0) jump:t %l2");
      }
      else {
        return QDSP6_FIXUP_GPR_JUMP("if (%1!=#0) jump:nt %l2");
      }
    }
    else if(GET_CODE(operands[0]) == GE){
      if(predict_taken){
        return QDSP6_FIXUP_GPR_JUMP("if (%1>=#0) jump:t %l2");
      }
      else {
        return QDSP6_FIXUP_GPR_JUMP("if (%1>=#0) jump:nt %l2");
      }
    }
    else if(GET_CODE(operands[0]) == LE){
      if(predict_taken){
        return QDSP6_FIXUP_GPR_JUMP("if (%1<=#0) jump:t %l2");
      }
      else {
        return QDSP6_FIXUP_GPR_JUMP("if (%1<=#0) jump:nt %l2");
      }
    }
    else {
      gcc_unreachable();
    }

  }
  [(set (attr "type")
        (if_then_else (eq_attr "length" "4")
                      (const_string "CR")
                      (const_string "multiple")))
   (set (attr "length")
        (if_then_else (le (abs (minus (match_dup 2) (pc))) (const_int 15000))
                      (const_string "4")
                      (const_string "12")))]
)

(define_insn "cond_jump"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "predicate_operator"
                        [(match_operand:BI 1 "pr_register_operand" "Rp")
                         (const_int 0)])
                      (label_ref (match_operand 2 "" ""))
                      (pc)))]
  ""
  {
    rtx prediction;
    if(get_attr_length(insn) == 4){
      operands[3] = qdsp6_branch_hint(insn);
      return "if (%C0) jump%h3 %l2";
    }
    else {
      operands[3] = gen_label_rtx();
      return "if (%I0) jump %l3\;jump %l2\n%l3:";
    }
  }
  [(set (attr "type")
        (if_then_else (eq_attr "length" "4")
                      (const_string "J")
                      (const_string "multiple")))
   (set (attr "length")
        (if_then_else (le (abs (minus (match_dup 2) (pc))) (const_int 50000))
                      (const_string "4")
                      (const_string "8")))]
)


(define_insn "compoundnvjump"
  [(set (pc)
        (if_then_else (match_operator:SI 0 "comparison_operator"
                        [(match_operand:SI 1 "nonmemory_operand" "Rg")
                         (match_operand:SI 2 "nonmemory_operand"  "i")])
                      (label_ref (match_operand 3 "" ""))
                      (pc)))
   (clobber (match_scratch:BI 4 "=Rp"))]
	"TARGET_V4_FEATURES"
	{
		return "{ %4 = cmp.eq(%1,%2); if (!%4.new) jump:nt %l3 }";
	}
  [(set_attr "type" "multiple")]
)
 
;;----------------;;
;; cbranch{mode}4 ;;
;;----------------;;

(define_insn "cbranchsi4"
  [(set (pc)
        (if_then_else (match_operator:SI 0 "comparison_operator"
                        [(match_operand:SI 1 "nonmemory_operand" "Rg,Rg")
                         (match_operand:SI 2 "nonmemory_operand"  "i,Rg")])
                      (label_ref (match_operand 3 "" ""))
                      (pc)))
   (clobber (match_scratch:BI 4 "=Rp,Rp"))]
  "TARGET_COMPRESSED"
  {
    rtx op0 = operands[1];
    rtx op1 = operands[2];
    enum rtx_code code = GET_CODE (operands[0]), compare_code, jump_code;
    int offset = 0;
    bool swap = false;

    if(REG_P (op1) || GET_CODE (op1) == SUBREG){
      switch(code){
        case EQ:
          compare_code = EQ; jump_code = NE; break;
        case NE:
          compare_code = EQ; jump_code = EQ; break;

        /* Signed compares */
        case LT:
          compare_code = GT; jump_code = NE; swap = true; break;
        case LE:
          compare_code = GT; jump_code = EQ; break;
        case GT:
          compare_code = GT; jump_code = NE; break;
        case GE:
          compare_code = GT; jump_code = EQ; swap = true; break;

        /* Unsigned compares */
        case LTU:
          compare_code = GTU; jump_code = NE; swap = true; break;
        case LEU:
          compare_code = GTU; jump_code = EQ; break;
        case GTU:
          compare_code = GTU; jump_code = NE; break;
        case GEU:
          compare_code = GTU; jump_code = EQ; swap = true; break;

        default:
          gcc_unreachable();
      }

      if(swap){
        op0 = operands[2];
        op1 = operands[1];
      }
    }
    else {
      switch(code){
        case EQ:
          compare_code = EQ; jump_code = NE; break;
        case NE:
          compare_code = EQ; jump_code = EQ; break;

        /* Signed compares */
        case LT:
          compare_code = GT; jump_code = EQ; offset = -1; break;
        case LE:
          compare_code = GT; jump_code = EQ; break;
        case GT:
          compare_code = GT; jump_code = NE; break;
        case GE:
          compare_code = GT; jump_code = NE; offset = -1; break;

        /* Unsigned compares */
        case LTU:
          compare_code = GTU; jump_code = EQ; offset = -1; break;
        case LEU:
          compare_code = GTU; jump_code = EQ; break;
        case GTU:
          compare_code = GTU; jump_code = NE; break;
        case GEU:
          compare_code = GTU; jump_code = NE; offset = -1; break;

        default:
          gcc_unreachable();
      }

      if(offset != 0){
        op1 = plus_constant(op1, offset);
      }
    }

    operands[1] = op0;
    operands[2] = op1;

    if(GET_CODE (op1) == CONST_INT
       && INTVAL (op1) >= (compare_code == GTU ? 0 : -512)
       && INTVAL (op1) <= 511){
      switch(compare_code){
        case EQ:
          return jump_code == NE ? "{ %4 = cmp.eq(%1,#%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.eq(%1,#%2); if (!%4.new) jump:nt %l3 }";
        case GT:
          return jump_code == NE ? "{ %4 = cmp.gt(%1,#%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gt(%1,#%2); if (!%4.new) jump:nt %l3 }";
        case GTU:
          return jump_code == NE ? "{ %4 = cmp.gtu(%1,#%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gtu(%1,#%2); if (!%4.new) jump:nt %l3 }";
        default:
          gcc_unreachable();
      }
    }
    else if(CONSTANT_P (op1)){
      switch(compare_code){
        case EQ:
          return jump_code == NE ? "{ %4 = cmp.eq(%1,##%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.eq(%1,##%2); if (!%4.new) jump:nt %l3 }";
        case GT:
          return jump_code == NE ? "{ %4 = cmp.gt(%1,##%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gt(%1,##%2); if (!%4.new) jump:nt %l3 }";
        case GTU:
          return jump_code == NE ? "{ %4 = cmp.gtu(%1,##%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gtu(%1,##%2); if (!%4.new) jump:nt %l3 }";
        default:
          gcc_unreachable();
      }
    }
    else {
      switch(compare_code){
        case EQ:
          return jump_code == NE ? "{ %4 = cmp.eq(%1,%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.eq(%1,%2); if (!%4.new) jump:nt %l3 }";
        case GT:
          return jump_code == NE ? "{ %4 = cmp.gt(%1,%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gt(%1,%2); if (!%4.new) jump:nt %l3 }";
        case GTU:
          return jump_code == NE ? "{ %4 = cmp.gtu(%1,%2); if (%4.new) jump:nt %l3 }"
                                 : "{ %4 = cmp.gtu(%1,%2); if (!%4.new) jump:nt %l3 }";
        default:
          gcc_unreachable();
      }
    }
  }
  [(set_attr "type" "multiple")]
)


;;------;;
;; jump ;;
;;------;;

(define_insn "jump"
  [(set (pc) (label_ref (match_operand 0 "" "")))]
  ""
  "jump %0"
  [(set_attr "type" "J")]
)


;;------;;
;; call ;;
;;------;;

(define_expand "call"
  [(parallel [(call (match_operand:HI 0 "memory_operand" "m")
                    (match_operand 1 "" ""))
              (clobber (reg:SI LINK_REGNUM))])]
  ""
  {
    if(TARGET_LONG_CALLS && !REG_P (XEXP (operands[0], 0))){
      XEXP (operands[0], 0) = force_reg(Pmode, XEXP (operands[0], 0));
    }
  }
)

(define_insn "call_pc_relative"
  [(call (mem:HI (match_operand:SI 0 "call_target_operand" "Q,?Rg"))
         (match_operand 1 "" ""))
   (clobber (reg:SI LINK_REGNUM))]
  "!TARGET_LONG_CALLS"
  "@
   call %0
   callr %0"
  [(set_attr "type" "J,JR")]
)

(define_insn "call_register"
  [(call (mem:HI (match_operand:SI 0 "gr_register_operand" "Rg"))
         (match_operand 1 "" ""))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "callr %0"
  [(set_attr "type" "JR")]
)

(define_expand "sibcall"
  [(parallel [(call (match_operand:HI 0 "memory_operand" "m")
                    (match_operand 1 "" ""))
              (return)])]
  "!TARGET_LONG_CALLS"
  ""
)

(define_insn "sibcall_real"
  [(call (mem:HI (match_operand:SI 0 "call_target_operand" "Q,?Rg"))
         (match_operand 1 "" ""))
   (return)]
  "!TARGET_LONG_CALLS"
  "@
   jump %0
   jumpr %0"
  [(set_attr "type" "J,JR")
   (set_attr "duplex" "no,no")]
)


;;------------;;
;; call_value ;;
;;------------;;

(define_expand "call_value"
  [(parallel [(set (match_operand 0 "gr_register_operand"   "=Rg")
                   (call (match_operand:HI 1 "memory_operand" "m")
                         (match_operand 2 "" "")))
              (clobber (reg:SI LINK_REGNUM))])]
  ""
  {
    if(TARGET_LONG_CALLS && !REG_P (XEXP (operands[1], 0))){
      XEXP (operands[1], 0) = force_reg(Pmode, XEXP (operands[1], 0));
    }
  }
)

(define_insn "call_value_pc_relative"
  [(set (match_operand 0 "gr_register_operand"                 "=Rg,?Rg")
        (call (mem:HI (match_operand:SI 1 "call_target_operand" "Q, Rg"))
              (match_operand 2 "" "")))
   (clobber (reg:SI LINK_REGNUM))]
  "!TARGET_LONG_CALLS"
  "@
   call %1
   callr %1"
  [(set_attr "type" "J,JR")]
)

(define_insn "call_value_register"
  [(set (match_operand 0 "gr_register_operand"                 "=Rg")
        (call (mem:HI (match_operand:SI 1 "gr_register_operand" "Rg"))
              (match_operand 2 "" "")))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "callr %1"
  [(set_attr "type" "JR")]
)

(define_expand "sibcall_value"
  [(parallel [(set (match_operand 0 "gr_register_operand"   "=Rg")
                   (call (match_operand:HI 1 "memory_operand" "m")
                         (match_operand 2 "" "")))
              (return)])]
  "!TARGET_LONG_CALLS"
  ""
)

(define_insn "sibcall_value_real"
  [(set (match_operand 0 "gr_register_operand"                 "=Rg,?Rg")
        (call (mem:HI (match_operand:SI 1 "call_target_operand" "Q, Rg"))
              (match_operand 2 "" "")))
   (return)]
  "!TARGET_LONG_CALLS"
  "@
   jump %1
   jumpr %1"
  [(set_attr "type" "J,JR")
   (set_attr "duplex" "no,no")]
)


;;----------;;
;; call_pop ;;
;;----------;;


;;----------------;;
;; call_value_pop ;;
;;----------------;;


;;--------------;;
;; untyped_call ;;
;;--------------;;


;;--------;;
;; return ;;
;;--------;;

(define_expand "return"
  [(return)]
  "qdsp6_direct_return()"
  {
    if(cfun->machine->frame_info.use_allocframe){
      gcc_assert(TARGET_V4_FEATURES);
      emit_jump_insn(gen_deallocframe_return());
      DONE;
    }
  }
)

;; Conditional returns when we don't need an epilogue

(define_insn_and_split "cond_return"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "predicate_operator"
                        [(match_operand:BI 1 "pr_register_operand" "Rp")
                         (const_int 0)])
                      (return)
                      (pc)))]
  "qdsp6_direct_return()"
  {
    operands[2] = qdsp6_branch_hint(insn);
    return "if (%C0) jumpr%h2 r31";
  }
  "cfun->machine->frame_info.use_allocframe"
  [(parallel [(set (pc)
                   (if_then_else (match_dup 0)
                                 (return)
                                 (pc)))
              (cond_exec
                (match_dup 0)
                (parallel
                  [(set (reg:SI SP_REGNUM)
                        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
                   (set (reg:SI LINK_REGNUM)
                        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
                   (set (reg:SI FP_REGNUM)
                        (mem:SI (reg:SI FP_REGNUM)))]))])]
  {
    gcc_assert(TARGET_V4_FEATURES);
  }
  [(set_attr "type" "JR")
   (set_attr "duplex" "yes")]
)

(define_insn "cond_dealloc_return"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "predicate_operator"
                        [(match_operand:BI 1 "pr_register_operand" "Rp")
                         (const_int 0)])
                      (return)
                      (pc)))
   (cond_exec
     (match_dup 0)
     (parallel
       [(set (reg:SI SP_REGNUM)
             (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
        (set (reg:SI LINK_REGNUM)
             (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
        (set (reg:SI FP_REGNUM)
             (mem:SI (reg:SI FP_REGNUM)))]))]
  "qdsp6_direct_return()"
  {
    operands[2] = qdsp6_branch_hint(insn);
    return "if (%C0) dealloc_return%h2";
  }
  [(set_attr "type" "NewValue")
   (set_attr "duplex" "yes")]
)

(define_insn "cond_dealloc_inverse"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "predicate_operator"
                        [(match_operand:BI 1 "pr_register_operand" "Rp,Rnp")
                         (const_int 0)])
                      (pc)
                      (return)))
   (cond_exec
     (match_dup 0)
     (parallel
       [(set (reg:SI SP_REGNUM)
             (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
        (set (reg:SI LINK_REGNUM)
             (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
        (set (reg:SI FP_REGNUM)
             (mem:SI (reg:SI FP_REGNUM)))]))]
  "qdsp6_direct_return()"
  {
    rtx prediction;
    if(which_alternative == 0){
      return "if (%I0) dealloc_return";
    }
    else {
      prediction = find_reg_note (insn, REG_BR_PROB, 0);
      if(prediction && INTVAL (XEXP (prediction, 0)) > REG_BR_PROB_BASE / 2){
        return "if (%I0) dealloc_return:t";
      }
      else {
        return "if (%I0) dealloc_return:nt";
      }
    }
  }
  [(set_attr "type" "NewValue")]
)


;;----------------;;
;; untyped_return ;;
;;----------------;;


;;-----;;
;; nop ;;
;;-----;;

;; No operation, needed in case the user uses -g but not -O.
(define_insn "nop"
  [(const_int 0)]
  ""
  "nop"
  [(set_attr "type" "A")]
)


;;---------------;;
;; indirect_jump ;;
;;---------------;;

(define_insn "indirect_jump"
  [(set (pc) (match_operand:SI 0 "nonimmediate_operand" "Rg"))]
  ""
  "jumpr %0"
  [(set_attr "type" "JR")
   (set_attr "duplex" "yes")]
)

(define_insn "cond_jump_reg_indirect"
  [(set (pc)
        (if_then_else (match_operator:BI 0 "predicate_operator"
                        [(match_operand:BI 1 "pr_register_operand" "Rp")
                         (const_int 0)])
                      (match_operand 2 "gr_register_operand" "Rg")
                      (pc)))]
  ""
  {
    operands[3] = qdsp6_branch_hint(insn);
    return "if (%C0) jumpr%h3 %2";
  }
  [(set_attr "type" "JR")
   (set_attr "duplex" "yes")]
)


;;--------;;
;; casesi ;;
;;--------;;


;;-----------;;
;; tablejump ;;
;;-----------;;

(define_insn "tablejump"
  [(set (pc) (match_operand:SI 0 "nonimmediate_operand" "Rg"))
   (use (label_ref (match_operand 1 "" "")))]
  ""
  "jumpr %0"
  [(set_attr "type" "JR")
   (set_attr "duplex" "yes")]
)


;;---------------------------------;;
;; decrement_and_branch_until_zero ;;
;;---------------------------------;;


;;------------;;
;; doloop_end ;;
;;------------;;

(define_expand "doloop_end"
  [(use (match_operand 0 "" ""))  ; loop pseudo
   (use (match_operand 1 "" ""))  ; iterations; zero if unknown
   (use (match_operand 2 "" ""))  ; max iterations
   (use (match_operand 3 "" ""))  ; loop level
   (use (match_operand 4 "" ""))] ; label
  "TARGET_HARDWARE_LOOPS"
  {
    enum machine_mode mode;
    mode = GET_MODE (operands[0]);
    if(GET_MODE_CLASS (mode) != MODE_INT || mode == DImode){
      FAIL;
    }
    if(INTVAL (operands[3]) == 1){
      operands[0] = gen_reg_rtx(SImode);
      emit_jump_insn(gen_doloop_end0(operands[0], operands[4],
                                            GEN_INT (REGNO (operands[0]))));
    }
    else if(0 && INTVAL (operands[3]) == 2){
      operands[0] = gen_reg_rtx(SImode);
      emit_jump_insn(gen_doloop_end1(operands[0], operands[4],
                                            GEN_INT (REGNO (operands[0]))));
    }
    else {
      FAIL;
    }
    qdsp6_hardware_loop();
    DONE;
  }
)

(define_insn_and_split "doloop_end0"
  [(set (pc) (if_then_else (ne (match_operand:SI 0 "gr_register_operand" "")
                               (const_int 1))
                           (label_ref (match_operand 1 "" ""))
                           (pc)))
   (set (match_dup 0) (if_then_else:SI (ne (match_dup 0)
                                           (const_int 1))
                                       (plus:SI (match_dup 0)
                                                (const_int -1))
                                       (match_dup 0)))
   (set (reg:SI LC0_REGNUM)
        (unspec:SI [(reg:SI LC0_REGNUM) (reg:SI SA0_REGNUM)
                    (match_operand:SI 2 "const_int_operand" "")]
                   UNSPEC_DOLOOP_END))]
  ""
  "#"
  ""
  [(parallel [(set (pc) (if_then_else (ne (match_dup 3) (const_int 1))
                                      (label_ref (match_dup 1))
                                      (pc)))
              (set (match_dup 3) (if_then_else:SI (ne (match_dup 3)
                                                      (const_int 1))
                                                  (plus:SI (match_dup 3)
                                                           (const_int -1))
                                                  (match_dup 3)))
              (unspec:SI [(reg:SI SA0_REGNUM) (match_dup 2)]
                         UNSPEC_DOLOOP_END)])]
  {
    operands[3] = gen_rtx_REG (SImode, LC0_REGNUM);
  }
  [(set_attr "type" "endloop0")
   (set_attr "length" "8")]
)

(define_insn "endloop0"
  [(set (pc) (if_then_else (ne (reg:SI LC0_REGNUM) (const_int 1))
                           (label_ref (match_operand 0 "" ""))
                           (pc)))
   (set (reg:SI LC0_REGNUM) (if_then_else:SI (ne (reg:SI LC0_REGNUM)
                                                 (const_int 1))
                                             (plus:SI (reg:SI LC0_REGNUM)
                                                      (const_int -1))
                                             (reg:SI LC0_REGNUM)))
   (unspec:SI [(reg:SI SA0_REGNUM) (match_operand:SI 1 "const_int_operand" "")]
              UNSPEC_DOLOOP_END)]
  ""
  "{ nop }:endloop0 // start=%l0"
  [(set_attr "type" "endloop0")
   (set_attr "length" "8")]
)

(define_insn_and_split "doloop_end1"
  [(set (pc) (if_then_else (ne (match_operand:SI 0 "gr_register_operand" "")
                               (const_int 1))
                           (label_ref (match_operand 1 "" ""))
                           (pc)))
   (set (match_dup 0) (if_then_else:SI (ne (match_dup 0)
                                           (const_int 1))
                                       (plus:SI (match_dup 0)
                                                (const_int -1))
                                       (match_dup 0)))
   (set (reg:SI LC1_REGNUM)
        (unspec:SI [(reg:SI LC1_REGNUM) (reg:SI SA1_REGNUM)
                    (match_operand:SI 2 "const_int_operand" "")]
                   UNSPEC_DOLOOP_END))]
  ""
  "#"
  ""
  [(parallel [(set (pc) (if_then_else (ne (match_dup 3) (const_int 1))
                                      (label_ref (match_dup 1))
                                      (pc)))
              (set (match_dup 3) (if_then_else:SI (ne (match_dup 3)
                                                      (const_int 1))
                                                  (plus:SI (match_dup 3)
                                                           (const_int -1))
                                                  (match_dup 3)))
              (unspec:SI [(reg:SI SA1_REGNUM) (match_dup 2)]
                         UNSPEC_DOLOOP_END)])]
  {
    operands[3] = gen_rtx_REG (SImode, LC1_REGNUM);
  }
  [(set_attr "type" "endloop1")
   (set_attr "length" "12")]
)

(define_insn "endloop1"
  [(set (pc) (if_then_else (ne (reg:SI LC1_REGNUM) (const_int 1))
                           (label_ref (match_operand 0 "" ""))
                           (pc)))
   (set (reg:SI LC1_REGNUM) (if_then_else:SI (ne (reg:SI LC1_REGNUM)
                                                 (const_int 1))
                                             (plus:SI (reg:SI LC1_REGNUM)
                                                      (const_int -1))
                                             (reg:SI LC1_REGNUM)))
   (unspec:SI [(reg:SI SA1_REGNUM) (match_operand:SI 1 "const_int_operand" "")]
              UNSPEC_DOLOOP_END)]
  ""
  "{ nop }:endloop1 // start=%l0"
  [(set_attr "type" "endloop1")
   (set_attr "length" "12")]
)


;;--------------;;
;; doloop_begin ;;
;;--------------;;

(define_expand "doloop_begin"
  [(use (match_operand 0 "" ""))  ; loop pseudo
   (use (match_operand 1 "" ""))  ; iterations; zero if unknown
   (use (match_operand 2 "" ""))  ; max iterations
   (use (match_operand 3 "" ""))] ; loop level
  "TARGET_HARDWARE_LOOPS"
  {
    if(INTVAL (operands[3]) == 1){
      emit_insn(gen_doloop_begin0(operands[0], GEN_INT (REGNO (operands[0]))));
    }
    else if(0 && INTVAL (operands[3]) == 2){
      emit_insn(gen_doloop_begin1(operands[0], GEN_INT (REGNO (operands[0]))));
    }
    else {
      FAIL;
    }
    DONE;
  }
)

(define_insn "doloop_begin0"
  [(set (reg:SI LC0_REGNUM) (match_operand:SI 0 "nonmemory_operand" "Rg,Iu10"))
   (set (reg:SI SA0_REGNUM) (match_operand:SI 1 "const_int_operand" ""))
   (clobber (match_scratch:SI 2 "=&Rg,&Rg"))]
  ""
  "error: This is a loop0 insn that should have been fixed up."
  [(set_attr "type" "loop")]
)

(define_insn "loop0"
  [(set (reg:SI LC0_REGNUM) (match_operand:SI 0 "nonmemory_operand" "Rg,Iu10"))
   (set (reg:SI SA0_REGNUM) (label_ref (match_operand 1 "" "")))
   (clobber (match_scratch:SI 2 "=&Rg,&Rg"))]
  ""
  {
    if(get_attr_length(insn) == 4){
      if(which_alternative == 0){
        return "loop0(%l1,%0)";
      }
      else {
        return "loop0(%l1,#%0)";
      }
    }
    else {
      if(which_alternative == 0){
        return "%2 = %0\;"
               "{\;"
               "  lc0 = %2\;"
               "  %2.h = #HI(%1)\;"
               "}\;"
               "%2.l = #LO(%1)\;"
               "sa0 = %2";
      }
      else {
        return "%2 = #%0\;"
               "{\;"
               "  lc0 = %2\;"
               "  %2.h = #HI(%1)\;"
               "}\;"
               "%2.l = #LO(%1)\;"
               "sa0 = %2";
      }
    }
  }
  [(set (attr "type")
        (if_then_else (eq_attr "length" "4")
                      (const_string "loop")
                      (const_string "multiple")))
   (set (attr "length")
        (if_then_else (le (abs (minus (match_dup 1) (pc))) (const_int 200))
                      (const_string "4")
                      (const_string "20")))]
)

(define_insn "doloop_begin1"
  [(set (reg:SI LC1_REGNUM) (match_operand:SI 0 "nonmemory_operand" "Rg,Iu10"))
   (set (reg:SI SA1_REGNUM) (match_operand:SI 1 "const_int_operand" ""))
   (clobber (match_scratch:SI 2 "=&Rg,&Rg"))]
  ""
  "error: This is a loop1 insn that should have been fixed up."
  [(set_attr "type" "loop")]
)

(define_insn "loop1"
  [(set (reg:SI LC1_REGNUM) (match_operand:SI 0 "nonmemory_operand" "Rg,Iu10"))
   (set (reg:SI SA1_REGNUM) (label_ref (match_operand 1 "" "")))
   (clobber (match_scratch:SI 2 "=&Rg,&Rg"))]
  ""
  {
    if(get_attr_length(insn) == 4){
      if(which_alternative == 0){
        return "loop1(%l1,%0)";
      }
      else {
        return "loop1(%l1,#%0)";
      }
    }
    else {
      if(which_alternative == 0){
        return "%2 = %0\;"
               "{\;"
               "  lc1 = %2\;"
               "  %2.h = #HI(%1)\;"
               "}\;"
               "%2.l = #LO(%1)\;"
               "sa1 = %2";
      }
      else {
        return "%2 = #%0\;"
               "{\;"
               "  lc1 = %2\;"
               "  %2.h = #HI(%1)\;"
               "}\;"
               "%2.l = #LO(%1)\;"
               "sa1 = %2";
      }
    }
  }
  [(set (attr "type")
        (if_then_else (eq_attr "length" "4")
                      (const_string "loop")
                      (const_string "multiple")))
   (set (attr "length")
        (if_then_else (le (abs (minus (match_dup 1) (pc))) (const_int 200))
                      (const_string "4")
                      (const_string "20")))]
)


;;----------------------------------;;
;; canonicalize_funcptr_for_compare ;;
;;----------------------------------;;


;;------------------;;
;; save_stack_block ;;
;;------------------;;


;;---------------------;;
;; save_stack_function ;;
;;---------------------;;


;;---------------------;;
;; save_stack_nonlocal ;;
;;---------------------;;


;;---------------------;;
;; restore_stack_block ;;
;;---------------------;;


;;------------------------;;
;; restore_stack_function ;;
;;------------------------;;


;;------------------------;;
;; restore_stack_nonlocal ;;
;;------------------------;;


;;----------------;;
;; allocate_stack ;;
;;----------------;;


;;-------------;;
;; check_stack ;;
;;-------------;;


;;---------------;;
;; nonlocal_goto ;;
;;---------------;;


;;------------------------;;
;; nonlocal_goto_receiver ;;
;;------------------------;;


;;--------------------;;
;; exception_receiver ;;
;;--------------------;;


;;----------------------;;
;; builtin_setjmp_setup ;;
;;----------------------;;


;;-------------------------;;
;; builtin_setjmp_receiver ;;
;;-------------------------;;


;;-----------------;;
;; builtin_longjmp ;;
;;-----------------;;


;;-----------;;
;; eh_return ;;
;;-----------;;


;;----------;;
;; prologue ;;
;;----------;;

(define_expand "prologue"
  [(clobber (const_int 0))]
  ""
  {
    qdsp6_expand_prologue();
    DONE;
  }
)


;;----------;;
;; epilogue ;;
;;----------;;

(define_expand "epilogue"
  [(return)]
  ""
  {
    qdsp6_expand_epilogue(false);
    DONE;
  }
)


;;------------------;;
;; sibcall_epilogue ;;
;;------------------;;

(define_expand "sibcall_epilogue"
  [(return)]
  ""
  {
    qdsp6_expand_epilogue(true);
    DONE;
  }
)


;;------;;
;; trap ;;
;;------;;


;;------------------;;
;; conditional_trap ;;
;;------------------;;


;;----------;;
;; prefetch ;;
;;----------;;

(define_expand "prefetch"
  [(prefetch (match_operand:SI 0 "address_operand" "p")
             (match_operand:SI 1 "const_int_operand" "i")
             (match_operand:SI 2 "const_int_operand" "i"))]
  ""
  {
    if(!REG_P (operands[0])){
      operands[0] = force_reg(SImode, operands[0]);
    }
  }
)

(define_insn "prefetch_real"
  [(prefetch (match_operand:SI 0 "gr_register_operand" "Rg")
             (match_operand:SI 1 "const_int_operand" "i")
             (match_operand:SI 2 "const_int_operand" "i"))]
  ""
  "dcfetch(%0)"
  [(set_attr "type" "Store")]
)


;;----------------;;
;; memory_barrier ;;
;;----------------;;


;;-----------------------------;;
;; sync_compare_and_swap{mode} ;;
;;-----------------------------;;


;;--------------------------------;;
;; sync_compare_and_swap_cc{mode} ;;
;;--------------------------------;;


;;----------------;;
;; sync_add{mode} ;;
;;----------------;;


;;----------------;;
;; sync_sub{mode} ;;
;;----------------;;


;;----------------;;
;; sync_ior{mode} ;;
;;----------------;;


;;----------------;;
;; sync_and{mode} ;;
;;----------------;;


;;----------------;;
;; sync_xor{mode} ;;
;;----------------;;


;;-----------------;;
;; sync_nand{mode} ;;
;;-----------------;;


;;--------------------;;
;; sync_old_add{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_old_sub{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_old_ior{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_old_and{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_old_xor{mode} ;;
;;--------------------;;


;;---------------------;;
;; sync_old_nand{mode} ;;
;;---------------------;;


;;--------------------;;
;; sync_new_add{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_new_sub{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_new_ior{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_new_and{mode} ;;
;;--------------------;;


;;--------------------;;
;; sync_new_xor{mode} ;;
;;--------------------;;


;;---------------------;;
;; sync_new_nand{mode} ;;
;;---------------------;;


;;------------------------------;;
;; sync_lock_test_and_set{mode} ;;
;;------------------------------;;


;;-------------------------;;
;; sync_lock_release{mode} ;;
;;-------------------------;;


;;-------------------;;
;; stack_protect_set ;;
;;-------------------;;


;;--------------------;;
;; stack_protect_test ;;
;;--------------------;;



;;---------------------------------;;
;; Patterns Produced by Intrinsics ;;
;;---------------------------------;;

(include "builtins.md")
(include "manual_builtins.md")



;;------------------------------;;
;; Patterns Produced by Combine ;;
;;------------------------------;;


;;-------------------------------------------;;
;; Predicate Logic for Compound Conditionals ;;
;;-------------------------------------------;;

;; These patterns are used for all combinations of compound conditionals.
;; Their purpose is to manipulate Combine by giving it three insns to combine so
;; it will try splitting the result.

(define_insn_and_split "unspec_nop_move"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (unspec:SI [(match_operand:SI 1 "gr_register_operand" "Rg")]
                   UNSPEC_NOP))]
  ""
  "#"
  ""
  [(set (match_dup 0) (match_dup 1))]
  ""
)


(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (subreg:QI
            (unspec:SI [(match_operand:SI 1 "gr_register_operand" "")]
                       UNSPEC_NOP) 0)
          (const_int 0)))
   (clobber (match_operand:SI 2 "gr_register_operand" ""))]
  ""
  [(set (match_dup 2) (unspec:SI [(match_dup 1)] UNSPEC_NOP))
   (set (match_dup 0) (ne:BI (match_dup 2) (const_int 0)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (subreg:QI
            (unspec:SI [(match_operand:SI 1 "gr_register_operand" "")]
                       UNSPEC_NOP) 0)
          (const_int 0)))
   (clobber (match_operand:SI 2 "gr_register_operand" ""))]
  ""
  [(set (match_dup 2) (unspec:SI [(match_dup 1)] UNSPEC_NOP))
   (set (match_dup 0) (eq:BI (match_dup 2) (const_int 0)))]
  ""
)

;; and(p,p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (and:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (and:BI (match_dup 1) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "andttbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "andttbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (match_dup 1) (match_dup 2)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

;; and(p,!p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (and:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (and:BI (not:BI (match_dup 1)) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (and:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (and:BI (not:BI (match_dup 2)) (match_dup 1))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "andtfbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (and:BI (not:BI (match_dup 1)) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "andtfbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (and:BI (not:BI (match_dup 1)) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (not:BI (match_dup 1)) (match_dup 2)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  "TARGET_V2_FEATURES"
  [(set (match_dup 0) (ior:BI (not:BI (match_dup 2)) (match_dup 1)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (not:BI (match_dup 1)) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

;; and(!p,!p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (and:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (and:BI (not:BI (match_dup 1)) (not:BI (match_dup 2)))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "andffbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (not:BI (match_operand:BI 2 "pr_register_operand" "Rp")))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "andffbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (not:BI (match_operand:BI 2 "pr_register_operand" "Rp")))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (not:BI (match_operand:BI 2 "pr_register_operand" "")))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (not:BI (match_operand:BI 2 "pr_register_operand" "")))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (ior:BI (match_dup 1) (match_dup 2)))]
  ""
)

;; or(p,p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ior:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (ior:BI (match_dup 1) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "iorttbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "iorttbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (ior:BI (match_dup 1) (match_dup 2)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (ior:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

;; or(p,!p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ior:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (ior:BI (not:BI (match_dup 1)) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ior:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (ior:BI (not:BI (match_dup 2)) (match_dup 1))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "iortfbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (ior:BI (not:BI (match_dup 1)) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "iortfbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (and:BI (not:BI (match_dup 2)) (match_dup 1)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  "TARGET_V2_FEATURES"
  [(set (match_dup 0) (ior:BI (not:BI (match_dup 1)) (match_dup 2)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (not:BI (match_dup 2)) (match_dup 1)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (not:BI (match_dup 2)) (match_dup 1)))]
  ""
)

;; or(!p,!p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (ior:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (ior:BI (not:BI (match_dup 1)) (not:BI (match_dup 2)))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_insn_and_split "iorffbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (not:BI (match_operand:BI 2 "pr_register_operand" "Rp")))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "iorffbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                  (not:BI (match_operand:BI 2 "pr_register_operand" "Rp")))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (not:BI (match_operand:BI 2 "pr_register_operand" "")))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                       (not:BI (match_operand:BI 2 "pr_register_operand" "")))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (and:BI (match_dup 1) (match_dup 2)))]
  ""
)

;; xor(p,p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (xor:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (xor:BI (match_dup 1) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (xor:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (xor:BI (match_dup 1) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (zero_extend:SI
          (subreg:QI
            (unspec:SI
              [(if_then_else:SI
                 (xor:BI (match_operand:BI 1 "pr_register_operand" "")
                         (match_operand:BI 2 "pr_register_operand" ""))
                 (const_int 1) (const_int 0))] UNSPEC_NOP) 0)))]
  ""
  [(set (match_dup 0)
        (if_then_else:SI (xor:BI (match_dup 1) (match_dup 2))
                         (const_int 1) (const_int 0)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
  ""
)

(define_insn_and_split "xorttbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (xor:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "xorttbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (if_then_else:SI
          (xor:BI (match_operand:BI 1 "pr_register_operand" "Rp")
                  (match_operand:BI 2 "pr_register_operand" "Rp"))
          (const_int 1) (const_int 0)))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (ne:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(if_then_else:SI
               (xor:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (xor:BI (match_dup 1) (match_dup 2)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(if_then_else:SI
               (xor:BI (match_operand:BI 1 "pr_register_operand" "")
                       (match_operand:BI 2 "pr_register_operand" ""))
               (const_int 1) (const_int 0))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

;; xor(p,!p)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (xor:SI (if_then_else:SI
                  (not:BI (match_operand:BI 1 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (match_operand:BI 2 "pr_register_operand" "")
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0) (eq:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (xor:SI (if_then_else:SI
                  (match_operand:BI 1 "pr_register_operand" "")
                  (const_int 1) (const_int 0))
                (if_then_else:SI
                  (not:BI (match_operand:BI 2 "pr_register_operand" ""))
                  (const_int 1) (const_int 0))))]
  ""
  [(set (match_dup 0) (eq:SI (match_dup 2) (match_dup 1)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
)

(define_split
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (zero_extend:SI
          (subreg:QI
            (unspec:SI
              [(eq:SI (match_operand:BI 1 "pr_register_operand" "")
                      (match_operand:BI 2 "pr_register_operand" ""))]
              UNSPEC_NOP) 0)))]
  ""
  [(set (match_dup 0) (eq:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (unspec:SI [(match_dup 0)] UNSPEC_NOP))]
  ""
)

(define_insn_and_split "xortfbisi3_v2"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (eq:SI (match_operand:BI 1 "pr_register_operand" "Rp")
               (match_operand:BI 2 "pr_register_operand" "Rp")))
   (clobber (match_scratch:BI 3 "=Rp"))]
  "TARGET_V2_FEATURES"
  "#"
  "reload_completed"
  [(set (match_dup 3) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (const_int 1) (const_int 0)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "xortfbisi3"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
        (eq:SI (match_operand:BI 1 "pr_register_operand" "Rp")
               (match_operand:BI 2 "pr_register_operand" "Rp")))
   (clobber (match_scratch:BI 3 "=Rp"))
   (clobber (match_scratch:SI 4 "=Rg"))
   (clobber (match_scratch:SI 5 "=Rg"))]
  ""
  "#"
  "reload_completed"
  [(set (match_dup 4) (const_int 1))
   (set (match_dup 5) (const_int 0))
   (set (match_dup 3) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (if_then_else:SI (eq:BI (match_dup 3) (const_int 0))
                                       (match_dup 4) (match_dup 5)))]
  ""
  [(set_attr "type" "multiple")]
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (ne:BI
          (unspec:SI
            [(eq:SI (match_operand:BI 1 "pr_register_operand" "")
                    (match_operand:BI 2 "pr_register_operand" ""))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (xor:BI (match_dup 1) (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 0)))]
  ""
)

(define_split
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (eq:BI
          (unspec:SI
            [(eq:SI (match_operand:BI 1 "pr_register_operand" "")
                    (match_operand:BI 2 "pr_register_operand" ""))] UNSPEC_NOP)
          (const_int 0)))]
  ""
  [(set (match_dup 0) (xor:BI (match_dup 1) (match_dup 2)))]
  ""
)


;;-------------------;;
;; add/sub halfwords ;;
;;-------------------;;

(define_insn "addhi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"             "=Rg")
        (sign_extend:SI
          (subreg:HI
            (plus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                     (match_operand:SI 2 "gr_register_operand" "Rg"))
            0)))]
  ""
  "%0 = add(%1.l,%2.l)"
  [(set_attr "type" "X")]
)

(define_insn "addhi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"               "=Rg")
        (sign_extend:SI
          (subreg:HI
            (plus:SI (lshiftrt:SI
                       (match_operand:SI 2 "gr_register_operand" "Rg")
                       (const_int 16))
                     (match_operand:SI 1 "gr_register_operand"   "Rg"))
          0)))]
  ""
  "%0 = add(%1.l,%2.h)"
  [(set_attr "type" "X")]
)

(define_insn "subhi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"              "=Rg")
        (sign_extend:SI
          (subreg:HI
            (minus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                      (match_operand:SI 2 "gr_register_operand" "Rg"))
            0)))]
  ""
  "%0 = sub(%1.l,%2.l)"
  [(set_attr "type" "X")]
)

(define_insn "subhi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                "=Rg")
        (sign_extend:SI
          (subreg:HI
            (minus:SI (match_operand:SI 1 "gr_register_operand"   "Rg")
                      (lshiftrt:SI
                        (match_operand:SI 2 "gr_register_operand" "Rg")
                        (const_int 16)))
          0)))]
  ""
  "%0 = sub(%1.l,%2.h)"
  [(set_attr "type" "X")]
)


;;------------------------------;;
;; saturating add/sub halfwords ;;
;;------------------------------;;

(define_insn "ssaddhi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
        (sign_extend:SI (ss_plus:HI (match_operand:HI 1 "gr_register_operand" "Rg")
                                    (match_operand:HI 2 "gr_register_operand" "Rg"))))]
  ""
  "%0 = add(%1.l,%2.l):sat"
  [(set_attr "type" "X")]
)

(define_insn "ssaddhi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                    "=Rg")
        (sign_extend:SI (ss_plus:HI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                            (const_int 16)) 0)
                                    (match_operand:HI 1 "gr_register_operand"                         "Rg"))))]
  ""
  "%0 = add(%1.l,%2.h):sat"
  [(set_attr "type" "X")]
)

(define_insn "sssubhi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
        (sign_extend:SI (ss_minus:HI (match_operand:HI 1 "gr_register_operand" "Rg")
                                     (match_operand:HI 2 "gr_register_operand" "Rg"))))]
  ""
  "%0 = sub(%1.l,%2.l):sat"
  [(set_attr "type" "X")]
)

(define_insn "sssubhi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                    "=Rg")
        (sign_extend:SI (ss_minus:HI (match_operand:HI 1 "gr_register_operand"                         "Rg")
                                     (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))))]
  ""
  "%0 = sub(%1.l,%2.h):sat"
  [(set_attr "type" "X")]
)


;;-------------------;;
;; compound logicals ;;
;;-------------------;;

(define_insn "andnotsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (and:SI
          (not:SI
            (match_operand:SI 1 "gr_register_operand" "Rg"))
          (match_operand:SI 2 "gr_register_operand"   "Rg")))]
  "TARGET_V4_FEATURES"
  "%0 = and(%2,~%1)"
  [(set_attr "type" "A")]
)

(define_insn "ornotsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (ior:SI
          (not:SI
            (match_operand:SI 1 "gr_register_operand" "Rg"))
          (match_operand:SI 2 "gr_register_operand"   "Rg")))]
  "TARGET_V4_FEATURES"
  "%0 = or(%2,~%1)"
  [(set_attr "type" "A")]
)

(define_insn "andnotdi3"
  [(set (match_operand:DI 0 "gr_register_operand"    "=Rg")
        (and:DI
          (not:DI
            (match_operand:DI 1 "gr_register_operand" "Rg"))
          (match_operand:DI 2 "gr_register_operand"   "Rg")))]
  "TARGET_V4_FEATURES"
  "%P0 = and(%P2,~%P1)"
  [(set_attr "type" "X")]
)

(define_insn "ornotdi3"
  [(set (match_operand:DI 0 "gr_register_operand"    "=Rg")
        (ior:DI
          (not:DI
            (match_operand:DI 1 "gr_register_operand" "Rg"))
          (match_operand:DI 2 "gr_register_operand"   "Rg")))]
  "TARGET_V4_FEATURES"
  "%P0 = or(%P2,~%P1)"
  [(set_attr "type" "X")]
)

(define_insn "andandbi3"
  [(set (match_operand:BI 0 "pr_register_operand"    "=Rp")
        (and:BI
          (and:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (match_operand:BI 2 "pr_register_operand" "Rp"))
          (match_operand:BI 3 "pr_register_operand"   "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = and(%3,and(%1,%2))"
  [(set_attr "type" "S")]
)

(define_insn "andandnotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"            "=Rp")
        (and:BI
          (and:BI
            (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
            (match_operand:BI 2 "pr_register_operand"         "Rp"))
          (match_operand:BI 3 "pr_register_operand"           "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = and(%3,and(%2,!%1))"
  [(set_attr "type" "S")]
)

(define_insn "andorbi3"
  [(set (match_operand:BI 0 "pr_register_operand"    "=Rp")
        (and:BI
          (ior:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (match_operand:BI 2 "pr_register_operand" "Rp"))
          (match_operand:BI 3 "pr_register_operand"   "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = and(%3,or(%1,%2))"
  [(set_attr "type" "S")]
)

(define_insn "andornotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"            "=Rp")
        (and:BI
          (ior:BI
            (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
            (match_operand:BI 2 "pr_register_operand"         "Rp"))
          (match_operand:BI 3 "pr_register_operand"           "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = and(%3,or(%2,!%1))"
  [(set_attr "type" "S")]
)

(define_insn "andandsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (and:SI
          (and:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 &= and(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "andandnotsi3"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg")
        (and:SI
          (and:SI
            (not:SI (match_operand:SI 1 "gr_register_operand" "Rg"))
            (match_operand:SI 2 "gr_register_operand"         "Rg"))
          (match_operand:SI 3 "gr_register_operand"            "0")))]
  "TARGET_V4_FEATURES"
  "%0 &= and(%2,~%1)"
  [(set_attr "type" "X")]
)

(define_insn "andorsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (and:SI
          (ior:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 &= or(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "andxorsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (and:SI
          (xor:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 &= xor(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "orandbi3"
  [(set (match_operand:BI 0 "pr_register_operand"    "=Rp")
        (ior:BI
          (and:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (match_operand:BI 2 "pr_register_operand" "Rp"))
          (match_operand:BI 3 "pr_register_operand"   "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = or(%3,and(%1,%2))"
  [(set_attr "type" "S")]
)

(define_insn "orandnotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"            "=Rp")
        (ior:BI
          (and:BI
            (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
            (match_operand:BI 2 "pr_register_operand"         "Rp"))
          (match_operand:BI 3 "pr_register_operand"           "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = or(%3,and(%2,!%1))"
  [(set_attr "type" "S")]
)

(define_insn "ororbi3"
  [(set (match_operand:BI 0 "pr_register_operand"    "=Rp")
        (ior:BI
          (ior:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (match_operand:BI 2 "pr_register_operand" "Rp"))
          (match_operand:BI 3 "pr_register_operand"   "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = or(%3,or(%1,%2))"
  [(set_attr "type" "S")]
)

(define_insn "orornotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"            "=Rp")
        (ior:BI
          (ior:BI
            (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
            (match_operand:BI 2 "pr_register_operand"         "Rp"))
          (match_operand:BI 3 "pr_register_operand"           "Rp")))]
  "TARGET_V4_FEATURES"
  "%0 = or(%3,or(%2,!%1))"
  [(set_attr "type" "S")]
)

(define_insn "orandsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg,Rg,  Rg,Rg,Rg")
        (ior:SI
          (and:SI
            (match_operand:SI 1 "gr_register_operand"  "0, 0,  Rg,Rg,Rg")
            (match_operand:SI 2 "nonmemory_operand" "Is10, i,Is10, i,Rg"))
          (match_operand:SI 3 "gr_register_operand"   "Rg,Rg,   0, 0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = or(%3,and(%1,#%2))
   %0 = or(%3,and(%1,##%2))
   %0 |= and(%1,#%2)
   %0 |= and(%1,##%2)
   %0 |= and(%1,%2)"
  [(set_attr "type" "X,EX,X,EX,X")]
)

(define_insn "ororsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg,Rg,Rg")
        (ior:SI
          (ior:SI
            (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
            (match_operand:SI 2 "gr_register_operand"  "0, 0,Rg"))
          (match_operand:SI 3 "nonmemory_operand"   "Is10, i, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 |= or(%1,#%3)
   %0 |= or(%1,##%3)
   %0 |= or(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "orxorsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (ior:SI
          (xor:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 |= xor(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "xorandsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (xor:SI
          (and:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 ^= and(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "xororsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (xor:SI
          (ior:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  "TARGET_V4_FEATURES"
  "%0 ^= or(%1,%2)"
  [(set_attr "type" "X")]
)

(define_insn "xorxorsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (xor:SI
          (xor:SI
            (match_operand:SI 1 "gr_register_operand" "Rg")
            (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"    "0")))]
  ""
  "%0 ^= xor(%1,%2)"
  [(set_attr "type" "X")]
)


;;----------------------------;;
;; V2 add/sub with accumulate ;;
;;----------------------------;;

;; forms with 0 negative inputs
;; A = A+B+C

(define_insn "addaccsi3_v4"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg,Rg,Rg,Rg,Rg, Rg, Rg,Rg,Rg")
        (plus:SI
          (plus:SI
            (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg,Rg, 0, Rg,  0,Rg, 0")
            (match_operand:SI 2 "gr_register_operand" "Rg,Rg,Rg, 0,Rg,  0, Rg, 0,Rg"))
          (match_operand:SI 3 "nonmemory_operand"    "Is6, i, 0,Rg,Rg,Is8,Is8, i, i")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = add(%1,add(%2,#%3))
   %0 = add(%1,add(%2,##%3))
   %0 += add(%1,%2)
   %0 += add(%1,%3)
   %0 += add(%2,%3)
   %0 += add(%1,#%3)
   %0 += add(%2,#%3)
   %0 += add(%1,##%3)
   %0 += add(%2,##%3)"
  [(set_attr "type" "X,EX,X,X,X,X,X,EX,EX")]
)

(define_insn "addaccsi3"
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg,Rg,Rg, Rg, Rg")
        (plus:SI
          (plus:SI
            (match_operand:SI 1 "gr_register_operand" "Rg,Rg, 0, Rg,  0")
            (match_operand:SI 2 "gr_register_operand" "Rg, 0,Rg,  0, Rg"))
          (match_operand:SI 3 "nonmemory_operand"      "0,Rg,Rg,Is8,Is8")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 += add(%1,%2)
   %0 += add(%1,%3)
   %0 += add(%2,%3)
   %0 += add(%1,#%3)
   %0 += add(%2,#%3)"
  [(set_attr "type" "X,X,X,X,X")]
)

;; forms with 1 negative inputs
;; A = A+(B-C)

(define_insn "subacc1si3_v4"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg,Rg,Rg")
        (plus:SI
          (minus:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
                    (match_operand:SI 2 "gr_register_operand" "Rg,Rg,Rg"))
          (match_operand:SI 3 "nonmemory_operand"            "Is6, i, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = add(%1,sub(#%3,%2))
   %0 = add(%1,sub(##%3,%2))
   %0 += sub(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "subacc1si3"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg")
        (plus:SI
          (minus:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                    (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "nonmemory_operand"              "0")))]
  "!TARGET_V4_FEATURES"
  "%0 += sub(%1,%2)"
  [(set_attr "type" "X")]
)

;; A = (A+B)-C

(define_insn "subacc2si3"
  [(set (match_operand:SI 0 "gr_register_operand"           "=Rg")
        (minus:SI
          (plus:SI (match_operand:SI 1 "gr_register_operand"  "0")
                   (match_operand:SI 2 "gr_register_operand" "Rg"))
          (match_operand:SI 3 "gr_register_operand"          "Rg")))]
  "TARGET_V2_FEATURES"
  "%0 += sub(%2,%3)"
  [(set_attr "type" "X")]
)

;; A = A-(B-C)

(define_insn "subnaccsi3"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg")
        (minus:SI
          (match_operand:SI 1 "gr_register_operand"            "0")
          (minus:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                    (match_operand:SI 3 "gr_register_operand" "Rg"))))]
  "TARGET_V2_FEATURES"
  "%0 += sub(%3,%2)"
  [(set_attr "type" "X")]
)


;; forms with 2 negative inputs
;; A = A-(B+C)

(define_insn "addnacc1si3_v4"
  [(set (match_operand:SI 0 "gr_register_operand"           "=Rg, Rg,Rg")
        (minus:SI
          (match_operand:SI 1 "gr_register_operand"           "0,  0, 0")
          (plus:SI (match_operand:SI 2 "gr_register_operand" "Rg, Rg,Rg")
                   (match_operand:SI 3 "nonmemory_operand"   "Rg,Is8, i"))))]
  "TARGET_V4_FEATURES"
  "@
   %0 -= add(%2,%3)
   %0 -= add(%2,#%3)
   %0 -= add(%2,##%3)"
  [(set_attr "type" "X,X,EX")]
)

(define_insn "addnacc1si3"
  [(set (match_operand:SI 0 "gr_register_operand"           "=Rg, Rg")
        (minus:SI
          (match_operand:SI 1 "gr_register_operand"           "0,  0")
          (plus:SI (match_operand:SI 2 "gr_register_operand" "Rg, Rg")
                   (match_operand:SI 3 "nonmemory_operand"   "Rg,Is8"))))]
  "!TARGET_V4_FEATURES"
  "@
   %0 -= add(%2,%3)
   %0 -= add(%2,#%3)"
  [(set_attr "type" "X")]
)

;; A = (A-B)-C

(define_insn "addnacc2si3_v4"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg, Rg,Rg")
        (minus:SI
          (minus:SI (match_operand:SI 1 "gr_register_operand"  "0,  0, 0")
                    (match_operand:SI 2 "gr_register_operand" "Rg, Rg,Rg"))
          (match_operand:SI 3 "nonmemory_operand"             "Rg,Is8, i")))]
  "TARGET_V4_FEATURES"
  "@
   %0 -= add(%2,%3)
   %0 -= add(%2,#%3)
   %0 -= add(%2,##%3)"
  [(set_attr "type" "X,X,EX")]
)

(define_insn "addnacc2si3"
  [(set (match_operand:SI 0 "gr_register_operand"            "=Rg, Rg")
        (minus:SI
          (minus:SI (match_operand:SI 1 "gr_register_operand"  "0,  0")
                    (match_operand:SI 2 "gr_register_operand" "Rg, Rg"))
          (match_operand:SI 3 "nonmemory_operand"             "Rg,Is8")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 -= add(%2,%3)
   %0 -= add(%2,#%3)"
  [(set_attr "type" "X")]
)




;;--------;;
;; addasl ;;
;;--------;;

(define_insn "addaslmsi4"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg")
        (plus:SI (mult:SI (match_operand:SI 1 "gr_register_operand"    "Rg")
                          (match_operand:SI 2 "addasl_const_int_operand" ""))
                 (match_operand:SI 3 "gr_register_operand"             "Rg")))]
  ""
  "%0 = addasl(%3,%1,#%J2)"
  [(set_attr "type" "S")]
)

(define_insn "addaslsi4"
  [(set (match_operand:SI 0 "gr_register_operand"                      "=Rg")
        (plus:SI (ashift:SI (match_operand:SI 1 "gr_register_operand"   "Rg")
                            (match_operand:SI 2 "u3_const_int_operand" "Iu3"))
                (match_operand:SI 3 "gr_register_operand"               "Rg")))]
  ""
  "%0 = addasl(%3,%1,#%2)"
  [(set_attr "type" "S")]
)


;;--------------------;;
;; multiply halfwords ;;
;;--------------------;;

(define_insn "mulhisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                      "=Rg")
        (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                 (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16))))]
  ""
  "%0 = mpy(%1.h,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg")
        (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                 (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))]
  ""
  "%0 = mpy(%1.h,%2.l)"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg")
        (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                 (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16))))]
  ""
  "%0 = mpy(%1.l,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                 "=Rg")
        (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                            (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16)))
                   (const_int 1)))]
  ""
  "%0 = mpy(%1.h,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                    "=Rg")
        (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                            (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                   (const_int 1)))]
  ""
  "%0 = mpy(%1.h,%2.l):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                    "=Rg")
        (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                            (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16)))
                   (const_int 1)))]
  ""
  "%0 = mpy(%1.l,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mulhisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                    "=Rg")
        (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                            (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                   (const_int 1)))]
  ""
  "%0 = mpy(%1.l,%2.l):<<1"
  [(set_attr "type" "M")]
)


;;-------------------------------;;
;; saturating multiply halfwords ;;
;;-------------------------------;;

(define_insn "ssmulhisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                   "=Rg")
        (ss_truncate:SI
          (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                           (const_int 16)) 0))
                   (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                           (const_int 16)) 0)))))]
  ""
  "%0 = mpy(%1.h,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                                                   "=Rg")
        (ss_truncate:SI
          (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                           (const_int 16)) 0))
                   (sign_extend:DI (match_operand:HI 2 "gr_register_operand"                         "Rg")))))]
  ""
  "%0 = mpy(%1.h,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                   "=Rg")
        (ss_truncate:SI
          (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand"                         "Rg"))
                   (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                           (const_int 16)) 0)))))]
  ""
  "%0 = mpy(%1.l,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (ss_truncate:SI
          (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand" "Rg"))
                   (sign_extend:DI (match_operand:HI 2 "gr_register_operand" "Rg")))))]
  ""
  "%0 = mpy(%1.l,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                   "=Rg")
        (ss_truncate:SI
          (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                           (const_int 16))
                                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                           (const_int 16))))
                     (const_int 1))))]
  ""
  "%0 = mpy(%1.h,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                      "=Rg")
        (ss_truncate:SI
          (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg")
                                                           (const_int 16))
                                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                     (const_int 1))))]
  ""
  "%0 = mpy(%1.h,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                      "=Rg")
        (ss_truncate:SI
          (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg")
                                                           (const_int 16))))
                     (const_int 1))))]
  ""
  "%0 = mpy(%1.l,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmulhisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                      "=Rg")
        (ss_truncate:SI
          (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                     (const_int 1))))]
  ""
  "%0 = mpy(%1.l,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)


;;-----;;
;; mac ;;
;;-----;;

(define_insn "macsi4"
  [(set
     (match_operand:SI 0 "gr_register_operand"         "=Rg,       Rg, Rg, Rg, Rg,Rg,   Rg, Rg,Rg,Rg,Rg, Rg, Rg,Rg")
     (plus:SI
       (mult:SI
         (match_operand:SI 1 "gr_register_operand"       "0,        0, Rg, Rg, Rg,Rg,   Rg, Rg,Rg, 0,Rg, Rg, Rg,Rg")
         (match_operand:SI 2 "nonmemory_operand" "Konehot32,Konehot32,Iu6,Iu6, Rg,Rg,Ju6_2,Iu6, i,Rg,Rg,Iu8,In8, i"))
       (match_operand:SI 3 "nonmemory_operand"         "Iu8,        i,Iu6,  i,Iu6, i,   Rg, Rg,Rg,Rg, 0,  0,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = add(#%3,asl(%1,#%J2))
   %0 = add(##%3,asl(%1,#%J2))
   %0 = add(#%3,mpyi(%1,#%2))
   %0 = add(##%3,mpyi(%1,#%2))
   %0 = add(#%3,mpyi(%1,%2))
   %0 = add(##%3,mpyi(%1,%2))
   %0 = add(%3,mpyi(#%2,%1))
   %0 = add(%3,mpyi(%1,#%2))
   %0 = add(%3,mpyi(%1,##%2))
   %0 = add(%3,mpyi(%1,%2))
   %0 += mpyi(%1,%2)
   %0 += mpyi(%1,#%2)
   %0 -= mpyi(%1,#%n2)
   %0 += mpyi(%1,##%2)"
  [(set_attr "type" "S,ES,M,EM,M,EM,M,M,EM,M,M,M,M,EM")]
)

(define_insn "macsi3"
  [(set (match_operand:SI 0 "gr_register_operand"           "=Rg, Rg, Rg")
        (plus:SI
          (mult:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg, Rg")
                   (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu8,In8"))
          (match_operand:SI 3 "nonmemory_operand"             "0,  0,  0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 += mpyi(%1,%2)
   %0 += mpyi(%1,#%2)
   %0 -= mpyi(%1,#%n2)"
  [(set_attr "type" "M,M,M")]
)

(define_insn "macsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                           "=Rg")
        (plus:DI
          (mult:DI (sign_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                   (sign_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg")))
          (match_operand:DI 3 "gr_register_operand"                           "0")))]
  ""
  "%P0 += mpy(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "mnacsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                           "=Rg")
        (minus:DI
          (match_operand:DI 3 "gr_register_operand"                           "0")
          (mult:DI (sign_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                   (sign_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg")))))]
  ""
  "%P0 -= mpy(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "macn1sidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                                   "=Rg")
        (plus:DI
          (mult:DI (sign_extend:DI (neg:SI (match_operand:SI 1 "gr_register_operand" "Rg")))
                   (sign_extend:DI (match_operand:SI 2 "gr_register_operand"         "Rg")))
          (match_operand:DI 3 "gr_register_operand"                                   "0")))]
  ""
  "%P0 -= mpy(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "macn2sidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                                   "=Rg")
        (plus:DI
          (mult:DI (sign_extend:DI (match_operand:SI 1 "gr_register_operand"         "Rg"))
                   (sign_extend:DI (neg:SI (match_operand:SI 2 "gr_register_operand" "Rg"))))
          (match_operand:DI 3 "gr_register_operand"                                   "0")))]
  ""
  "%P0 -= mpy(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "umacsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                           "=Rg")
        (plus:DI
          (mult:DI (zero_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                   (zero_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg")))
          (match_operand:DI 3 "gr_register_operand"                           "0")))]
  ""
  "%P0 += mpyu(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "umnacsidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                           "=Rg")
        (minus:DI
          (match_operand:DI 3 "gr_register_operand"                           "0")
          (mult:DI (zero_extend:DI (match_operand:SI 1 "gr_register_operand" "Rg"))
                   (zero_extend:DI (match_operand:SI 2 "gr_register_operand" "Rg")))))]
  ""
  "%P0 -= mpyu(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "umacn1sidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                                   "=Rg")
        (plus:DI
          (mult:DI (zero_extend:DI (neg:SI (match_operand:SI 1 "gr_register_operand" "Rg")))
                   (zero_extend:DI (match_operand:SI 2 "gr_register_operand"         "Rg")))
          (match_operand:DI 3 "gr_register_operand"                                   "0")))]
  ""
  "%P0 -= mpyu(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "umacn2sidi3"
  [(set (match_operand:DI 0 "gr_register_operand"                                   "=Rg")
        (plus:DI
          (mult:DI (zero_extend:DI (match_operand:SI 1 "gr_register_operand"         "Rg"))
                   (zero_extend:DI (neg:SI (match_operand:SI 2 "gr_register_operand" "Rg"))))
          (match_operand:DI 3 "gr_register_operand"                                   "0")))]
  ""
  "%P0 -= mpyu(%1,%2)"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                        "=Rg")
        (plus:SI
          (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                   (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16)))
          (match_operand:SI 3 "gr_register_operand"                        "0")))]
  ""
  "%0 += mpy(%1.h,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (plus:SI
          (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                   (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
          (match_operand:SI 3 "gr_register_operand"                           "0")))]
  ""
  "%0 += mpy(%1.h,%2.l)"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (plus:SI
          (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                   (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16)))
          (match_operand:SI 3 "gr_register_operand"                           "0")))]
  ""
  "%0 += mpy(%1.l,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (plus:SI
          (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                   (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
          (match_operand:SI 3 "gr_register_operand"                           "0")))]
  ""
  "%0 += mpy(%1.l,%2.l)"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                   "=Rg")
        (plus:SI
          (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16)))
                     (const_int 1))
          (match_operand:SI 3 "gr_register_operand"                                   "0")))]
  ""
  "%0 += mpy(%1.h,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (plus:SI
          (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                     (const_int 1))
          (match_operand:SI 3 "gr_register_operand"                                      "0")))]
  ""
  "%0 += mpy(%1.h,%2.l):<<1"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (plus:SI
          (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16)))
                     (const_int 1))
          (match_operand:SI 3 "gr_register_operand"                                      "0")))]
  ""
  "%0 += mpy(%1.l,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "machisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (plus:SI
          (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                     (const_int 1))
          (match_operand:SI 3 "gr_register_operand"                                      "0")))]
  ""
  "%0 += mpy(%1.l,%2.l):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                        "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                        "0")
          (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                   (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16)))))]
  ""
  "%0 -= mpy(%1.h,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                           "0")
          (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                   (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))))]
  ""
  "%0 -= mpy(%1.h,%2.l)"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                           "0")
          (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                   (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16)))))]
  ""
  "%0 -= mpy(%1.l,%2.h)"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                           "0")
          (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                   (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))))]
  ""
  "%0 -= mpy(%1.l,%2.l)"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                   "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                                   "0")
          (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg") (const_int 16))
                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg") (const_int 16)))
                     (const_int 1))))]
  ""
  "%0 -= mpy(%1.h,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                                      "0")
          (ashift:SI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg") (const_int 16))
                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                     (const_int 1))))]
  ""
  "%0 -= mpy(%1.h,%2.l):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                                      "0")
          (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                              (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg") (const_int 16)))
                     (const_int 1))))]
  ""
  "%0 -= mpy(%1.l,%2.h):<<1"
  [(set_attr "type" "M")]
)

(define_insn "mnachisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                      "=Rg")
        (minus:SI
          (match_operand:SI 3 "gr_register_operand"                                      "0")
          (ashift:SI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                              (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg")))
                     (const_int 1))))]
  ""
  "%0 -= mpy(%1.l,%2.l):<<1"
  [(set_attr "type" "M")]
)


;;-------;;
;; ssmac ;;
;;-------;;

(define_insn "ssmachisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))
                     (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))))
          (match_operand:SI 3 "gr_register_operand"                                                     "0")))]
  ""
  "%0 += mpy(%1.h,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))
                     (sign_extend:DI (match_operand:HI 2 "gr_register_operand"                         "Rg"))))
          (match_operand:SI 3 "gr_register_operand"                                                     "0")))]
  ""
  "%0 += mpy(%1.h,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand"                         "Rg"))
                     (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))))
          (match_operand:SI 3 "gr_register_operand"                                                     "0")))]
  ""
  "%0 += mpy(%1.l,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                             "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand" "Rg"))
                     (sign_extend:DI (match_operand:HI 2 "gr_register_operand" "Rg"))))
          (match_operand:SI 3 "gr_register_operand"                             "0")))]
  ""
  "%0 += mpy(%1.l,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16))
                                                (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16))))
                       (const_int 1)))
          (match_operand:SI 3 "gr_register_operand"                                                     "0")))]
  ""
  "%0 += mpy(%1.h,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg")
                                                             (const_int 16))
                                                (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                       (const_int 1)))
          (match_operand:SI 3 "gr_register_operand"                                                        "0")))]
  ""
  "%0 += mpy(%1.h,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                                (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg")
                                                             (const_int 16))))
                       (const_int 1)))
          (match_operand:SI 3 "gr_register_operand"                                                        "0")))]
  ""
  "%0 += mpy(%1.l,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmachisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_plus:SI
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                                (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                       (const_int 1)))
          (match_operand:SI 3 "gr_register_operand"                                                        "0")))]
  ""
  "%0 += mpy(%1.l,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_hh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                     "0")
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))
                     (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))))))]
  ""
  "%0 -= mpy(%1.h,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_hl"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                     "0")
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))
                     (sign_extend:DI (match_operand:HI 2 "gr_register_operand"                         "Rg"))))))]
  ""
  "%0 -= mpy(%1.h,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_lh"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                     "0")
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand"                         "Rg"))
                     (sign_extend:DI (subreg:HI (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16)) 0))))))]
  ""
  "%0 -= mpy(%1.l,%2.h):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_ll"
  [(set (match_operand:SI 0 "gr_register_operand"                             "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                             "0")
          (ss_truncate:SI
            (mult:DI (sign_extend:DI (match_operand:HI 1 "gr_register_operand" "Rg"))
                     (sign_extend:DI (match_operand:HI 2 "gr_register_operand" "Rg"))))))]
  ""
  "%0 -= mpy(%1.l,%2.l):sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_hh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                     "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                     "0")
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                                             (const_int 16))
                                                (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg")
                                                             (const_int 16))))
                     (const_int 1)))))]
  ""
  "%0 -= mpy(%1.h,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_hl_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                        "0")
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand"    "Rg")
                                                             (const_int 16))
                                                (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                       (const_int 1)))))]
  ""
  "%0 -= mpy(%1.h,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_lh_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                        "0")
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                                (ashiftrt:SI (match_operand:SI 2 "gr_register_operand"    "Rg")
                                                             (const_int 16))))
                       (const_int 1)))))]
  ""
  "%0 -= mpy(%1.l,%2.h):<<1:sat"
  [(set_attr "type" "M")]
)

(define_insn "ssmnachisi3_ll_s1"
  [(set (match_operand:SI 0 "gr_register_operand"                                                        "=Rg")
        (ss_minus:SI
          (match_operand:SI 3 "gr_register_operand"                                                        "0")
          (ss_truncate:SI
            (ashift:DI (sign_extend:DI (mult:SI (sign_extend:SI (match_operand:HI 1 "gr_register_operand" "Rg"))
                                                (sign_extend:SI (match_operand:HI 2 "gr_register_operand" "Rg"))))
                       (const_int 1)))))]
  ""
  "%0 -= mpy(%1.l,%2.l):<<1:sat"
  [(set_attr "type" "M")]
)


;;------;;
;; shac ;;
;;------;;

;; SI asl

(define_insn "addashlsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                   "=Rg, Rg, Rg,Rg")
        (plus:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                            (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                 (match_operand:SI 3 "nonmemory_operand"            "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = add(#%3,asl(%1,#%2))
   %0 = add(##%3,asl(%1,#%2))
   %0 += asl(%1,#%2)
   %0 += asl(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "ashlsi3_acc"
  [(set (match_operand:SI 0 "gr_register_operand"                    "=Rg,Rg")
        (plus:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                            (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                 (match_operand:SI 3 "gr_register_operand"             "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 += asl(%1,#%2)
   %0 += asl(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "subashlsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                    "=Rg, Rg, Rg,Rg")
        (minus:SI (match_operand:SI 1 "nonmemory_operand"            "Iu8,  i,  0, 0")
                  (ashift:SI (match_operand:SI 2 "gr_register_operand" "0,  0, Rg,Rg")
                             (match_operand:SI 3 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))))]
  "TARGET_V4_FEATURES"
  "@
   %0 = sub(#%1,asl(%2,#%3))
   %0 = sub(##%1,asl(%2,#%3))
   %0 -= asl(%2,#%3)
   %0 -= asl(%2,%3)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "submulsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                           "=Rg,       Rg")
        (minus:SI (match_operand:SI 1 "immediate_operand"                   "Iu8,        i")
                  (mult:SI (match_operand:SI 2 "gr_register_operand"          "0,        0")
                           (match_operand:SI 3 "power_of_two_operand" "Konehot32,Konehot32"))))]
  "TARGET_V4_FEATURES"
  "@
   %0 = sub(#%1,asl(%2,#%J3))
   %0 = sub(##%1,asl(%2,#%J3))"
  [(set_attr "type" "S,ES")]
)

(define_insn "ashlsi3_nacc"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg,Rg")
        (minus:SI (match_operand:SI 1 "gr_register_operand"             "0, 0")
                  (ashift:SI (match_operand:SI 2 "gr_register_operand" "Rg,Rg")
                             (match_operand:SI 3 "nonmemory_operand"  "Iu5,Rg"))))]
  "!TARGET_V4_FEATURES"
  "@
   %0 -= asl(%2,#%3)
   %0 -= asl(%2,%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "andashlsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                  "=Rg, Rg, Rg,Rg")
        (and:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                           (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                (match_operand:SI 3 "nonmemory_operand"            "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = and(#%3,asl(%1,#%2))
   %0 = and(##%3,asl(%1,#%2))
   %0 &= asl(%1,#%2)
   %0 &= asl(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "andmulsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,       Rg")
        (and:SI (mult:SI (match_operand:SI 1 "gr_register_operand"          "0,        0")
                         (match_operand:SI 2 "power_of_two_operand" "Konehot32,Konehot32"))
                (match_operand:SI 3 "immediate_operand"                   "Iu8,        i")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = and(#%3,asl(%1,#%J2))
   %0 = and(##%3,asl(%1,#%J2))"
  [(set_attr "type" "S,ES")]
)

(define_insn "ashlsi3_and"
  [(set (match_operand:SI 0 "gr_register_operand"                   "=Rg,Rg")
        (and:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                           (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"             "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 &= asl(%1,#%2)
   %0 &= asl(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "orashlsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                  "=Rg, Rg, Rg,Rg")
        (ior:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                           (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                (match_operand:SI 3 "nonmemory_operand"            "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = or(#%3,asl(%1,#%2))
   %0 = or(##%3,asl(%1,#%2))
   %0 |= asl(%1,#%2)
   %0 |= asl(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "ormulsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                         "=Rg,       Rg")
        (ior:SI (mult:SI (match_operand:SI 1 "gr_register_operand"          "0,        0")
                         (match_operand:SI 2 "power_of_two_operand" "Konehot32,Konehot32"))
                (match_operand:SI 3 "immediate_operand"                   "Iu8,        i")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = or(#%3,asl(%1,#%J2))
   %0 = or(##%3,asl(%1,#%J2))"
  [(set_attr "type" "S,ES")]
)

(define_insn "ashlsi3_or"
  [(set (match_operand:SI 0 "gr_register_operand"                   "=Rg,Rg")
        (ior:SI (ashift:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                           (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"             "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 |= asl(%1,#%2)
   %0 |= asl(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashlsi3_xor"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg")
        (xor:SI (ashift:SI (match_operand:SI 1 "gr_register_operand"   "Rg")
                           (match_operand:SI 2 "u5_const_int_operand" "Iu5"))
                (match_operand:SI 3 "gr_register_operand"               "0")))]
  ""
  "%0 ^= asl(%1,#%2)"
  [(set_attr "type" "S")]
)

;; SI asr

(define_insn "ashrsi3_acc"
  [(set (match_operand:SI 0 "gr_register_operand"                      "=Rg,Rg")
        (plus:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                              (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                 (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  ""
  "@
   %0 += asr(%1,#%2)
   %0 += asr(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrsi3_nacc"
  [(set (match_operand:SI 0 "gr_register_operand"                       "=Rg,Rg")
        (minus:SI (match_operand:SI 1 "gr_register_operand"               "0, 0")
                  (ashiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg,Rg")
                               (match_operand:SI 3 "nonmemory_operand"  "Iu5,Rg"))))]
  ""
  "@
   %0 -= asr(%2,#%3)
   %0 -= asr(%2,%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrsi3_and"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg,Rg")
        (and:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  ""
  "@
   %0 &= asr(%1,#%2)
   %0 &= asr(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrsi3_or"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg,Rg")
        (ior:SI (ashiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  ""
  "@
   %0 |= asr(%1,#%2)
   %0 |= asr(%1,%2)"
  [(set_attr "type" "S,S")]
)

;; SI lsr

(define_insn "addlshrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg, Rg, Rg,Rg")
        (plus:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                              (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                 (match_operand:SI 3 "nonmemory_operand"              "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = add(#%3,lsr(%1,#%2))
   %0 = add(##%3,lsr(%1,#%2))
   %0 += lsr(%1,#%2)
   %0 += lsr(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "lshrsi3_acc"
  [(set (match_operand:SI 0 "gr_register_operand"                      "=Rg,Rg")
        (plus:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                              (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                 (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 += lsr(%1,#%2)
   %0 += lsr(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "sublshrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                      "=Rg, Rg, Rg,Rg")
        (minus:SI (match_operand:SI 1 "nonmemory_operand"              "Iu8,  i,  0, 0")
                  (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "0,  0, Rg,Rg")
                               (match_operand:SI 3 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))))]
  "TARGET_V4_FEATURES"
  "@
   %0 = sub(#%1,lsr(%2,#%3))
   %0 = sub(##%1,lsr(%2,#%3))
   %0 -= lsr(%2,#%3)
   %0 -= lsr(%2,%3)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "lshrsi3_nacc"
  [(set (match_operand:SI 0 "gr_register_operand"                       "=Rg,Rg")
        (minus:SI (match_operand:SI 1 "gr_register_operand"               "0, 0")
                  (lshiftrt:SI (match_operand:SI 2 "gr_register_operand" "Rg,Rg")
                               (match_operand:SI 3 "nonmemory_operand"  "Iu5,Rg"))))]
  "!TARGET_V4_FEATURES"
  "@
   %0 -= lsr(%2,#%3)
   %0 -= lsr(%2,%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "andlshrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                    "=Rg, Rg, Rg,Rg")
        (and:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                (match_operand:SI 3 "nonmemory_operand"              "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = and(#%3,lsr(%1,#%2))
   %0 = and(##%3,lsr(%1,#%2))
   %0 &= lsr(%1,#%2)
   %0 &= lsr(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "lshrsi3_and"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg,Rg")
        (and:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 &= lsr(%1,#%2)
   %0 &= lsr(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "orlshrsi3"
  [(set (match_operand:SI 0 "gr_register_operand"                    "=Rg, Rg, Rg,Rg")
        (ior:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "0,  0, Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand" "Iu5,Iu5,Iu5,Rg"))
                (match_operand:SI 3 "nonmemory_operand"              "Iu8,  i,  0, 0")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = or(#%3,lsr(%1,#%2))
   %0 = or(##%3,lsr(%1,#%2))
   %0 |= lsr(%1,#%2)
   %0 |= lsr(%1,%2)"
  [(set_attr "type" "S,ES,S,S")]
)

(define_insn "lshrsi3_or"
  [(set (match_operand:SI 0 "gr_register_operand"                     "=Rg,Rg")
        (ior:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg")
                             (match_operand:SI 2 "nonmemory_operand"  "Iu5,Rg"))
                (match_operand:SI 3 "gr_register_operand"               "0, 0")))]
  "!TARGET_V4_FEATURES"
  "@
   %0 |= lsr(%1,#%2)
   %0 |= lsr(%1,%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrsi3_xor"
  [(set (match_operand:SI 0 "gr_register_operand"                       "=Rg")
        (xor:SI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand"   "Rg")
                             (match_operand:SI 2 "u5_const_int_operand" "Iu5"))
                (match_operand:SI 3 "gr_register_operand"                 "0")))]
  ""
  "%0 ^= lsr(%1,#%2)"
  [(set_attr "type" "S")]
)

;; DI asl

(define_insn "ashldi3_acc"
  [(set (match_operand:DI 0 "gr_register_operand"                    "=Rg, Rg")
        (plus:DI (ashift:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                            (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                 (match_operand:DI 3 "gr_register_operand"             "0,  0")))]
  ""
  "@
   %P0 += asl(%P1,%2)
   %P0 += asl(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashldi3_nacc"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg, Rg")
        (minus:DI (match_operand:DI 1 "gr_register_operand"             "0,  0")
                  (ashift:DI (match_operand:DI 2 "gr_register_operand" "Rg, Rg")
                             (match_operand:SI 3 "nonmemory_operand"   "Rg,Iu6"))))]
  ""
  "@
   %P0 -= asl(%P2,%3)
   %P0 -= asl(%P2,#%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashldi3_and"
  [(set (match_operand:DI 0 "gr_register_operand"                   "=Rg, Rg")
        (and:DI (ashift:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                           (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"             "0,  0")))]
  ""
  "@
   %P0 &= asl(%P1,%2)
   %P0 &= asl(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashldi3_or"
  [(set (match_operand:DI 0 "gr_register_operand"                   "=Rg, Rg")
        (ior:DI (ashift:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                           (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"             "0,  0")))]
  ""
  "@
   %P0 |= asl(%P1,%2)
   %P0 |= asl(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashldi3_xor"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg")
        (xor:DI (ashift:DI (match_operand:DI 1 "gr_register_operand"   "Rg")
                           (match_operand:SI 2 "u6_const_int_operand" "Iu6"))
                (match_operand:DI 3 "gr_register_operand"               "0")))]
  "TARGET_V2_FEATURES"
  "%P0 ^= asl(%P1,#%2)"
  [(set_attr "type" "S")]
)

;; DI asr

(define_insn "ashrdi3_acc"
  [(set (match_operand:DI 0 "gr_register_operand"                      "=Rg, Rg")
        (plus:DI (ashiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                              (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                 (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 += asr(%P1,%2)
   %P0 += asr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrdi3_nacc"
  [(set (match_operand:DI 0 "gr_register_operand"                       "=Rg, Rg")
        (minus:DI (match_operand:DI 1 "gr_register_operand"               "0,  0")
                  (ashiftrt:DI (match_operand:DI 2 "gr_register_operand" "Rg, Rg")
                               (match_operand:SI 3 "nonmemory_operand"   "Rg,Iu6"))))]
  ""
  "@
   %P0 -= asr(%P2,%3)
   %P0 -= asr(%P2,#%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrdi3_and"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg, Rg")
        (and:DI (ashiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                             (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 &= asr(%P1,%2)
   %P0 &= asr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "ashrdi3_or"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg, Rg")
        (ior:DI (ashiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                             (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 |= asr(%P1,%2)
   %P0 |= asr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

;; DI lsr

(define_insn "lshrdi3_acc"
  [(set (match_operand:DI 0 "gr_register_operand"                      "=Rg, Rg")
        (plus:DI (lshiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                              (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                 (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 += lsr(%P1,%2)
   %P0 += lsr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrdi3_nacc"
  [(set (match_operand:DI 0 "gr_register_operand"                       "=Rg, Rg")
        (minus:DI (match_operand:DI 1 "gr_register_operand"               "0,  0")
                  (lshiftrt:DI (match_operand:DI 2 "gr_register_operand" "Rg, Rg")
                               (match_operand:SI 3 "nonmemory_operand"   "Rg,Iu6"))))]
  ""
  "@
   %P0 -= lsr(%P2,%3)
   %P0 -= lsr(%P2,#%3)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrdi3_and"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg, Rg")
        (and:DI (lshiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                             (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 &= lsr(%P1,%2)
   %P0 &= lsr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrdi3_or"
  [(set (match_operand:DI 0 "gr_register_operand"                     "=Rg, Rg")
        (ior:DI (lshiftrt:DI (match_operand:DI 1 "gr_register_operand" "Rg, Rg")
                             (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu6"))
                (match_operand:DI 3 "gr_register_operand"               "0,  0")))]
  ""
  "@
   %P0 |= lsr(%P1,%2)
   %P0 |= lsr(%P1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "lshrdi3_xor"
  [(set (match_operand:DI 0 "gr_register_operand"                       "=Rg")
        (xor:DI (lshiftrt:DI (match_operand:DI 1 "gr_register_operand"   "Rg")
                             (match_operand:SI 2 "u6_const_int_operand" "Iu6"))
                (match_operand:DI 3 "gr_register_operand"                 "0")))]
  "TARGET_V2_FEATURES"
  "%P0 ^= lsr(%P1,#%2)"
  [(set_attr "type" "S")]
)


;;----------------;;
;; bit operations ;;
;;----------------;;

(define_insn "setbitsi"
  [(set (match_operand:SI 0 "gr_register_operand"                  "=Rg,Rg")
        (ior:SI (ashift:SI (const_int 1)
                           (match_operand:SI 1 "nonmemory_operand" "Iu5,Rg"))
                (match_operand:SI 2 "gr_register_operand"           "Rg,Rg")))]
  ""
  "@
   %0 = setbit(%2,#%1)
   %0 = setbit(%2,%1)"
  [(set_attr "type" "S,S")]
)

(define_insn "clrbitsi"
  [(set (match_operand:SI 0 "gr_register_operand"                    "=Rg,Rg")
        (and:SI (not:SI
                  (ashift:SI (const_int 1)
                             (match_operand:SI 1 "nonmemory_operand" "Iu5,Rg")))
                (match_operand:SI 2 "gr_register_operand"             "Rg,Rg")))]
  ""
  "@
   %0 = clrbit(%2,#%1)
   %0 = clrbit(%2,%1)"
  [(set_attr "type" "S,S")]
)

(define_insn "togglebitsi"
  [(set (match_operand:SI 0 "gr_register_operand"                  "=Rg,Rg")
        (xor:SI (ashift:SI (const_int 1)
                           (match_operand:SI 1 "nonmemory_operand" "Iu5,Rg"))
                (match_operand:SI 2 "gr_register_operand"           "Rg,Rg")))]
  ""
  "@
   %0 = togglebit(%2,#%1)
   %0 = togglebit(%2,%1)"
  [(set_attr "type" "S,S")]
)

(define_insn "tstbitsi"
  [(set (match_operand:BI 0 "pr_register_operand"                        "=Rp, Rp")
        (ne:BI (zero_extract:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                                (const_int 1)
                                (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu5"))
               (const_int 0)))]
  ""
  "@
   %0 = tstbit(%1,%2)
   %0 = tstbit(%1,#%2)"
  [(set_attr "type" "S")]
)

(define_insn "not_tstbitsi_v4"
  [(set (match_operand:BI 0 "pr_register_operand"                        "=Rp, Rp")
        (eq:BI (zero_extract:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                                (const_int 1)
                                (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu5"))
               (const_int 0)))]
  "TARGET_V4_FEATURES"
  "@
   %0 = !tstbit(%1,%2)
   %0 = !tstbit(%1,#%2)"
  [(set_attr "type" "S")]
)

(define_insn_and_split "not_tstbitsi"
  [(set (match_operand:BI 0 "pr_register_operand"                        "=Rp, Rp")
        (eq:BI (zero_extract:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                                (const_int 1)
                                (match_operand:SI 2 "nonmemory_operand"   "Rg,Iu5"))
               (const_int 0)))]
  "!TARGET_V4_FEATURES"
  "#"
  "!TARGET_V4_FEATURES"
  [(set (match_dup 3)
        (ne:BI (zero_extract:SI (match_dup 1) (const_int 1) (match_dup 2))
               (const_int 0)))
   (set (match_dup 0) (not:BI (match_dup 3)))]
  {
    if(reload_completed){
      operands[3] = operands[0];
    }
    else {
      operands[3] = gen_reg_rtx(BImode);
    }
  }
  [(set_attr "type" "multiple")]
)

(define_insn "bitsclrsi"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp, Rp")
        (eq:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                       (match_operand:SI 2 "gr_or_u6_operand"    "Rg,Iu6"))
               (const_int 0)))]
  ""
  "@
   %0 = bitsclr(%1,%2)
   %0 = bitsclr(%1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "bitsclrsi_2"
  [(set (match_operand:BI 0 "pr_register_operand"                       "=Rp, Rp")
        (eq:BI (and:SI (not:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg"))
                       (match_operand:SI 2 "gr_or_u6_operand"            "Rg,Iu6"))
               (match_dup 2)))]
  ""
  "@
   %0 = bitsclr(%1,%2)
   %0 = bitsclr(%1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "not_bitsclrsi_v4"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp, Rp")
        (ne:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                       (match_operand:SI 2 "gr_or_u6_operand"    "Rg,Iu6"))
               (const_int 0)))]
  "TARGET_V4_FEATURES"
  "@
   %0 = !bitsclr(%1,%2)
   %0 = !bitsclr(%1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn "not_bitsclrsi_2_v4"
  [(set (match_operand:BI 0 "pr_register_operand"                       "=Rp, Rp")
        (ne:BI (and:SI (not:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg"))
                       (match_operand:SI 2 "gr_or_u6_operand"            "Rg,Iu6"))
               (match_dup 2)))]
  "TARGET_V4_FEATURES"
  "@
   %0 = !bitsclr(%1,%2)
   %0 = !bitsclr(%1,#%2)"
  [(set_attr "type" "S,S")]
)

(define_insn_and_split "not_bitsclrsi"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp, Rp")
        (ne:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg")
                       (match_operand:SI 2 "gr_or_u6_operand"    "Rg,Iu6"))
               (const_int 0)))]
  "!TARGET_V4_FEATURES"
  "#"
  "!TARGET_V4_FEATURES"
  [(set (match_dup 3) (eq:BI (and:SI (match_dup 1) (match_dup 2))
                             (const_int 0)))
   (set (match_dup 0) (not:BI (match_dup 3)))]
  {
    if(reload_completed){
      operands[3] = operands[0];
    }
    else {
      operands[3] = gen_reg_rtx(BImode);
    }
  }
  [(set_attr "type" "multiple")]
)

(define_insn_and_split "not_bitsclrsi_2"
  [(set (match_operand:BI 0 "pr_register_operand"                       "=Rp, Rp")
        (ne:BI (and:SI (not:SI (match_operand:SI 1 "gr_register_operand" "Rg, Rg"))
                       (match_operand:SI 2 "gr_or_u6_operand"            "Rg,Iu6"))
               (match_dup 2)))]
  "!TARGET_V4_FEATURES"
  "#"
  "!TARGET_V4_FEATURES"
  [(set (match_dup 4) (eq:BI (and:SI (not:SI (match_dup 1)) (match_dup 2))
                             (match_dup 3)))
   (set (match_dup 0) (not:BI (match_dup 4)))]
  {
    if(reload_completed){
      operands[4] = operands[0];
    }
    else {
      operands[4] = gen_reg_rtx(BImode);
    }
  }
  [(set_attr "type" "multiple")]
)

(define_insn "bitssetsi"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp")
        (eq:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                       (match_operand:SI 2 "gr_register_operand" "Rg"))
               (match_dup 2)))]
  ""
  "%0 = bitsset(%1,%2)"
  [(set_attr "type" "S")]
)

(define_insn "not_bitssetsi_v4"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp")
        (ne:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                       (match_operand:SI 2 "gr_register_operand" "Rg"))
               (match_dup 2)))]
  "TARGET_V4_FEATURES"
  "%0 = !bitsset(%1,%2)"
  [(set_attr "type" "S")]
)

(define_insn_and_split "not_bitssetsi"
  [(set (match_operand:BI 0 "pr_register_operand"               "=Rp")
        (ne:BI (and:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                       (match_operand:SI 2 "gr_register_operand" "Rg"))
               (match_dup 2)))]
  "!TARGET_V4_FEATURES"
  "#"
  "!TARGET_V4_FEATURES"
  [(set (match_dup 3) (eq:BI (and:SI (match_dup 1) (match_dup 2))
                             (match_dup 2)))
   (set (match_dup 0) (not:BI (match_dup 3)))]
  {
    if(reload_completed){
      operands[3] = operands[0];
    }
    else {
      operands[3] = gen_reg_rtx(BImode);
    }
  }
  [(set_attr "type" "multiple")]
)


;;---------;;
;; compare ;;
;;---------;;

(define_insn "r_cmpsi_eq"
  [(set (match_operand:SI 0 "gr_register_operand"       "=Rg,Rg,Rg,Rg")
        (eq:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand"  "Iu2,Is8, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
    %0 = cmp.eq(%1,#%2)
    %0 = cmp.eq(%1,#%2)
    %0 = cmp.eq(%1,##%2)
    %0 = cmp.eq(%1,%2)"
  [(set_attr "type" "A,A,EA,A")
   (set_attr "duplex" "no,no,no,no")]
)

(define_insn "r_cmpsi_ne"
  [(set (match_operand:SI 0 "gr_register_operand"       "=Rg,Rg,Rg")
        (ne:SI (match_operand:SI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:SI 2 "nonmemory_operand"  "Is8, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
    %0 = !cmp.eq(%1,#%2)
    %0 = !cmp.eq(%1,##%2)
    %0 = !cmp.eq(%1,%2)"
  [(set_attr "type" "A,EA,A")]
)

(define_insn "cmpqi_eq"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp")
        (eq:BI (match_operand:QI 1 "gr_register_operand" "Rg,Rg")
               (match_operand:QI 2 "nonmemory_operand"  "Iu8,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmpb.eq(%1,#%2)
   %0 = cmpb.eq(%1,%2)"
  [(set_attr "type" "X,X")]
)

(define_insn "cmpqi_gt"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp")
        (gt:BI (match_operand:QI 1 "gr_register_operand" "Rg,Rg")
               (match_operand:QI 2 "nonmemory_operand"    "i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmpb.gt(%1,#%2)
   %0 = cmpb.gt(%1,%2)"
  [(set_attr "type" "X,X")]
)

(define_insn "cmpqi_ge"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
        (ge:BI (match_operand:QI 1 "gr_register_operand" "Rg")
               (match_operand:QI 2 "immediate_operand"    "i")))]
  "TARGET_V4_FEATURES"
  {
    gcc_assert(GET_CODE (operands[2]) == CONST_INT
               && INTVAL (operands[2]) > -512);
    operands[2] = plus_constant(operands[2], -1);
    return "%0 = cmpb.gt(%1,#%2)";
  }
  [(set_attr "type" "X")]
)

(define_insn "cmpqi_gtu"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp,Rp,Rp")
        (gtu:BI (match_operand:QI 1 "gr_register_operand" "Rg,Rg,Rg")
                (match_operand:QI 2 "nonmemory_operand"  "Iu7, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmpb.gtu(%1,#%2)
   %0 = cmpb.gtu(%1,##%2)
   %0 = cmpb.gtu(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "cmpqi_geu"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (geu:BI (match_operand:QI 1 "gr_register_operand"  "Rg,Rg")
                (match_operand:QI 2 "immediate_operand" "Ku7p1, i")))]
  "TARGET_V4_FEATURES"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = cmpb.gtu(%1,#%2)";
    }
    else {
      return "%0 = cmpb.gtu(%1,##%2)";
    }
  }
  [(set_attr "type" "X,EX")]
)

(define_insn "cmphi_eq"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp,Rp")
        (eq:BI (match_operand:HI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:HI 2 "nonmemory_operand"  "Is8, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmph.eq(%1,#%2)
   %0 = cmph.eq(%1,##%2)
   %0 = cmph.eq(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "cmphi_gt"
  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp,Rp,Rp")
        (gt:BI (match_operand:HI 1 "gr_register_operand" "Rg,Rg,Rg")
               (match_operand:HI 2 "nonmemory_operand"  "Is8, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmph.gt(%1,#%2)
   %0 = cmph.gt(%1,##%2)
   %0 = cmph.gt(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "cmphi_ge"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp,Rp")
        (ge:BI (match_operand:HI 1 "gr_register_operand"  "Rg,Rg")
               (match_operand:HI 2 "immediate_operand" "Ks8p1, i")))]
  "TARGET_V4_FEATURES"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = cmph.gt(%1,#%2)";
    }
    else {
      return "%0 = cmph.gt(%1,##%2)";
    }
  }
  [(set_attr "type" "X,EX")]
)

(define_insn "cmphi_gtu"
  [(set (match_operand:BI 0 "pr_register_operand"        "=Rp,Rp,Rp")
        (gtu:BI (match_operand:HI 1 "gr_register_operand" "Rg,Rg,Rg")
                (match_operand:HI 2 "nonmemory_operand"  "Iu7, i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   %0 = cmph.gtu(%1,#%2)
   %0 = cmph.gtu(%1,##%2)
   %0 = cmph.gtu(%1,%2)"
  [(set_attr "type" "X,EX,X")]
)

(define_insn "cmphi_geu"
  [(set (match_operand:BI 0 "pr_register_operand"         "=Rp,Rp")
        (geu:BI (match_operand:HI 1 "gr_register_operand"  "Rg,Rg")
                (match_operand:HI 2 "immediate_operand" "Ks8p1, i")))]
  "TARGET_V4_FEATURES"
  {
    operands[2] = plus_constant(operands[2], -1);
    if(which_alternative == 0){
      return "%0 = cmph.gtu(%1,#%2)";
    }
    else {
      return "%0 = cmph.gtu(%1,##%2)";
    }
  }
  [(set_attr "type" "X,EX")]
)


;;-----------------;;
;; predicate logic ;;
;;-----------------;;

(define_insn "andnotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"                "=Rp")
        (and:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                (match_operand:BI 2 "pr_register_operand"         "Rp")))]
  ""
  "%0 = and(%2,!%1)"
  [(set_attr "type" "S")]
)

(define_insn "ornotbi3"
  [(set (match_operand:BI 0 "pr_register_operand"                "=Rp")
        (ior:BI (not:BI (match_operand:BI 1 "pr_register_operand" "Rp"))
                (match_operand:BI 2 "pr_register_operand"         "Rp")))]
  "TARGET_V2_FEATURES"
  "%0 = or(%2,!%1)"
  [(set_attr "type" "S")]
)


;;------;;
;; move ;;
;;------;;

(define_insn "storehhi"
  [(set (match_operand:HI 0 "memory_operand"                      "=Anoext, m")
        (subreg:HI (lshiftrt:SI (match_operand:SI 1 "register_operand" "Rg,Rg")
                                (const_int 16))
                   0))]
  ""
  "@
   memh(%0) = %1.h
   memh(%E0) = %1.h"
  [(set_attr "type" "Store,EStore")]
)

(define_insn "absloadsetbi"
  [(parallel [(set (match_operand:BI 0 "gr_register_operand"            "=Rg")
                   (mem:BI (match_operand:SI 1 "absolute_address_operand" "Q")))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memb(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsxtsetbi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (sign_extend:SI (mem:BI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memb(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadzxtsetbi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (zero_extend:SI (mem:BI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memub(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsetqi"
  [(parallel [(set (match_operand:QI 0 "gr_register_operand"            "=Rg")
                   (mem:QI (match_operand:SI 1 "absolute_address_operand" "Q")))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memb(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsxtsetqi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (sign_extend:SI (mem:QI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memb(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadzxtsetqi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (zero_extend:SI (mem:QI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memub(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsethi"
  [(parallel [(set (match_operand:HI 0 "gr_register_operand"            "=Rg")
                   (mem:HI (match_operand:SI 1 "absolute_address_operand" "Q")))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memh(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsxtsethi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (sign_extend:SI (mem:HI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memh(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadzxtsethi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"                            "=Rg")
                   (zero_extend:SI (mem:HI (match_operand:SI 1 "absolute_address_operand" "Q"))))
              (set (match_operand:SI 2 "gr_register_operand"                            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memuh(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsetsi"
  [(parallel [(set (match_operand:SI 0 "gr_register_operand"            "=Rg")
                   (mem:SI (match_operand:SI 1 "absolute_address_operand" "Q")))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memw(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absloadsetdi"
  [(parallel [(set (match_operand:DI 0 "gr_register_operand"            "=Rg")
                   (mem:DI (match_operand:SI 1 "absolute_address_operand" "Q")))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "1"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[1], operands[3])"
  "%0 = memd(%2=##%1)"
  [(set_attr "type" "ELoad")]
)

(define_insn "absstoresetbi"
  [(parallel [(set (mem:BI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:BI 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memb(%2=##%0) = %1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetbi_new_value"
  [(parallel [(set (mem:BI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (unspec:BI [(match_operand:BI 1 "gr_register_operand" "Rg")]
                              UNSPEC_NEW_VALUE))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memb(%2=##%0) = %1.new"
  [(set_attr "type" "ENewValue")]
)

(define_insn "absstoresetqi"
  [(parallel [(set (mem:QI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:QI 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memb(%2=##%0) = %1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetqi_new_value"
  [(parallel [(set (mem:QI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (unspec:QI [(match_operand:QI 1 "gr_register_operand" "Rg")]
                              UNSPEC_NEW_VALUE))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memb(%2=##%0) = %1.new"
  [(set_attr "type" "ENewValue")]
)

(define_insn "absstoresethi"
  [(parallel [(set (mem:HI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:HI 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memh(%2=##%0) = %1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresethi_new_value"
  [(parallel [(set (mem:HI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (unspec:HI [(match_operand:HI 1 "gr_register_operand" "Rg")]
                              UNSPEC_NEW_VALUE))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memh(%2=##%0) = %1.new"
  [(set_attr "type" "ENewValue")]
)

(define_insn "absstorehsethi"
  [(parallel [(set (mem:HI (match_operand:SI 0 "absolute_address_operand"             "Q"))
                   (subreg:HI (lshiftrt:SI (match_operand:SI 1 "gr_register_operand" "Rg")
                                           (const_int 16)) 0))
              (set (match_operand:SI 2 "gr_register_operand"                        "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"                     "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memh(%2=##%0) = %1.h"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetsi"
  [(parallel [(set (mem:SI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:SI 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memw(%2=##%0) = %1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetsi_new_value"
  [(parallel [(set (mem:SI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (unspec:SI [(match_operand:SI 1 "gr_register_operand" "Rg")]
                              UNSPEC_NEW_VALUE))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memw(%2=##%0) = %1.new"
  [(set_attr "type" "ENewValue")]
)

(define_insn "absstoresetdi"
  [(parallel [(set (mem:DI (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:DI 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memd(%2=##%0) = %P1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetsf"
  [(parallel [(set (mem:SF (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:SF 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memw(%2=##%0) = %1"
  [(set_attr "type" "EStore")]
)

(define_insn "absstoresetsf_new_value"
  [(parallel [(set (mem:SF (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (unspec:SF [(match_operand:SF 1 "gr_register_operand" "Rg")]
                              UNSPEC_NEW_VALUE))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memw(%2=##%0) = %1.new"
  [(set_attr "type" "ENewValue")]
)

(define_insn "absstoresetdf"
  [(parallel [(set (mem:DF (match_operand:SI 0 "absolute_address_operand" "Q"))
                   (match_operand:DF 1 "gr_register_operand"             "Rg"))
              (set (match_operand:SI 2 "gr_register_operand"            "=Rg")
                   (match_operand:SI 3 "absolute_address_operand"         "0"))])]
  "TARGET_V4_FEATURES
   && rtx_equal_p(operands[0], operands[3])"
  "memd(%2=##%0) = %P1"
  [(set_attr "type" "EStore")]
)


;;-------;;
;; memop ;;
;;-------;;

(define_insn_and_split "addqi3_memop"
  [(set (match_operand:QI 0 "memory_operand"                          "=Amemop,Aememop,Amemop,Aememop,Amemop,Aememop, Rg,Rg")
        (subreg:QI (plus:SI (subreg:SI (match_operand:QI 1 "memory_operand" "0,      0,     0,      0,     0,      0, Rg,Rg") 0)
                            (match_operand:SI 2 "nonmemory_operand"       "Iu5,    Iu5,   In5,    In5,    Rg,     Rg,Im6,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memb(%0) += #%2
   memb(%E0) += #%2
   memb(%0) -= #%n2
   memb(%E0) -= #%n2
   memb(%0) += %2
   memb(%E0) += %2
   %0 = add(%1,#%2)
   %0 = add(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (plus:SI (subreg:SI (match_dup 0) 0)
                            (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,Memop,EMemop,A,A")]
)

(define_insn_and_split "addqi3_memop2"
  [(set (match_operand:QI 0 "memory_operand"                          "=Amemop,Aememop,Rg")
        (subreg:QI (plus:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                            (subreg:SI (match_operand:QI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memb(%0) += %1
   memb(%E0) += %1
   %0 = add(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (plus:SI (match_dup 1)
                            (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)

(define_insn_and_split "addhi3_memop"
  [(set (match_operand:HI 0 "memory_operand"                          "=Amemop,Aememop,Amemop,Aememop,Amemop,Aememop, Rg,Rg")
        (subreg:HI (plus:SI (subreg:SI (match_operand:HI 1 "memory_operand" "0,      0,     0,      0,     0,      0, Rg,Rg") 0)
                            (match_operand:SI 2 "nonmemory_operand"       "Iu5,    Iu5,   In5,    In5,    Rg,     Rg,Im6,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memh(%0) += #%2
   memh(%E0) += #%2
   memh(%0) -= #%n2
   memh(%E0) -= #%n2
   memh(%0) += %2
   memh(%E0) += %2
   %0 = add(%1,#%2)
   %0 = add(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (plus:SI (subreg:SI (match_dup 0) 0)
                            (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,Memop,EMemop,A,A")]
)

(define_insn_and_split "addhi3_memop2"
  [(set (match_operand:HI 0 "memory_operand"                          "=Amemop,Aememop,Rg")
        (subreg:HI (plus:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                            (subreg:SI (match_operand:HI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memh(%0) += %1
   memh(%E0) += %1
   %0 = add(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (plus:SI (match_dup 1)
                            (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)

(define_insn_and_split "subqi3_memop"
  [(set (match_operand:QI 0 "memory_operand"                           "=Amemop,Aememop,Rg")
        (subreg:QI (minus:SI (subreg:SI (match_operand:QI 1 "memory_operand" "0,      0,Rg") 0)
                             (match_operand:SI 2 "gr_register_operand"      "Rg,     Rg,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memb(%0) -= %2
   memb(%E0) -= %2
   %0 = sub(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (minus:SI (subreg:SI (match_dup 0) 0)
                             (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)

(define_insn_and_split "subhi3_memop"
  [(set (match_operand:HI 0 "memory_operand"                           "=Amemop,Rg")
        (subreg:HI (minus:SI (subreg:SI (match_operand:HI 1 "memory_operand" "0,Rg") 0)
                             (match_operand:SI 2 "gr_register_operand"      "Rg,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memh(%0) -= %2
   %0 = sub(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (minus:SI (subreg:SI (match_dup 0) 0)
                             (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,A")]
)

(define_insn_and_split "andqi3_memop"
  [(set (match_operand:QI 0 "memory_operand"                         "=Amemop,  Aememop,Amemop,Aememop,       Rg,Rg")
        (subreg:QI (and:SI (subreg:SI (match_operand:QI 1 "memory_operand" "0,        0,     0,      0,       Rg,Rg") 0)
                           (match_operand:SI 2 "nonmemory_operand" "Konenot32,Konenot32,    Rg,     Rg,Konenot32,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memb(%0) = clrbit(#%K2)
   memb(%E0) = clrbit(#%K2)
   memb(%0) &= %2
   memb(%E0) &= %2
   %0 = clrbit(%1,#%K2)
   %0 = and(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (and:SI (subreg:SI (match_dup 0) 0)
                           (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,S,A")]
)

(define_insn_and_split "andqi3_memop2"
  [(set (match_operand:QI 0 "memory_operand"                         "=Amemop,Aememop,Rg")
        (subreg:QI (and:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                           (subreg:SI (match_operand:QI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memb(%0) &= %1
   memb(%E0) &= %1
   %0 = and(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (and:SI (match_dup 1)
                           (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,Memop,A")]
)

(define_insn_and_split "andhi3_memop"
  [(set (match_operand:HI 0 "memory_operand"                         "=Amemop,  Aememop,Amemop,Aememop,       Rg,Rg")
        (subreg:HI (and:SI (subreg:SI (match_operand:HI 1 "memory_operand" "0,        0,     0,      0,       Rg,Rg") 0)
                           (match_operand:SI 2 "nonmemory_operand" "Konenot32,Konenot32,    Rg,     Rg,Konenot32,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memh(%0) = clrbit(#%K2)
   memh(%E0) = clrbit(#%K2)
   memh(%0) &= %2
   memh(%E0) &= %2
   %0 = clrbit(%1,#%K2)
   %0 = and(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (and:SI (subreg:SI (match_dup 0) 0)
                           (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,S,A")]
)

(define_insn_and_split "andhi3_memop2"
  [(set (match_operand:HI 0 "memory_operand"                         "=Amemop,Aememop,Rg")
        (subreg:HI (and:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                           (subreg:SI (match_operand:HI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memh(%0) &= %1
   memh(%E0) &= %1
   %0 = and(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (and:SI (match_dup 1)
                           (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)

(define_insn_and_split "iorqi3_memop"
  [(set (match_operand:QI 0 "memory_operand"                         "=Amemop,  Aememop,Amemop,Aememop,       Rg,Rg")
        (subreg:QI (ior:SI (subreg:SI (match_operand:QI 1 "memory_operand" "0,        0,     0,      0,       Rg,Rg") 0)
                           (match_operand:SI 2 "nonmemory_operand" "Konehot32,Konehot32,    Rg,     Rg,Konehot32,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memb(%0) = setbit(#%J2)
   memb(%E0) = setbit(#%J2)
   memb(%0) |= %2
   memb(%E0) |= %2
   %0 = setbit(%1,#%J2)
   %0 = or(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (ior:SI (subreg:SI (match_dup 0) 0)
                           (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,S,A")]
)

(define_insn_and_split "iorqi3_memop2"
  [(set (match_operand:QI 0 "memory_operand"                         "=Amemop,Aememop,Rg")
        (subreg:QI (ior:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                           (subreg:SI (match_operand:QI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memb(%0) |= %1
   memb(%E0) |= %1
   %0 = or(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], QImode)
   && !qdsp6_legitimate_address_p(QImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:QI (ior:SI (match_dup 1)
                           (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], QImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)

(define_insn_and_split "iorhi3_memop"
  [(set (match_operand:HI 0 "memory_operand"                         "=Amemop,  Aememop,Amemop,Aememop,       Rg,Rg")
        (subreg:HI (ior:SI (subreg:SI (match_operand:HI 1 "memory_operand" "0,        0,     0,      0,       Rg,Rg") 0)
                           (match_operand:SI 2 "nonmemory_operand" "Konehot32,Konehot32,    Rg,     Rg,Konehot32,Rg")) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[1])"
  "@
   memh(%0) = setbit(#%J2)
   memh(%E0) = setbit(#%J2)
   memh(%0) |= %2
   memh(%E0) |= %2
   %0 = setbit(%1,#%J2)
   %0 = or(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (ior:SI (subreg:SI (match_dup 0) 0)
                           (match_dup 2)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,Memop,EMemop,S,A")]
)

(define_insn_and_split "iorhi3_memop2"
  [(set (match_operand:HI 0 "memory_operand"                         "=Amemop,Aememop,Rg")
        (subreg:HI (ior:SI (match_operand:SI 1 "gr_register_operand"      "Rg,     Rg,Rg")
                           (subreg:SI (match_operand:HI 2 "memory_operand" "0,      0,Rg") 0)) 0))]
  "TARGET_V4_FEATURES && TARGET_MEMOPS && rtx_equal_p(operands[0], operands[2])"
  "@
   memh(%0) |= %1
   memh(%E0) |= %1
   %0 = or(%1,%2)"
  "&& !reload_completed
   && memory_operand(operands[0], HImode)
   && !qdsp6_legitimate_address_p(HImode, XEXP (operands[0], 0),
                                  reload_in_progress || reload_completed,
                                  \"ememop\")"
  [(set (match_dup 0)
        (subreg:HI (ior:SI (match_dup 1)
                           (subreg:SI (match_dup 0) 0)) 0))]
  {
    rtx address;
    rtx address_reg;
    address = XEXP (operands[0], 0);
    address_reg = gen_reg_rtx(Pmode);
    emit_move_insn(address_reg, address);
    operands[0] = change_address(operands[0], HImode, address_reg);
  }
  [(set_attr "type" "Memop,EMemop,A")]
)




;;-------------------------------------------;;
;; Patterns Emitted by Machine Specific Code ;;
;;-------------------------------------------;;



(define_insn "return_jump"
  [(return)]
  ""
  "jumpr r31"
  [(set_attr "type" "JR")
   (set_attr "duplex" "yes")]
)

(define_expand "allocframe"
  [(parallel [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
                   (reg:SI LINK_REGNUM))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
                   (reg:SI FP_REGNUM))
              (set (reg:SI FP_REGNUM)
                   (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
              (set (reg:SI SP_REGNUM)
                   (minus:SI (reg:SI SP_REGNUM)
                             (match_operand 0 "const_int_operand" "")))])]
  ""
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) + 8, SImode);
  }
)

(define_insn "allocframe_real"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
        (reg:SI LINK_REGNUM))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
        (reg:SI FP_REGNUM))
   (set (reg:SI FP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
   (set (reg:SI SP_REGNUM)
        (minus:SI (reg:SI SP_REGNUM)
                  (match_operand 0 "const_int_operand" "i,Ku5_3p8")))]
  ""
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) - 8, SImode);
    switch(which_alternative){
    case 0:
      return "allocframe(#%0)";
    case 1:
      return "allocframe(#%0)";
    }
  }
  [(set_attr "type" "Store,Store")
   (set_attr "duplex" "no,yes")]
)

(define_expand "allocframe_and_save_r16"
  [(parallel [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
                   (reg:SI LINK_REGNUM))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
                   (reg:SI FP_REGNUM))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12)))
                   (reg:SI 16))
              (set (reg:SI FP_REGNUM)
                   (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
              (set (reg:SI SP_REGNUM)
                   (minus:SI (reg:SI SP_REGNUM)
                             (match_operand 0 "const_int_operand" "")))])]
  "TARGET_V4_FEATURES"
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) + 8, SImode);
  }
)

(define_insn "allocframe_and_save_r16_real"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
        (reg:SI LINK_REGNUM))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
        (reg:SI FP_REGNUM))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12)))
        (reg:SI 16))
   (set (reg:SI FP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
   (set (reg:SI SP_REGNUM)
        (minus:SI (reg:SI SP_REGNUM)
                  (match_operand 0 "const_int_operand" "i")))]
  "TARGET_V4_FEATURES"
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) - 8, SImode);
    return "memw(r29+#-12) = r16\;allocframe(#%0)";
  }
  [(set_attr "type" "LoadStore")]
)

(define_expand "allocframe_and_save_r16_and_r17"
  [(parallel [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
                   (reg:SI LINK_REGNUM))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
                   (reg:SI FP_REGNUM))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12)))
                   (reg:SI 17))
              (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -16)))
                   (reg:SI 16))
              (set (reg:SI FP_REGNUM)
                   (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
              (set (reg:SI SP_REGNUM)
                   (minus:SI (reg:SI SP_REGNUM)
                             (match_operand 0 "const_int_operand" "")))])]
  "TARGET_V4_FEATURES"
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) + 8, SImode);
  }
)

(define_insn "allocframe_and_save_r16_and_r17_real"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4)))
        (reg:SI LINK_REGNUM))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
        (reg:SI FP_REGNUM))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12)))
        (reg:SI 17))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -16)))
        (reg:SI 16))
   (set (reg:SI FP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM) (const_int -8)))
   (set (reg:SI SP_REGNUM)
        (minus:SI (reg:SI SP_REGNUM)
                  (match_operand 0 "const_int_operand" "i")))]
  "TARGET_V4_FEATURES"
  {
    operands[0] = gen_int_mode(INTVAL (operands[0]) - 8, SImode);
    return "memd(r29+#-16) = r17:16\;allocframe(#%0)";
  }
  [(set_attr "type" "LoadStore")]
)

(define_expand "increment_stack_pointer"
  [(set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "nonmemory_operand" "")))]
  ""
  ""
)

(define_insn "allocate_stack_and_save_r16"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4))) (reg:SI 16))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "const_int_operand" "i,Rg")))]
  ""
  "@
   memw(r29+#-4) = r16\;r29 = add(r29,#%0)
   memw(r29+#-4) = r16\;r29 = add(r29,%0)"
  [(set_attr "type" "AStore,AStore")]
)

(define_insn "allocate_stack_and_save_r16_and_r17"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4))) (reg:SI 17))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "const_int_operand" "i,Rg")))]
  ""
  "@
   memd(r29+#-8) = r17:16\;r29 = add(r29,#%0)
   memd(r29+#-8) = r17:16\;r29 = add(r29,%0)"
  [(set_attr "type" "AStore,AStore")]
)

(define_insn "allocate_stack_and_save_r16_through_r18"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4))) (reg:SI 17))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12))) (reg:SI 18))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "const_int_operand" "i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   memd(r29+#-8) = r17:16\;memw(r29+#-12) = r18\;r29 = add(r29,#%0)
   memd(r29+#-8) = r17:16\;memw(r29+#-12) = r18\;r29 = add(r29,%0)"
  [(set_attr "type" "ALoadStore,ALoadStore")]
)

(define_insn "allocate_stack_and_save_r16_through_r19"
  [(set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -4))) (reg:SI 17))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI SP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI SP_REGNUM)
                 (match_operand 0 "const_int_operand" "i,Rg")))]
  "TARGET_V4_FEATURES"
  "@
   memd(r29+#-8) = r17:16\;memd(r29+#-16) = r19:18\;r29 = add(r29,#%0)
   memd(r29+#-8) = r17:16\;memd(r29+#-16) = r19:18\;r29 = add(r29,%0)"
  [(set_attr "type" "ALoadStore,ALoadStore")]
)

(define_insn "deallocframe"
  [(set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "deallocframe"
  [(set_attr "type" "Load")
   (set_attr "duplex" "yes")]
)

(define_insn "save_r24_through_r27"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 26))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 27))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 24))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 25))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r24_through_r27"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r24_through_r27_and_deallocframe_before_sibcall"
  [(set (reg:SI 26) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 27) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r24_through_r27_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r24_through_r25_and_deallocframe_before_sibcall"
  [(set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r24_through_r25_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r24_through_r27_and_deallocframe"
  [(return)
   (set (reg:SI 26) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 27) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r24_through_r27_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r24_through_r25_and_deallocframe"
  [(return)
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r24_through_r25_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "save_r16_through_r19"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 17))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r16_through_r19"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "save_r16_through_r21"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))) (reg:SI 20))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))) (reg:SI 21))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 17))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r16_through_r21"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "save_r16_through_r23"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))) (reg:SI 22))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))) (reg:SI 23))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))) (reg:SI 20))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))) (reg:SI 21))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 17))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r16_through_r23"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "save_r16_through_r25"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))) (reg:SI 24))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))) (reg:SI 25))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))) (reg:SI 22))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))) (reg:SI 23))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))) (reg:SI 20))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))) (reg:SI 21))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 17))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r16_through_r25"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "save_r16_through_r27"
  [(set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -48))) (reg:SI 26))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -44))) (reg:SI 27))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))) (reg:SI 24))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))) (reg:SI 25))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))) (reg:SI 22))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))) (reg:SI 23))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))) (reg:SI 20))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))) (reg:SI 21))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))) (reg:SI 18))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))) (reg:SI 19))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))) (reg:SI 16))
   (set (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))) (reg:SI 17))
   (clobber (reg:SI 28))
   (clobber (reg:SI LINK_REGNUM))]
  ""
  "call __save_r16_through_r27"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r27_and_deallocframe_before_sibcall"
  [(set (reg:SI 26) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -48))))
   (set (reg:SI 27) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -44))))
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))))
   (set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r27_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r25_and_deallocframe_before_sibcall"
  [(set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))))
   (set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r25_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r23_and_deallocframe_before_sibcall"
  [(set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r23_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r21_and_deallocframe_before_sibcall"
  [(set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r21_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r19_and_deallocframe_before_sibcall"
  [(set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r19_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r17_and_deallocframe_before_sibcall"
  [(set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))
   (clobber (reg:SI 28))]
  ""
  "call __restore_r16_through_r17_and_deallocframe_before_tailcall"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r27_and_deallocframe"
  [(return)
   (set (reg:SI 26) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -48))))
   (set (reg:SI 27) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -44))))
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))))
   (set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r27_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r25_and_deallocframe"
  [(return)
   (set (reg:SI 24) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -40))))
   (set (reg:SI 25) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -36))))
   (set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r25_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r23_and_deallocframe"
  [(return)
   (set (reg:SI 22) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -32))))
   (set (reg:SI 23) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -28))))
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r23_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r21_and_deallocframe"
  [(return)
   (set (reg:SI 20) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -24))))
   (set (reg:SI 21) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -20))))
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r21_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r19_and_deallocframe"
  [(return)
   (set (reg:SI 18) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -16))))
   (set (reg:SI 19) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -12))))
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r19_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "restore_r16_through_r17_and_deallocframe"
  [(return)
   (set (reg:SI 16) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -8))))
   (set (reg:SI 17) (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int -4))))
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  ""
  "jump __restore_r16_through_r17_and_deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "deallocframe_return"
  [(return)
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  "TARGET_V4_FEATURES"
  "dealloc_return"
  [(set_attr "type" "NewValue")
   (set_attr "duplex" "yes")]
)

(define_insn "deallocframe_function"
  [(return)
   (set (reg:SI SP_REGNUM)
        (plus:SI (reg:SI FP_REGNUM) (const_int 8)))
   (set (reg:SI LINK_REGNUM)
        (mem:SI (plus:SI (reg:SI FP_REGNUM) (const_int 4))))
   (set (reg:SI FP_REGNUM)
        (mem:SI (reg:SI FP_REGNUM)))]
  "!TARGET_V4_FEATURES"
  "jump __deallocframe"
  [(set_attr "type" "J")
   (set_attr "emulation_call" "yes")]
)

(define_insn "falign"
  [(unspec_volatile [(const_int 0)] UNSPEC_QDSP6_falign)]
  ""
  ".falign"
  [(set_attr "length" "12")]
)

(define_insn "memcpy_kernelqi"
  [(set (match_operand:QI 0 "memory_operand"       "=m")
        (match_operand:QI 1 "gr_register_operand"  "Rg"))
   (set (match_operand:QI 2 "gr_register_operand" "=Rg")
        (match_operand:QI 3 "memory_operand"        "m"))]
  ""
  "memb(%0) = %1\;%2 = memb(%3)"
  [(set_attr "type" "LoadStore")]
)

(define_insn "memcpy_kernelhi"
  [(set (match_operand:HI 0 "memory_operand"       "=m")
        (match_operand:HI 1 "gr_register_operand"  "Rg"))
   (set (match_operand:HI 2 "gr_register_operand" "=Rg")
        (match_operand:HI 3 "memory_operand"        "m"))]
  ""
  "memh(%0) = %1\;%2 = memh(%3)"
  [(set_attr "type" "LoadStore")]
)

(define_insn "memcpy_kernelsi"
  [(set (match_operand:SI 0 "memory_operand"  "=Anoext")
        (match_operand:SI 1 "gr_register_operand"  "Rg"))
   (set (match_operand:SI 2 "gr_register_operand" "=Rg")
        (match_operand:SI 3 "memory_operand"   "Anoext"))]
  ""
  "memw(%0) = %1\;%2 = memw(%3)"
  [(set_attr "type" "LoadStore")]
)

(define_insn "memcpy_kerneldi"
  [(set (match_operand:DI 0 "memory_operand"  "=Anoext")
        (match_operand:DI 1 "gr_register_operand"  "Rg"))
   (set (match_operand:DI 2 "gr_register_operand" "=Rg")
        (match_operand:DI 3 "memory_operand"   "Anoext"))]
  ""
  "memd(%0) = %1\;%2 = memd(%3)"
  [(set_attr "type" "LoadStore")]
)

(define_insn "vcmpb_eq"
  [(set (match_operand:BI 0 "pr_register_operand"  "=Rp")
        (unspec:BI [
          (match_operand:DI 1 "gr_register_operand" "Rg")
          (match_operand:DI 2 "gr_register_operand" "Rg")
        ] UNSPEC_QDSP6_vcmpb_eq))]
  ""
  "%0 = vcmpb.eq(%P1,%P2)"
  [(set_attr "type" "X")]
)

(define_insn "vcmpb_gtu"
  [(set (match_operand:BI 0 "pr_register_operand"  "=Rp")
        (unspec:BI [
          (match_operand:DI 1 "gr_register_operand" "Rg")
          (match_operand:DI 2 "gr_register_operand" "Rg")
        ] UNSPEC_QDSP6_vcmpb_gtu))]
  ""
  "%0 = vcmpb.gtu(%P1,%P2)"
  [(set_attr "type" "X")]
)

(define_insn "any8"
  [(set (match_operand:BI 0 "pr_register_operand"  "=Rp")
        (unspec:BI [
          (match_operand:BI 1 "pr_register_operand" "Rp")
        ] UNSPEC_QDSP6_any))]
  ""
  "%0 = any8(%1)"
  [(set_attr "type" "S")]
)

(define_insn "all8"
  [(set (match_operand:BI 0 "pr_register_operand"  "=Rp")
        (unspec:BI [
          (match_operand:BI 1 "pr_register_operand" "Rp")
        ] UNSPEC_QDSP6_all))]
  ""
  "%0 = all8(%1)"
  [(set_attr "type" "S")]
)

;;(define_insn "move_predicate_to_reg"
;;  [(set (match_operand:SI 0 "gr_register_operand"                "=Rg")
;;        (zero_extend:SI (match_operand:BI 1 "pr_register_operand" "Rp")))]
;;  ""
;;  "%0 = %1"
;;  [(set_attr "type" "S")]
;;)




;;-------------------;;
;; Peephole Patterns ;;
;;-------------------;;


; Optimized case for r0 = mux(!p0, r0, r2)
; Change to if (p0) r0 = r2
; This form can be transformed to a dot-new transfer
(define_peephole2 
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (if_then_else:SI
          (eq:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (const_int 0))
	  (match_dup 0)
          (match_operand:SI 2 "nonmemory_operand"     "Rg")))]
  "TARGET_PRED_MUX"
  [(cond_exec
     (ne:BI (match_dup 1) (const_int 0))
     (set (match_dup 0) (match_dup 2)))]
  ""
)

; Optimized case for r0 = mux(!p0, r2, r0)
; Change to if (!p0) r0 = r2
; This form can be transformed to a dot-new transfer
(define_peephole2 
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (if_then_else:SI
          (eq:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (const_int 0))
	  (match_operand:SI 2 "nonmemory_operand"     "Rg")
          (match_dup 0)))]
  "TARGET_PRED_MUX"
  [(cond_exec
     (eq:BI (match_dup 1) (const_int 0))
     (set (match_dup 0) (match_dup 2)))]
  ""
)


; Optimized case for r0 = mux(p0, r0, r2)
; Change to if (!p0) r0 = r2
; This form can be transformed to a dot-new transfer
(define_peephole2 
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (if_then_else:SI
          (ne:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (const_int 0))
	  (match_dup 0)
          (match_operand:SI 2 "nonmemory_operand"     "Rg")))]
  "TARGET_PRED_MUX"
  [(cond_exec
     (eq:BI (match_dup 1) (const_int 0))
     (set (match_dup 0) (match_dup 2)))]
  ""
)

; Optimized case for r0 = mux(p0, r2, r0)
; Change to if (p0) r0 = r2
; This form can be transformed to a dot-new transfer
(define_peephole2 
  [(set (match_operand:SI 0 "gr_register_operand"    "=Rg")
        (if_then_else:SI
          (ne:BI
            (match_operand:BI 1 "pr_register_operand" "Rp")
            (const_int 0))
	  (match_operand:SI 2 "nonmemory_operand"     "Rg")
          (match_dup 0)))]
  "TARGET_PRED_MUX"
  [(cond_exec
     (ne:BI (match_dup 1) (const_int 0))
     (set (match_dup 0) (match_dup 2)))]
  ""
)



(define_peephole2
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (match_operand:SI 1 "gr_register_operand" ""))
   (set (match_operand:SI 2 "gr_register_operand" "")
        (match_operand:SI 3 "gr_register_operand" ""))]
  "   (   true_regnum(operands[0]) % 2 == 0
       && true_regnum(operands[0]) + 1 == true_regnum(operands[2]))
   || (   true_regnum(operands[2]) % 2 == 0
       && true_regnum(operands[2]) + 1 == true_regnum(operands[0]))"
  [(parallel [(set (match_dup 0) (match_dup 1))
              (set (match_dup 2) (match_dup 3))])]
  {
    if(true_regnum(operands[3]) == true_regnum(operands[0])){
      operands[3] = operands[1];
    }
  }
)

(define_peephole2
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (match_operand:SI 1 "immediate_operand" ""))
   (set (match_operand:SI 2 "gr_register_operand" "")
        (match_operand:SI 3 "immediate_operand" ""))]
  "((TARGET_CONST64
     && const_int_operand(operands[1], SImode)
     && const_int_operand(operands[3], SImode))
    || (TARGET_V4_FEATURES
        && (   s8_const_int_operand(operands[1], SImode)
            || s8_const_int_operand(operands[3], SImode)))
    || (   s8_const_int_operand(operands[1], SImode)
        && s8_const_int_operand(operands[3], SImode)))
   && (!optimize_size
       || s8_const_int_operand(operands[1], SImode)
       || s8_const_int_operand(operands[3], SImode)
       || !s16_const_int_operand(operands[1], SImode)
       || !s16_const_int_operand(operands[3], SImode))
   && (
          (   true_regnum(operands[0]) % 2 == 0
           && true_regnum(operands[0]) + 1 == true_regnum(operands[2]))
       || (   true_regnum(operands[2]) % 2 == 0
           && true_regnum(operands[2]) + 1 == true_regnum(operands[0])))"
  [(parallel [(set (match_dup 0) (match_dup 1))
              (set (match_dup 2) (match_dup 3))])]
  ""
)

(define_peephole2
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (match_operand:SI 1 "gr_register_operand" ""))
   (set (match_operand:SI 2 "gr_register_operand" "")
        (match_operand:SI 3 "immediate_operand" ""))]
  "TARGET_V4_FEATURES
   && (   (   true_regnum(operands[0]) % 2 == 0
           && true_regnum(operands[0]) + 1 == true_regnum(operands[2]))
       || (   true_regnum(operands[2]) % 2 == 0
           && true_regnum(operands[2]) + 1 == true_regnum(operands[0])))"
  [(parallel [(set (match_dup 0) (match_dup 1))
              (set (match_dup 2) (match_dup 3))])]
  ""
)

(define_peephole2
  [(set (match_operand:SI 0 "gr_register_operand" "")
        (match_operand:SI 1 "immediate_operand" ""))
   (set (match_operand:SI 2 "gr_register_operand" "")
        (match_operand:SI 3 "gr_register_operand" ""))]
  "TARGET_V4_FEATURES
   && (   (   true_regnum(operands[0]) % 2 == 0
           && true_regnum(operands[0]) + 1 == true_regnum(operands[2]))
       || (   true_regnum(operands[2]) % 2 == 0
           && true_regnum(operands[2]) + 1 == true_regnum(operands[0])))
   && (true_regnum(operands[3]) != true_regnum(operands[0])
       || s8_const_int_operand(operands[1], SImode)
       || (TARGET_CONST64 && const_int_operand(operands[1], SImode)))"
  [(parallel [(set (match_dup 0) (match_dup 1))
              (set (match_dup 2) (match_dup 3))])]
  {
    if(true_regnum(operands[3]) == true_regnum(operands[0])){
      operands[3] = operands[1];
    }
  }
)

(define_peephole2
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (not:BI (match_operand:BI 1 "pr_register_operand" "")))
   (set (pc)
        (if_then_else (ne:BI (match_operand:BI 2 "pr_register_operand" "")
                             (const_int 0))
                      (match_operand 3 "" "")
                      (match_operand 4 "" "")))]
  "true_regnum(operands[2]) == true_regnum(operands[0])
   && peep2_reg_dead_p(2, operands[0])"
  [(set (pc)
        (if_then_else:SI (eq:BI (match_dup 1) (const_int 0))
                         (match_dup 3)
                         (match_dup 4)))]
  ""
)

(define_peephole2
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (not:BI (match_operand:BI 1 "pr_register_operand" "")))
   (set (pc)
        (if_then_else (eq:BI (match_operand:BI 2 "pr_register_operand" "")
                             (const_int 0))
                      (match_operand 3 "" "")
                      (match_operand 4 "" "")))]
  "true_regnum(operands[2]) == true_regnum(operands[0])
   && peep2_reg_dead_p(2, operands[0])"
  [(set (pc)
        (if_then_else:SI (ne:BI (match_dup 1) (const_int 0))
                         (match_dup 3)
                         (match_dup 4)))]
  ""
)

(define_peephole2
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (not:BI (match_operand:BI 1 "pr_register_operand" "")))
   (set (match_operand 2 "" "")
        (if_then_else (ne:BI (match_operand:BI 3 "pr_register_operand" "")
                             (const_int 0))
                      (match_operand 4 "" "")
                      (match_operand 5 "" "")))]
  "true_regnum(operands[3]) == true_regnum(operands[0])
   && peep2_reg_dead_p(2, operands[0])"
  [(set (match_dup 2)
        (if_then_else:SI (eq:BI (match_dup 1) (const_int 0))
                         (match_dup 4)
                         (match_dup 5)))]
  ""
)

(define_peephole2
  [(set (match_operand:BI 0 "pr_register_operand" "")
        (not:BI (match_operand:BI 1 "pr_register_operand" "")))
   (set (match_operand 2 "" "")
        (if_then_else (eq:BI (match_operand:BI 3 "pr_register_operand" "")
                             (const_int 0))
                      (match_operand 4 "" "")
                      (match_operand 5 "" "")))]
  "true_regnum(operands[3]) == true_regnum(operands[0])
   && peep2_reg_dead_p(2, operands[0])"
  [(set (match_dup 2)
        (if_then_else:SI (ne:BI (match_dup 1) (const_int 0))
                         (match_dup 4)
                         (match_dup 5)))]
  ""
)





;;--------------------------------;;
;; Patterns Produced by Peepholes ;;
;;--------------------------------;;



(define_insn_and_split "combinesi_v4"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg, Rg, Rg, Rg, Rg, Rg,Rg, Rg, Rg, Rg,Rg,Rg")
        (match_operand:SI 1 "nonmemory_operand"    "Rg,Iu2,Is8,Is8,  i, Rg,Rg,Iu0, Rg,Is8, i, i"))
   (set (match_operand:SI 2 "gr_register_operand" "=Rg, Rg, Rg, Rg, Rg, Rg,Rg, Rg, Rg, Rg, Rg,Rg")
        (match_operand:SI 3 "nonmemory_operand"    "Rg,Iu2,Is8,  i,Is8,Is8, i, Rg,Iu0, Rg, Rg, i"))]
  "reload_completed && TARGET_V4_FEATURES"
  {
    HOST_WIDE_INT high, low;

    if(REGNO (operands[0]) % 2 == 0){
      switch(which_alternative){
        case 0:
          return "%P0 = combine(%3,%1)";
        case 1:
          return "%P0 = combine(#%3,#%1)";
        case 2:
          return "%P0 = combine(#%3,#%1)";
        case 3:
          return "%P0 = combine(##%3,#%1)";
        case 4:
          return "%P0 = combine(#%3,##%1)";
        case 5:
          return "%P0 = combine(#%3,%1)";
        case 6:
          return "%P0 = combine(##%3,%1)";
        case 7:
          return "%P0 = combine(%3,#%1)";
        case 8:
          return "%P0 = combine(#%3,%1)";
        case 9:
          return "%P0 = combine(%3,#%1)";
        case 10:
          return "%P0 = combine(%3,##%1)";
        case 11:
          gcc_assert(TARGET_CONST64);
          gcc_assert(const_int_operand(operands[1], SImode));
          gcc_assert(const_int_operand(operands[3], SImode));
          low = INTVAL (operands[1]);
          high = INTVAL (operands[3]);
          operands[1] = gen_int_mode((high << 32ULL) | (low & 0x0FFFFFFFFULL),
                                     DImode);
          return "%P0 = CONST64(#%1)";
        default:
          gcc_unreachable();
      }
    }
    else {
      switch(which_alternative){
        case 0:
          return "%P2 = combine(%1,%3)";
        case 1:
          return "%P2 = combine(#%1,#%3)";
        case 2:
          return "%P2 = combine(#%1,#%3)";
        case 3:
          return "%P2 = combine(#%1,##%3)";
        case 4:
          return "%P2 = combine(##%1,#%3)";
        case 5:
          return "%P2 = combine(%1,#%3)";
        case 6:
          return "%P2 = combine(%1,##%3)";
        case 7:
          return "%P2 = combine(#%1,%3)";
        case 8:
          return "%P2 = combine(%1,#%3)";
        case 9:
          return "%P2 = combine(#%1,%3)";
        case 10:
          return "%P2 = combine(##%1,%3)";
        case 11:
          gcc_assert(TARGET_CONST64);
          gcc_assert(const_int_operand(operands[1], SImode));
          gcc_assert(const_int_operand(operands[3], SImode));
          low = INTVAL (operands[3]);
          high = INTVAL (operands[1]);
          operands[1] = gen_int_mode((high << 32ULL) | (low & 0x0FFFFFFFFULL),
                                     DImode);
          return "%P2 = CONST64(#%1)";
        default:
          gcc_unreachable();
      }
    }
  }
  "&& !(   (   REGNO (operands[0]) % 2 == 0
            && REGNO (operands[0]) + 1 == REGNO (operands[2]))
        || (   REGNO (operands[2]) % 2 == 0
            && REGNO (operands[2]) + 1 == REGNO (operands[0])))"
  [(set (match_dup 0) (match_dup 1))
   (set (match_dup 2) (match_dup 3))]
  {
    gcc_assert(!(   REG_P (operands[0]) && REG_P (operands[1]) 
                    && REG_P (operands[2]) && REG_P (operands[3])  
                    && REGNO (operands[0]) == REGNO (operands[3]) 
                    && REGNO (operands[1]) == REGNO (operands[2]) ));

    /* When this condition is true, it is likely that we have
       a violation of parallel semantics. This pattern was likely
       produced by a peephole, and later altered by reg rename
       making it inappropriate for paired register usage. Also,
       cprop might have propagated a register usage into the
       parallel structure, resulting in this code.
       If we do not have this king of assignment:
       parallel [ r0=r2; r2=r0]
       we can reverse the order of instructions in parallel
       structure as we split it. 
       See bug 3855 for details. */ 

    if((REG_P (operands[0]) && REG_P (operands[3])
        && REGNO (operands[0]) == REGNO (operands[3]))){

        rtx tmp; 

        tmp = operands[0];   
        operands[0] = operands[2];
        operands[2] = tmp; 

        tmp = operands[1]; 
        operands[1] = operands[3];
        operands[3] = tmp; 
    }
  }
  [(set_attr "type" "A,A,A,EA,EA,A,EA,A,A,A,EA,Load")
   (set_attr "duplex" "no,yes,no,no,no,no,no,yes,yes,no,no,no")]
)

(define_insn_and_split "combinesi"
  [(set (match_operand:SI 0 "gr_register_operand" "=Rg, Rg,Rg")
        (match_operand:SI 1 "nonmemory_operand"    "Rg,Is8, i"))
   (set (match_operand:SI 2 "gr_register_operand" "=Rg, Rg,Rg")
        (match_operand:SI 3 "nonmemory_operand"    "Rg,Is8, i"))]
  "reload_completed"
  {
    HOST_WIDE_INT high, low;

    if(REGNO (operands[0]) % 2 == 0){
      switch(which_alternative){
        case 0:
          return "%P0 = combine(%3,%1)";
        case 1:
          return "%P0 = combine(#%3,#%1)";
        case 2:
          gcc_assert(TARGET_CONST64);
          gcc_assert(const_int_operand(operands[1], SImode));
          gcc_assert(const_int_operand(operands[3], SImode));
          low = INTVAL (operands[1]);
          high = INTVAL (operands[3]);
          operands[1] = gen_int_mode((high << 32ULL) | (low & 0x0FFFFFFFFULL),
                                     DImode);
          return "%P0 = CONST64(#%1)";
        default:
          gcc_unreachable();
      }
    }
    else {
      switch(which_alternative){
        case 0:
          return "%P2 = combine(%1,%3)";
        case 1:
          return "%P2 = combine(#%1,#%3)";
        case 2:
          gcc_assert(TARGET_CONST64);
          gcc_assert(const_int_operand(operands[1], SImode));
          gcc_assert(const_int_operand(operands[3], SImode));
          low = INTVAL (operands[3]);
          high = INTVAL (operands[1]);
          operands[1] = gen_int_mode((high << 32ULL) | (low & 0x0FFFFFFFFULL),
                                     DImode);
          return "%P2 = CONST64(#%1)";
        default:
          gcc_unreachable();
      }
    }
  }
  "&& !(   (   REGNO (operands[0]) % 2 == 0
            && REGNO (operands[0]) + 1 == REGNO (operands[2]))
        || (   REGNO (operands[2]) % 2 == 0
            && REGNO (operands[2]) + 1 == REGNO (operands[0])))"
  [(set (match_dup 0) (match_dup 1))
   (set (match_dup 2) (match_dup 3))]
  {
    gcc_assert(!(   REG_P (operands[0]) && REG_P (operands[1]) 
                    && REG_P (operands[2]) && REG_P (operands[3])  
                    && REGNO (operands[0]) == REGNO (operands[3]) 
                    && REGNO (operands[1]) == REGNO (operands[2]) ));

    /* When this condition is true, it is likely that we have
       a violation of parallel semantics. This pattern was likely
       produced by a peephole, and later altered by reg rename
       making it inappropriate for paired register usage. Also,
       cprop might have propagated a register usage into the
       parallel structure, resulting in this code.
       If we do not have this king of assignment:
       parallel [ r0=r2; r2=r0]
       we can reverse the order of instructions in parallel
       structure as we split it. 
       See bug 3855 for details. */ 

    if((REG_P (operands[0]) && REG_P (operands[3])
        && REGNO (operands[0]) == REGNO (operands[3]))){

        rtx tmp; 

        tmp = operands[0];   
        operands[0] = operands[2];
        operands[2] = tmp; 

        tmp = operands[1]; 
        operands[1] = operands[3];
        operands[3] = tmp; 
    }
  }
  [(set_attr "type" "A,A,Load")
   (set_attr "duplex" "no,no,no")]
)

;;;---------------------------------
;;; 32 bit floating point arithmetic
;;;---------------------------------
;
;;;----------
;;; add[sd]f3
;;;----------
;
;(define_insn "addsf3"
;  [(set (match_operand:SF 0 "gr_register_operand" "=r")
;        (plus:SF (match_operand:SF 1 "gr_register_operand" "r")
;                 (match_operand:SF 2 "gr_register_operand" "r")))]
;  ""
;  "%0 = sfadd(%1, %2)"
;)
;
;(define_insn "adddf3"
;  [(set (match_operand:DF 0 "gr_register_operand" "=r")
;        (plus:DF (match_operand:DF 1 "gr_register_operand" "r")
;                 (match_operand:DF 2 "gr_register_operand" "r")))]
;  ""
;  "%0 = dfadd(%1, %2)"
;)
;
;;;----------
;;; sub[sd]f3
;;;----------
;
;(define_insn "subsf3"
;  [(set (match_operand:SF 0 "gr_register_operand" "=r")
;        (minus:SF (match_operand:SF 1 "gr_register_operand" "r")
;                 (match_operand:SF 2 "gr_register_operand" "r")))]
;  ""
;  "%0 = sfsub(%1, %2)"
;)
;
;(define_insn "subdf3"
;  [(set (match_operand:DF 0 "gr_register_operand" "=r")
;        (minus:DF (match_operand:DF 1 "gr_register_operand" "r")
;                 (match_operand:DF 2 "gr_register_operand" "r")))]
;  ""
;  "%0 = dfsub(%1, %2)"
;)
;
;
;;; ----------
;;; umax[sd]f3
;;; ----------
;
;(define_insn "umaxsf3"
;  [(set (match_operand:SF 0 "gr_register_operand"         "=Rg")
;        (umax:SF (match_operand:SF 1 "gr_register_operand" "Rg")
;                 (match_operand:SF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = sfmaxu(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "umaxdf3"
;  [(set (match_operand:DF 0 "gr_register_operand"         "=Rg")
;        (umax:DF (match_operand:DF 1 "gr_register_operand" "Rg")
;                 (match_operand:DF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = dfmaxu(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;;; ----------
;;; umin[sd]f3
;;; ----------
;
;(define_insn "uminsf3"
;  [(set (match_operand:SF 0 "gr_register_operand"         "=Rg")
;        (umin:SF (match_operand:SF 1 "gr_register_operand" "Rg")
;                 (match_operand:SF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = sfminu(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "umindf3"
;  [(set (match_operand:DF 0 "gr_register_operand"         "=Rg")
;        (umin:DF (match_operand:DF 1 "gr_register_operand" "Rg")
;                 (match_operand:DF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = dfminu(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;;; --------
;;; mul[sd]3
;;; --------
;
;(define_insn "mulsf3"
;  [(set (match_operand:SF 0 "register_operand" "=r")
;        (mult:SF (match_operand:SF 1 "register_operand" "r")
;                 (match_operand:SF 2 "register_operand" "r")))]
;  ""
;  "%0 = sfmpy(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "muldf3"
;  [(set (match_operand:DF 0 "register_operand" "=r")
;        (mult:DF (match_operand:DF 1 "register_operand" "r")
;                 (match_operand:DF 2 "register_operand" "r")))]
;  ""
;  "%0 = dfmpy(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;;; -----------
;;; cmp[fd]
;;; -----------
;
;(define_expand "cmpsf"
;  [(match_operand:SF 0 "gr_register_operand" "")
;   (match_operand:SF 1 "gr_register_operand" "")] 
;  ""
;  {
;    cfun->machine->compare_op0 = operands[0];
;    cfun->machine->compare_op1 = operands[1];
;    DONE;
;  }
;)
;
;
;(define_expand "cmpdf"
;  [(match_operand:DF 0 "gr_register_operand" "")
;   (match_operand:DF 1 "gr_register_operand" "")] 
;  ""
;  {
;    cfun->machine->compare_op0 = operands[0];
;    cfun->machine->compare_op1 = operands[1];
;    DONE;
;  }
;)
;
;(define_insn "cmpsf_gt"
;  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
;        (gt:BI (match_operand:SF 1 "gr_register_operand" "Rg")
;               (match_operand:SF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = sfcmp.gt(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "cmpdf_gt"
;  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
;        (gt:BI (match_operand:DF 1 "gr_register_operand" "Rg")
;               (match_operand:DF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = dfcmp.gt(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "cmpsf_eq"
;  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
;        (eq:BI (match_operand:SF 1 "gr_register_operand" "Rg")
;               (match_operand:SF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = sfcmp.eq(%1,%2)"
;  [(set_attr "type" "X")]
;)
;
;(define_insn "cmpdf_eq"
;  [(set (match_operand:BI 0 "pr_register_operand"       "=Rp")
;        (eq:BI (match_operand:DF 1 "gr_register_operand" "Rg")
;               (match_operand:DF 2 "gr_register_operand" "Rg")))]
;  ""
;  "%0 = dfcmp.eq(%1,%2)"
;  [(set_attr "type" "X")]
;)

(define_insn_and_split "cond_combinesi"
  [(cond_exec
     (match_operator:BI 4 "predicate_operator"
       [(match_operand:BI 5 "pr_register_operand"   "Rp")
        (const_int 0)])
   (parallel
   [(set (match_operand:SI 0 "gr_register_operand" "=Rg")
         (match_operand:SI 1 "gr_register_operand"  "Rg"))
    (set (match_operand:SI 2 "gr_register_operand" "=Rg")
         (match_operand:SI 3 "gr_register_operand"  "Rg"))]))]
  "reload_completed"
  {
    if(REGNO (operands[0]) % 2 == 0){
      return "if (%C4) %P0 = combine(%3,%1)";
    }
    else {
      return "if (%C4) %P2 = combine(%1,%3)";
    }
  }
  "&& !(   (   REGNO (operands[0]) % 2 == 0
            && REGNO (operands[0]) + 1 == REGNO (operands[2]))
        || (   REGNO (operands[2]) % 2 == 0
            && REGNO (operands[2]) + 1 == REGNO (operands[0])))"
  [(cond_exec (match_op_dup 4 [(match_dup 5) (const_int 0)]) (set (match_dup 0) (match_dup 1)))
   (cond_exec (match_op_dup 4 [(match_dup 5) (const_int 0)]) (set (match_dup 2) (match_dup 3)))]
  {
    gcc_assert(!(   REG_P (operands[0]) && REG_P (operands[1]) 
                    && REG_P (operands[2]) && REG_P (operands[3])  
                    && REGNO (operands[0]) == REGNO (operands[3]) 
                    && REGNO (operands[1]) == REGNO (operands[2]) ));

    /* When this condition is true, it is likely that we have
       a violation of parallel semantics. This pattern was likely
       produced by a peephole, and later altered by reg rename
       making it inappropriate for paired register usage. Also,
       cprop might have propagated a register usage into the
       parallel structure, resulting in this code.
       If we do not have this king of assignment:
       parallel [ r0=r2; r2=r0]
       we can reverse the order of instructions in parallel
       structure as we split it. 
       See bug 3855 for details. */ 

    if((REG_P (operands[0]) && REG_P (operands[3])
        && REGNO (operands[0]) == REGNO (operands[3]))){

        rtx tmp; 

        tmp = operands[0];   
        operands[0] = operands[2];
        operands[2] = tmp; 

        tmp = operands[1]; 
        operands[1] = operands[3];
        operands[3] = tmp; 
    }
  }
  [(set_attr "type" "A")]
)




;;-------;;
;; Other ;;
;;-------;;



;; Pseudo instruction that prevents the scheduler from moving code above this
;; point.
;;(define_insn "blockage"
;;  [(unspec_volatile [(const_int 0)] 0)]
;;  ""
;;  ""
;;  [(set_attr "length" "0")]
;;)
